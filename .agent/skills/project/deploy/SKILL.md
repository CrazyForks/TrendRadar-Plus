---
name: deploy
description: éƒ¨ç½² hotnews åº”ç”¨åˆ°è¿œç¨‹æœåŠ¡å™¨
---

# éƒ¨ç½²åº”ç”¨

## æ¦‚è¿°
æœ¬ Skill æä¾›ä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼Œæ ¹æ®å˜æ›´ç±»å‹é€‰æ‹©ï¼š

| åœºæ™¯ | ä½¿ç”¨è„šæœ¬ | æ—¶é—´ | è¯´æ˜ |
|------|---------|------|------|
| **æ—¥å¸¸éƒ¨ç½²** | `deploy-fast.sh` | ~10 ç§’ | bug ä¿®å¤ã€å°æ”¹åŠ¨ï¼Œä»…é‡å¯å®¹å™¨ |
| **é‡å¤§æ›´æ–°** | `deploy-rebuild.sh` | 1-10 åˆ†é’Ÿ | ä¾èµ–å˜æ›´ã€Dockerfile ä¿®æ”¹ï¼Œéœ€é‡å»ºé•œåƒ |

## å‰ç½®æ¡ä»¶
- ç¡®ä¿æœ¬åœ°ä»£ç å·²æäº¤åˆ° Git
- SSH å¯†é’¥å·²é…ç½®åˆ°æœåŠ¡å™¨ï¼ˆ120.77.222.205:52222ï¼‰
- æœåŠ¡å™¨ä¸Šçš„ Docker ç¯å¢ƒæ­£å¸¸è¿è¡Œ

---

## ğŸš€ åœºæ™¯ä¸€ï¼šæ—¥å¸¸éƒ¨ç½²ï¼ˆæ¨èï¼‰

é€‚ç”¨äºï¼š
- âœ… Bug ä¿®å¤
- âœ… ä»£ç é€»è¾‘è°ƒæ•´
- âœ… å‰ç«¯æ ·å¼ä¿®æ”¹
- âœ… é…ç½®æ–‡ä»¶æ›´æ–°
- âœ… æ–‡æ¡£æ›´æ–°

**ç‰¹ç‚¹**ï¼šä¸é‡å»º Docker é•œåƒï¼Œä»…åŒæ­¥ä»£ç å¹¶é‡å¯å®¹å™¨ï¼Œé€Ÿåº¦å¿«ã€‚

// turbo-all

### æ­¥éª¤

#### 1. æ£€æŸ¥æœ¬åœ°çŠ¶æ€
```bash
cd /Users/sun/Downloads/hotnews && git status
```

#### 2. å¿«é€Ÿéƒ¨ç½²
```bash
./deploy-fast.sh
```

**æ‰§è¡Œæµç¨‹**ï¼š
1. è‡ªåŠ¨æäº¤å¹¶æ¨é€ä»£ç 
2. SSH åˆ°æœåŠ¡å™¨åŒæ­¥ä»£ç 
3. æ›´æ–°å­æ¨¡å—
4. é‡å¯å®¹å™¨ï¼ˆä¸é‡å»ºï¼‰
5. å¥åº·æ£€æŸ¥

#### 3. éªŒè¯
è®¿é—® http://120.77.222.205 ç¡®è®¤åŠŸèƒ½æ­£å¸¸

---

## ğŸ”„ åœºæ™¯äºŒï¼šå®Œæ•´é‡å»ºï¼ˆé‡å¤§æ›´æ–°ï¼‰

é€‚ç”¨äºä»¥ä¸‹æƒ…å†µï¼Œ**å¿…é¡»ç”¨æˆ·ç¡®è®¤åæ‰èƒ½æ‰§è¡Œ**ï¼š

### ğŸ”´ ä¼šå¯¼è‡´é‡æ–°ä¸‹è½½ä¾èµ–çš„å˜æ›´ï¼ˆ1-10 åˆ†é’Ÿï¼‰

- âš ï¸ **ä¿®æ”¹ `requirements.txt`** æˆ– `docker/requirements.viewer.txt`
  - æ·»åŠ ã€åˆ é™¤æˆ–æ›´æ–°ä»»ä½• Python ä¾èµ–åŒ…
  - ä¼šè§¦å‘å®Œæ•´çš„ pip å®‰è£…è¿‡ç¨‹ï¼Œä¸‹è½½ 50-100 MB
  
- âš ï¸ **ä¿®æ”¹ Dockerfile ä¸­ä¾èµ–å®‰è£…ä¹‹å‰æˆ–ä¹‹ä¸­çš„ RUN æŒ‡ä»¤**
  - ä¾‹å¦‚ï¼šä¿®æ”¹ `pip install` å‘½ä»¤
  - ä¾‹å¦‚ï¼šè°ƒæ•´ PyPI é•œåƒæº
  - ä¾‹å¦‚ï¼šå®‰è£…ç³»ç»ŸåŒ…ï¼ˆapt-getï¼‰
  - ä¼šç ´å Docker å±‚ç¼“å­˜ï¼Œé‡æ–°ä¸‹è½½æ‰€æœ‰ä¾èµ–

### ğŸŸ¡ ä¸ä¼šé‡æ–°ä¸‹è½½ä¾èµ–çš„å˜æ›´ï¼ˆ1-3 åˆ†é’Ÿï¼‰

- âš ï¸ **ä»…ä¿®æ”¹ Dockerfile ä¸­ä¾èµ–å®‰è£…ä¹‹åçš„éƒ¨åˆ†**
  - ä¾‹å¦‚ï¼šä¿®æ”¹ `COPY hotnews/` ä¹‹åçš„æŒ‡ä»¤
  - ä¾‹å¦‚ï¼šä¿®æ”¹ `ENV` ç¯å¢ƒå˜é‡
  - ä¾‹å¦‚ï¼šä¿®æ”¹ `CMD` æˆ– `ENTRYPOINT`
  - ä¼šå¤ç”¨ä¾èµ–å±‚ç¼“å­˜ï¼Œä»…é‡å»ºä»£ç å±‚

### ğŸŸ  å…¶ä»–éœ€è¦é‡å»ºçš„åœºæ™¯

- âš ï¸ æ›´æ–° Docker åŸºç¡€é•œåƒç‰ˆæœ¬ï¼ˆ`FROM python:3.11-slim`ï¼‰
- âš ï¸ é¦–æ¬¡éƒ¨ç½²åˆ°æ–°æœåŠ¡å™¨
- âš ï¸ éœ€è¦æ¸…é™¤æ‰€æœ‰ Docker ç¼“å­˜å±‚ï¼ˆ`--no-cache`ï¼‰

**ç‰¹ç‚¹**ï¼šé‡æ–°æ„å»º Docker é•œåƒï¼Œå¯èƒ½ä¸‹è½½ä¾èµ–ï¼Œè€—æ—¶è¾ƒé•¿ã€‚

### é‡å»ºæ—¶ä¼šä¸‹è½½çš„å†…å®¹

#### 1. Docker åŸºç¡€é•œåƒ
- **é•œåƒ**: `python:3.10-slim`
- **æ•°é‡**: 3 ä¸ªæœåŠ¡å…±äº«åŒä¸€åŸºç¡€é•œåƒ
- **å¤§å°**: çº¦ 200-300 MB
- **æ¥æº**: Docker Hub å®˜æ–¹æºï¼ˆå¯èƒ½è¾ƒæ…¢ï¼‰

#### 2. Python ä¾èµ–åŒ…
- **æ¥æº**: æ¸…åå¤§å­¦ PyPI é•œåƒæºï¼ˆå›½å†…åŠ é€Ÿï¼‰
- **ä¸»è¦åŒ…**:
  - `fastapi` + `uvicorn` (Web æ¡†æ¶ï¼Œçº¦ 10MB)
  - `requests` (HTTP å®¢æˆ·ç«¯ï¼Œçº¦ 5MB)
  - `fastmcp` + `websockets` (MCP æœåŠ¡ï¼Œçº¦ 5MB)
  - `boto3` (AWS SDKï¼Œçº¦ 30MB)
  - `beautifulsoup4`, `Jinja2`, `PyYAML` ç­‰ (çº¦ 10MB)
- **æ€»å¤§å°**: çº¦ 50-100 MB

#### 3. Git ä»£ç åŒæ­¥
- **ä¸»ä»“åº“**: `hotnews` (çº¦ 5MB)
- **å­æ¨¡å—**: `hotnews/kernel` (çº¦ 2MB)

### â±ï¸ é¢„è®¡æ—¶é—´

| åœºæ™¯ | é¢„è®¡æ—¶é—´ | è¯´æ˜ |
|------|---------|------|
| **é¦–æ¬¡å®Œæ•´æ„å»º** | 5-10 åˆ†é’Ÿ | éœ€è¦ä¸‹è½½æ‰€æœ‰åŸºç¡€é•œåƒå’Œä¾èµ– |
| **å¢é‡æ„å»º** | 1-3 åˆ†é’Ÿ | ä»…é‡æ–°æ„å»ºä»£ç å±‚ï¼Œå¤ç”¨ç¼“å­˜ |
| **ä»…ä»£ç æ›´æ–°** | 30-60 ç§’ | æ—  Dockerfile å˜æ›´æ—¶ |

### ğŸŒ ç½‘ç»œä¼˜åŒ–é…ç½®

é¡¹ç›®å·²é…ç½®ä»¥ä¸‹åŠ é€Ÿæªæ–½ï¼š

âœ… **Debian åŒ…ç®¡ç†**: é˜¿é‡Œäº‘é•œåƒæº  
âœ… **PyPI åŒ…ç®¡ç†**: æ¸…åå¤§å­¦é•œåƒæº  
âœ… **pip é‡è¯•æœºåˆ¶**: `--retries 3 --timeout 60`  
âš ï¸ **Docker é•œåƒ**: å®˜æ–¹æºï¼ˆæ…¢ï¼‰ï¼Œå»ºè®®æœåŠ¡å™¨é…ç½® Docker Hub é•œåƒ

### âš ï¸ æ‰§è¡Œå‰ç¡®è®¤

> [!WARNING]
> **å®Œæ•´é‡å»ºå‰ï¼Œè¯·ç¡®è®¤ä»¥ä¸‹é—®é¢˜**ï¼š
> 1. **æ˜¯å¦ä¿®æ”¹äº† `requirements.txt` æˆ– Dockerfile çš„ RUN æŒ‡ä»¤ï¼Ÿ**ï¼ˆä¼šé‡æ–°ä¸‹è½½ä¾èµ–ï¼‰
> 2. æ˜¯å¦äº†è§£å¯èƒ½éœ€è¦ä¸‹è½½æ–°çš„ä¾èµ–ï¼ˆé¢„è®¡ 50-300 MBï¼‰ï¼Ÿ
> 3. å½“å‰ç½‘ç»œç¯å¢ƒæ˜¯å¦ç¨³å®šï¼ˆé¢„è®¡ 1-10 åˆ†é’Ÿï¼‰ï¼Ÿ
> 4. æ˜¯å¦å¯ä»¥æ¥å—çŸ­æš‚æœåŠ¡ä¸­æ–­ï¼ˆçº¦ 10-30 ç§’ï¼‰ï¼Ÿ

### æ­¥éª¤

#### 1. æ£€æŸ¥å˜æ›´ç±»å‹
```bash
cd /Users/sun/Downloads/hotnews
git diff --name-only
```

ç¡®è®¤æ˜¯å¦åŒ…å«ï¼š
- `requirements.txt`
- `docker/Dockerfile*`
- `pyproject.toml`

#### 2. æäº¤ä»£ç 
```bash
git add -A
git commit -m "feat: æè¿°é‡å¤§å˜æ›´"
git push
```

#### 3. æ‰§è¡Œå®Œæ•´é‡å»º
```bash
./deploy-rebuild.sh
```

**è„šæœ¬æ‰§è¡Œæµç¨‹**:
1. Git æäº¤å¹¶æ¨é€ï¼ˆå¦‚æœ‰å˜æ›´ï¼‰
2. SSH åˆ°æœåŠ¡å™¨
3. å¼ºåˆ¶åŒæ­¥ä»£ç  (`git reset --hard`)
4. æ›´æ–°å­æ¨¡å—
5. æ„å»º 3 ä¸ª Docker æœåŠ¡ï¼ˆhotnews, hotnews-viewer, hotnews-mcpï¼‰
6. é‡å»ºå®¹å™¨ï¼ˆ`--force-recreate`ï¼‰
7. æ‰§è¡Œæ•°æ®åº“è¿ç§»
8. å¥åº·æ£€æŸ¥

### 4. éªŒè¯éƒ¨ç½²

è„šæœ¬ä¼šè‡ªåŠ¨æ£€æŸ¥ï¼š
- âœ… HTTP å¥åº·ç«¯ç‚¹ (http://127.0.0.1:8090/health)
- âœ… å®¹å™¨è¿è¡ŒçŠ¶æ€
- âœ… å®¹å™¨æ—¥å¿—è¾“å‡º

**æ‰‹åŠ¨éªŒè¯**:
- è®¿é—®å‰ç«¯: http://120.77.222.205
- æ£€æŸ¥ Admin åå°åŠŸèƒ½
- ç¡®è®¤æ–°åŠŸèƒ½æˆ–ä¿®å¤ç”Ÿæ•ˆ

---

## å¸¸è§é—®é¢˜

### Docker æ„å»ºè¶…æ—¶
**åŸå› **: Docker Hub å®˜æ–¹æºåœ¨å›½å†…é€Ÿåº¦æ…¢  
**è§£å†³**:
```bash
# åœ¨æœåŠ¡å™¨ä¸Šé…ç½® Docker Hub é•œåƒ
sudo vim /etc/docker/daemon.json
```
æ·»åŠ :
```json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://mirror.ccs.tencentyun.com"
  ]
}
```
é‡å¯ Docker: `sudo systemctl restart docker`

### å­æ¨¡å—åŒæ­¥å¤±è´¥
**åŸå› **: å­æ¨¡å— SSH å¯†é’¥æœªé…ç½®  
**è§£å†³**:
```bash
# æœåŠ¡å™¨ä¸Šé…ç½® GitHub SSH å¯†é’¥
ssh-keygen -t ed25519 -C "server@hotnews"
cat ~/.ssh/id_ed25519.pub  # æ·»åŠ åˆ° GitHub
```

### å¥åº·æ£€æŸ¥å¤±è´¥
**æ’æŸ¥æ­¥éª¤**:
1. æŸ¥çœ‹å®¹å™¨æ—¥å¿—: `docker logs hotnews-viewer`
2. æ£€æŸ¥ç«¯å£å ç”¨: `netstat -tunlp | grep 8090`
3. è¿›å…¥å®¹å™¨è°ƒè¯•: `docker exec -it hotnews-viewer bash`

### pip å®‰è£…ä¾èµ–æ…¢
**å½“å‰é…ç½®**: å·²ä½¿ç”¨æ¸…åæºï¼Œé€šå¸¸ 1-2 åˆ†é’Ÿå®Œæˆ  
**è¿›ä¸€æ­¥ä¼˜åŒ–**: 
- è€ƒè™‘ä½¿ç”¨ `uv` ä»£æ›¿ `pip`ï¼ˆå¿« 10-100 å€ï¼‰
- æˆ–ä½¿ç”¨æœ¬åœ° PyPI é•œåƒæœåŠ¡å™¨

---

## å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# æŸ¥çœ‹æœåŠ¡å™¨å®¹å™¨çŠ¶æ€
ssh -p 52222 root@120.77.222.205 "docker ps | grep hotnews"

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
ssh -p 52222 root@120.77.222.205 "docker logs --tail 50 hotnews-viewer"

# æ‰‹åŠ¨é‡å¯æœåŠ¡
ssh -p 52222 root@120.77.222.205 "cd ~/hotnews/docker && docker compose restart"
```

## å‚è€ƒä¿¡æ¯

- [éƒ¨ç½²å†³ç­–æŒ‡å—](resources/deployment_decision_tree.md) - è¯¦ç»†çš„éƒ¨ç½²æ–¹å¼é€‰æ‹©æµç¨‹å›¾ä¸è§„åˆ™è¯´æ˜