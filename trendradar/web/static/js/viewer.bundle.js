(()=>{var s=window.TrendRadar=window.TrendRadar||{},le=[],ce=!1;function p(e){ce?e():le.push(e)}document.addEventListener("DOMContentLoaded",function(){ce=!0,le.forEach(e=>{try{e()}catch(t){console.error("Ready handler error:",t)}})});function y(e){return String(e||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function q(e){let t=e==null?"":String(e).trim();if(!t)return t;let r=t.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})(?::\d{2})?$/);return r?`${r[2]}-${r[3]} ${r[4]}:${r[5]}`:(t.match(/^(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/),t)}s.ready=p;s.escapeHtml=y;s.formatUpdatedAt=q;var d={get(e,t=null){try{let r=localStorage.getItem(e);return r===null?t:JSON.parse(r)}catch{return t}},set(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.error("Storage set error:",r)}},remove(e){try{localStorage.removeItem(e)}catch{}},getRaw(e){return localStorage.getItem(e)},setRaw(e,t){localStorage.setItem(e,t)}};s.storage=d;var qe={updatePlatformCount(e){if(!e)return;let t=e.querySelectorAll(".news-item:not(.read):not(.filtered):not(.search-hidden):not(.paged-hidden)"),r=e.querySelector(".platform-visible-count");r&&(r.textContent=t.length)},updateAllCounts(){document.querySelectorAll(".platform-card").forEach(r=>{this.updatePlatformCount(r)});let e=document.querySelectorAll(".news-item:not(.read):not(.filtered):not(.search-hidden):not(.paged-hidden)").length,t=document.getElementById("totalNews");t&&(t.textContent=e)}};s.counts=qe;var T={openLink(e){let t=e.dataset.url;t&&window.open(t,"_blank")},isHoverDevice(){return window.matchMedia&&window.matchMedia("(hover: hover)").matches},closeAllPreviews(e){document.querySelectorAll(".news-item.preview").forEach(t=>{e&&t===e||t.classList.remove("preview")})},handleTitleClickV2(e,t){t.stopPropagation();let r=e.closest(".news-item");if(!r)return;if(this.isHoverDevice()){this.openLink(e);return}if(r.classList.contains("preview")){this.openLink(e),r.classList.remove("preview");return}this.closeAllPreviews(r),r.classList.add("preview")},handleTitleKeydownV2(e,t){t.key==="Enter"||t.key===" "?(t.preventDefault(),this.handleTitleClickV2(e,t)):t.key==="Escape"&&this.closeAllPreviews(null)}};window.handleTitleClickV2=(e,t)=>T.handleTitleClickV2(e,t);window.handleTitleKeydownV2=(e,t)=>T.handleTitleKeydownV2(e,t);window.openLink=e=>T.openLink(e);document.addEventListener("click",e=>{e.target.closest(".news-item")||T.closeAllPreviews(null)});document.addEventListener("touchstart",e=>{e.target.closest(".news-item")||T.closeAllPreviews(null)},{passive:!0});document.addEventListener("keydown",e=>{e.key==="Escape"&&T.closeAllPreviews(null)});s.link=T;var de={searchNews(){let t=(document.getElementById("searchInput")?.value||"").toLowerCase();document.querySelectorAll(".news-item").forEach(r=>{let o=r.textContent.toLowerCase();!t||o.includes(t)?r.classList.remove("search-hidden"):r.classList.add("search-hidden")}),s.counts.updateAllCounts()}};window.searchNews=()=>de.searchNews();s.search=de;var ge="trendradar_platform_grid_scroll_v1",Ie={getPlatformGridScrollState(){return d.get(ge,{})},setPlatformGridScrollState(e){d.set(ge,e||{})},recordPlatformGridScrollForTab(e,t){if(!e||!t)return;let r=t.scrollLeft||0,o=null,a=0,n=null,l=t.querySelectorAll(".platform-card");for(let i of l)if((i.offsetLeft||0)<=r+1)n=i;else break;n?.dataset?.platform&&(o=n.dataset.platform,a=Math.max(0,r-(n.offsetLeft||0)));let c=this.getPlatformGridScrollState();c[e]={left:r,anchorPlatformId:o,anchorOffsetX:a,updatedAt:Date.now()},this.setPlatformGridScrollState(c)},attachPlatformGridScrollPersistence(){document.querySelectorAll(".tab-pane .platform-grid").forEach(e=>{if(e.dataset.scrollPersistBound==="1")return;e.dataset.scrollPersistBound="1";let t=!1;e.addEventListener("scroll",()=>{t||(t=!0,requestAnimationFrame(()=>{t=!1;let r=e.closest(".tab-pane"),o=r?.id?.startsWith("tab-")?r.id.slice(4):null;this.recordPlatformGridScrollForTab(o,e)}))},{passive:!0})})},restoreActiveTabPlatformGridScroll(e){let t=e?.activeTab;if(!e?.preserveScroll||!t)return;let r=this.getPlatformGridScrollState()?.[t],o=Number.isFinite(r?.left)?r.left:Number.isFinite(e.activeTabPlatformGridScrollLeft)?e.activeTabPlatformGridScrollLeft:0,a=typeof r?.anchorPlatformId=="string"&&r.anchorPlatformId?r.anchorPlatformId:e.activeTabPlatformAnchorPlatformId,n=Number.isFinite(r?.anchorOffsetX)?r.anchorOffsetX:Number.isFinite(e.activeTabPlatformAnchorOffsetX)?e.activeTabPlatformAnchorOffsetX:0,l=()=>{let c=document.querySelector(`#tab-${t} .platform-grid`);if(c){if(a){let i=null;if(c.querySelectorAll(".platform-card").forEach(g=>{!i&&g.dataset.platform===a&&(i=g)}),i&&i.offsetParent!==null){c.scrollLeft=(i.offsetLeft||0)+n;return}}c.scrollLeft=o}};requestAnimationFrame(()=>{requestAnimationFrame(()=>{l(),setTimeout(l,50),setTimeout(l,200),setTimeout(l,600)})})}};s.scroll=Ie;var fe="trendradar_feature_badge_v1:",me="trendradar_new_badges_dismissed_v1",W={getFeatureBadgeState(e){return d.get(fe+e,null)},setFeatureBadgeState(e,t){d.set(fe+e,t)},ensureFeatureFirstSeen(e){let t=this.getFeatureBadgeState(e);if(t&&typeof t.firstSeenAt=="number")return t;let r={firstSeenAt:Date.now(),seenAt:null};return this.setFeatureBadgeState(e,r),r},markFeatureSeen(e){let t=this.ensureFeatureFirstSeen(e);t.seenAt||(t.seenAt=Date.now(),this.setFeatureBadgeState(e,t))},shouldShowFeatureBadge(e,t){let r=this.ensureFeatureFirstSeen(e);if(r.seenAt)return!1;let o=(t||7)*24*60*60*1e3;return Date.now()-(r.firstSeenAt||0)<=o},updateNewBadges(){let e=document.getElementById("newBadgeSportsTab");e&&(e.style.display=this.shouldShowFeatureBadge("sports-nba-schedule",7)?"":"none")},getDismissedNewBadges(){let e=d.get(me,{});return{categories:e?.categories||{},platforms:e?.platforms||{}}},setDismissedNewBadges(e){d.set(me,e||{categories:{},platforms:{}})},applyDismissedNewBadges(){let e=this.getDismissedNewBadges();document.querySelectorAll(".new-badge-category").forEach(t=>{let r=t?.dataset?.category;r&&e.categories?.[r]&&(t.style.display="none")}),document.querySelectorAll(".new-badge-platform").forEach(t=>{let r=t?.dataset?.platform;r&&e.platforms?.[r]&&(t.style.display="none")})},dismissNewCategoryBadge(e){if(!e)return;let t=this.getDismissedNewBadges();t.categories?.[e]||(t.categories[e]=!0,this.setDismissedNewBadges(t)),document.querySelectorAll(`.new-badge-category[data-category="${CSS.escape(e)}"]`).forEach(r=>{r.style.display="none"})},dismissNewPlatformBadge(e){if(!e)return;let t=this.getDismissedNewBadges();t.platforms?.[e]||(t.platforms[e]=!0,this.setDismissedNewBadges(t)),document.querySelectorAll(`.new-badge-platform[data-platform="${CSS.escape(e)}"]`).forEach(r=>{r.style.display="none"})}};window.dismissNewPlatformBadge=e=>W.dismissNewPlatformBadge(e);s.badges=W;p(function(){W.applyDismissedNewBadges()});var F=20,J={PAGE_SIZE:F,applyPagingToCard(e,t){let r=Array.from(e.querySelectorAll(".news-item")),o=r.length;if(o<=F){r.forEach(l=>l.classList.remove("paged-hidden")),e.dataset.pageOffset="0";return}let a=Math.max(0,Math.min(t,o-1)),n=Math.min(a+F,o);r.forEach((l,c)=>{c>=a&&c<n?l.classList.remove("paged-hidden"):l.classList.add("paged-hidden")}),e.dataset.pageOffset=String(a)},initPaging(){document.querySelectorAll(".platform-card").forEach(e=>{this.applyPagingToCard(e,0)}),s.counts.updateAllCounts()},refreshPlatform(e){let t=e.closest(".platform-card");if(!t)return;let o=t.querySelectorAll(".news-item").length;if(o<=F)return;let a=parseInt(t.dataset.pageOffset||"0",10),n=a+F>=o?0:a+F;this.applyPagingToCard(t,n),s.counts.updateAllCounts()}};window.refreshPlatform=e=>J.refreshPlatform(e);s.paging=J;p(function(){J.initPaging()});var ue="trendradar_online_session_id",I={getSessionId(){let e=d.getRaw(ue);return e||(window.crypto&&crypto.randomUUID?e=crypto.randomUUID():e="sess_"+Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,10),d.setRaw(ue,e),e)},async ping(){try{await fetch("/api/online/ping",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:this.getSessionId()})})}catch{}},async refreshStats(){try{let t=await(await fetch("/api/online")).json(),r=document.getElementById("online5m");r&&(r.textContent=t.online_5m??"-")}catch{}}};s.online=I;p(function(){I.ping(),I.refreshStats(),setInterval(()=>I.ping(),15e3),setInterval(()=>I.refreshStats(),1e4)});var ye="trendradar_read_news_v2",pe="trendradar_read_news",he="trendradar_show_read_mode",Me=24,b={getReadNews(){return d.get(ye,{})},saveReadNews(e){d.set(ye,e)},getShowReadModePref(){let e=d.getRaw(he);return e===null?!0:e==="1"},applyShowReadMode(e){e?document.body.classList.add("show-read-mode"):document.body.classList.remove("show-read-mode");let t=document.getElementById("showReadBtn");t&&(e?t.classList.add("active"):t.classList.remove("active"))},migrateOldFormat(){d.getRaw(pe)&&(d.remove(pe),console.log("\u5DF2\u6E05\u9664\u65E7\u7248\u672C\u5DF2\u8BFB\u8BB0\u5F55"))},cleanupExpiredReads(){let e=Date.now(),t=this.getReadNews(),r=!1,o=0;for(let[a,n]of Object.entries(t))if((e-n.readAt)/36e5>=Me){let c=document.querySelector(`[data-news-id="${a}"]`);if(c){c.classList.remove("read");let i=c.querySelector(".news-checkbox");i&&(i.checked=!1)}delete t[a],r=!0,o++}return r&&this.saveReadNews(t),o},markAsRead(e){let t=e.closest(".news-item"),r=t.dataset.newsId,o=t.dataset.newsTitle||"",a=this.getReadNews();e.checked?(t.classList.add("read"),a[r]||(a[r]={title:o.substring(0,50),readAt:Date.now()},this.saveReadNews(a))):(t.classList.remove("read"),delete a[r],this.saveReadNews(a)),s.counts.updatePlatformCount(e.closest(".platform-card")),this.updateReadCount()},updateReadCount(){let e=this.getReadNews(),t=document.getElementById("readCount");t&&(t.textContent=Object.keys(e).length)},restoreReadState(){let e=this.getReadNews();Object.keys(e).forEach(t=>{let r=document.querySelector(`[data-news-id="${t}"]`);if(r){r.classList.add("read");let o=r.querySelector(".news-checkbox");o&&(o.checked=!0)}}),s.counts.updateAllCounts(),this.updateReadCount()},toggleShowRead(){let e=!document.body.classList.contains("show-read-mode");this.applyShowReadMode(e),d.setRaw(he,e?"1":"0"),s.counts.updateAllCounts()},clearAllRead(){confirm("\u786E\u5B9A\u8981\u6E05\u9664\u6240\u6709\u5DF2\u8BFB\u8BB0\u5F55\u5417\uFF1F\u6240\u6709\u65B0\u95FB\u5C06\u6062\u590D\u663E\u793A\u3002")&&(document.querySelectorAll(".news-item.read").forEach(e=>{e.classList.remove("read");let t=e.querySelector(".news-checkbox");t&&(t.checked=!1)}),this.saveReadNews({}),s.counts.updateAllCounts(),this.updateReadCount())}};window.markAsRead=e=>b.markAsRead(e);window.toggleShowRead=()=>b.toggleShowRead();window.clearAllRead=()=>b.clearAllRead();s.readState=b;p(function(){b.applyShowReadMode(b.getShowReadModePref()),b.migrateOldFormat();let e=b.cleanupExpiredReads();e>0&&console.log(`\u5DF2\u6E05\u7406 ${e} \u6761\u8FC7\u671F\u5DF2\u8BFB\u8BB0\u5F55`),b.restoreReadState(),b.updateReadCount()});var j="trendradar_categories_config",Q=1,u=null,S=null,P=null,K=!1,k=!1,L=!0,Ge=null,M="",O=!1;function Z(e){(!e.categoryFilters||typeof e.categoryFilters!="object")&&(e.categoryFilters={})}function we(e){let t=e&&typeof e=="object"?e:{};return Array.isArray(t.customCategories)||(t.customCategories=[]),Array.isArray(t.hiddenDefaultCategories)||(t.hiddenDefaultCategories=[]),Array.isArray(t.categoryOrder)||(t.categoryOrder=[]),(!t.platformOrder||typeof t.platformOrder!="object")&&(t.platformOrder={}),Z(t),t}var h={CATEGORY_CONFIG_KEY:j,ensureCategoryFilters:Z,normalizeCategoryConfig:we,getCategoryConfig(){try{let e=d.getRaw(j);if(!e)return null;let t=JSON.parse(e);return t.version!==Q?null:we(t)}catch{return null}},saveCategoryConfig(e){e.version=Q,d.setRaw(j,JSON.stringify(e)),this.syncConfigToCookie(e)},syncConfigToCookie(e){try{e.customCategories?.length>0||e.hiddenDefaultCategories?.length>0||e.categoryOrder?.length>0?document.cookie="trendradar_has_config=1; path=/; max-age=31536000; SameSite=Lax":document.cookie="trendradar_has_config=; path=/; max-age=0"}catch(t){console.error("Failed to sync config to cookie:",t)}},getDefaultCategoryConfig(){return u||(u={},S={},document.querySelectorAll(".category-tab").forEach(e=>{let t=e.dataset.category,r=e.querySelector(".category-tab-icon")?.textContent?.trim()||"\u{1F4C1}",o=e.querySelector(".category-tab-name")?.textContent?.replace(/NEW$/,"")?.trim()||t;u[t]={id:t,name:o,icon:r,isDefault:!0}}),document.querySelectorAll(".platform-card").forEach(e=>{let t=e.dataset.platform,r=e.querySelector(".platform-name")?.textContent?.trim()?.replace(/ðŸ“±\s*/,"")?.split(" ")[0]||t,a=e.closest(".tab-pane")?.id?.replace("tab-","")||"other";S[t]={id:t,name:r,defaultCategory:a},u[a]&&(u[a].platforms||(u[a].platforms=[]),u[a].platforms.push(t))})),{version:Q,customCategories:[],hiddenDefaultCategories:[],categoryOrder:Object.keys(u),platformOrder:{},categoryFilters:{}}},getMergedCategoryConfig(){let e=this.getDefaultCategoryConfig(),t=this.getCategoryConfig();if(!t)return e;let r={...e,customCategories:t.customCategories||[],hiddenDefaultCategories:t.hiddenDefaultCategories||[],categoryOrder:t.categoryOrder||e.categoryOrder,platformOrder:t.platformOrder||{},categoryFilters:t.categoryFilters||{}};return Object.keys(u).forEach(o=>{r.categoryOrder.includes(o)||r.categoryOrder.push(o)}),r.customCategories.forEach(o=>{r.categoryOrder.includes(o.id)||r.categoryOrder.push(o.id)}),r},getDefaultCategories(){return u},getAllPlatforms(){return S},setDefaultCategories(e){u=e},setAllPlatforms(e){S=e},async openCategorySettings(){if(!u||Object.keys(u).length===0)try{let r=await(await fetch("/api/news")).json();r?.categories&&(u={},S={},Object.entries(r.categories).forEach(([o,a])=>{u[o]={id:o,name:a.name,icon:a.icon,isDefault:!0,platforms:Object.keys(a.platforms||{})},Object.entries(a.platforms||{}).forEach(([n,l])=>{S[n]={id:n,name:l.name,defaultCategory:o,data:l}})}))}catch(t){console.error("Failed to fetch categories:",t)}document.getElementById("categorySettingsModal").classList.add("show"),L=!0,Ge=null,this.applyCategoryListCollapseState(),this.renderCategoryList(),this.hideEditPanel()},applyCategoryListCollapseState(){let e=document.getElementById("categoryListWrapper");e&&(L?e.classList.add("collapsed"):e.classList.remove("collapsed"));let t=document.getElementById("categoryListToggleBtn");t&&(t.textContent=L?"\u5C55\u5F00\u680F\u76EE\u5217\u8868":"\u6536\u8D77\u680F\u76EE\u5217\u8868")},toggleCategoryListCollapseInSettings(){L=!L,this.applyCategoryListCollapseState()},closeCategorySettings(){document.getElementById("categorySettingsModal").classList.remove("show"),O&&(O=!1,this.applyCategoryConfig())},saveCategorySettings(){let e=document.getElementById("categoryEditPanel");e&&e.classList.contains("show")&&!this.saveCategory()||this.closeCategorySettings()},cancelCategorySettings(){O=!1,document.getElementById("categorySettingsModal").classList.remove("show")},renderCategoryList(){let e=document.getElementById("categoryList"),t=this.getMergedCategoryConfig(),r="";t.categoryOrder.forEach(a=>{let n=t.customCategories.find(g=>g.id===a),l=t.hiddenDefaultCategories.includes(a),c;if(n)c=n;else if(u[a])c=u[a];else return;let i=n?c.platforms?.length||0:u[a]?.platforms?.length||0;r+=`
                <div class="category-item ${n?"custom":""}" data-category-id="${a}" draggable="true">
                    <span class="category-item-drag">\u2630</span>
                    <span class="category-item-name">${c.name}</span>
                    <span class="category-item-platforms">${i} \u4E2A\u5E73\u53F0</span>
                    <label class="category-item-toggle">
                        <input type="checkbox" ${l?"":"checked"} onchange="toggleCategoryVisibility('${a}')">
                        <span class="slider"></span>
                    </label>
                    <div class="category-item-actions">
                        <button class="category-item-btn" onclick="editCategory('${a}')">\u7F16\u8F91</button>
                        ${n?`<button class="category-item-btn delete" onclick="deleteCategory('${a}')">\u5220\u9664</button>`:""}
                    </div>
                </div>
            `}),e.innerHTML=r;let o=document.getElementById("allCategoriesOffToggle");if(o){let a=t.hiddenDefaultCategories||[],n=t.categoryOrder||[];o.checked=n.length>0&&n.every(l=>a.includes(l))}k?e.classList.add("hide-default"):e.classList.remove("hide-default"),this.setupCategoryDragAndDrop()},toggleDefaultCategoryListInSettings(){k=!k,this.renderCategoryList()},toggleAllCategoriesOffInSettings(e){},setupCategoryDragAndDrop(){let e=document.getElementById("categoryList");e.querySelectorAll(".category-item").forEach(r=>{r.addEventListener("dragstart",o=>{r.classList.add("dragging"),o.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging"),this.saveCategoryOrder()}),r.addEventListener("dragover",o=>{o.preventDefault();let a=e.querySelector(".dragging");if(a&&a!==r){let n=r.getBoundingClientRect(),l=n.top+n.height/2;o.clientY<l?e.insertBefore(a,r):e.insertBefore(a,r.nextSibling)}})})},saveCategoryOrder(){let t=document.getElementById("categoryList").querySelectorAll(".category-item"),r=Array.from(t).map(a=>a.dataset.categoryId),o=this.getCategoryConfig()||this.getDefaultCategoryConfig();o.categoryOrder=r,this.saveCategoryConfig(o),O=!0},toggleCategoryVisibility(e){let t=this.getCategoryConfig()||this.getDefaultCategoryConfig(),r=t.hiddenDefaultCategories.indexOf(e);r>=0?t.hiddenDefaultCategories.splice(r,1):t.hiddenDefaultCategories.push(e),this.saveCategoryConfig(t),O=!0,this.renderCategoryList()},showAddCategoryPanel(){K=!0,P=null,L=!0,this.applyCategoryListCollapseState(),k=!0,document.getElementById("editCategoryName").value="";let e=document.getElementById("platformSearchInput");e&&(e.value=""),M="",this.renderPlatformSelectList([]),s.filter.setCategoryFilterEditorState("exclude",[]),document.getElementById("categoryEditPanel").classList.add("show")},editCategory(e){K=!1,P=e;let t=this.getMergedCategoryConfig(),r=t.customCategories.find(c=>c.id===e),o,a;r?(o=r,a=o.platforms||[]):(o=u[e],a=t.platformOrder[e]||o.platforms||[]),document.getElementById("editCategoryName").value=o.name,this.renderPlatformSelectList(a,r);let n=s.filter.getCategoryFilterConfig(e);s.filter.setCategoryFilterEditorState(n.mode,n.keywords),k=!0,L=!0,this.applyCategoryListCollapseState();let l=document.getElementById("platformSearchInput");l&&(l.value=""),M="",document.getElementById("categoryEditPanel").classList.add("show")},hideEditPanel(){document.getElementById("categoryEditPanel").classList.remove("show"),P=null,K=!1,k=!1,this.renderCategoryList();let e=document.getElementById("platformSearchInput");e&&(e.value=""),M=""},cancelEditCategory(){this.hideEditPanel()},renderPlatformSelectList(e,t=!1){let r=document.getElementById("platformSelectList"),o=Object.keys(S),a=[];e.forEach(i=>{S[i]&&a.push(i)}),o.forEach(i=>{a.includes(i)||a.push(i)});let n=(M||"").trim().toLowerCase(),l=n?a.filter(i=>(S[i]?.name||"").toLowerCase().includes(n)):a,c=n.length>0;r.innerHTML=l.map(i=>{let g=S[i],f=e.includes(i);return`
                <label class="platform-select-item ${f?"selected":""} ${c?"no-drag":""}" data-platform-id="${i}" draggable="${c?"false":"true"}">
                    <span class="drag-handle">\u2630</span>
                    <input type="checkbox" ${f?"checked":""} onchange="togglePlatformSelect('${i}')">
                    <span>${g.name}</span>
                </label>
            `}).join(""),c||this.setupPlatformDragAndDrop()},setPlatformSearchQuery(e){M=String(e||"");let t=this.getSelectedPlatforms();this.renderPlatformSelectList(t)},bulkSelectPlatforms(e){let t=document.getElementById("platformSelectList");if(!t)return;t.querySelectorAll(".platform-select-item").forEach(o=>{let a=o.querySelector('input[type="checkbox"]');e==="all"?(o.classList.add("selected"),a&&(a.checked=!0)):(e==="none"||e==="clear")&&(o.classList.remove("selected"),a&&(a.checked=!1))})},setupPlatformDragAndDrop(){let e=document.getElementById("platformSelectList");e.querySelectorAll(".platform-select-item").forEach(r=>{r.addEventListener("dragstart",o=>{r.classList.add("dragging"),o.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging")}),r.addEventListener("dragover",o=>{o.preventDefault();let a=e.querySelector(".dragging");if(a&&a!==r){let n=r.getBoundingClientRect(),l=n.top+n.height/2;o.clientY<l?e.insertBefore(a,r):e.insertBefore(a,r.nextSibling)}})})},togglePlatformSelect(e){let t=document.querySelector(`.platform-select-item[data-platform-id="${e}"]`);t&&t.classList.toggle("selected")},getSelectedPlatforms(){let e=document.querySelectorAll(".platform-select-item"),t=[];return e.forEach(r=>{r.classList.contains("selected")&&t.push(r.dataset.platformId)}),t},saveCategory(){let e=document.getElementById("editCategoryName").value.trim(),t="\u{1F4F1}",r=this.getSelectedPlatforms();if(!e)return alert("\u8BF7\u8F93\u5165\u680F\u76EE\u540D\u79F0"),!1;if(r.length===0)return alert("\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5E73\u53F0"),!1;let o=this.getCategoryConfig()||this.getDefaultCategoryConfig();Z(o);let a=s.filter.getEditingFilterState();if(K){let n="custom-"+Date.now();o.customCategories.push({id:n,name:e,icon:t,platforms:r,isCustom:!0}),o.categoryOrder.unshift(n),o.categoryFilters[n]={mode:a.mode,keywords:[...a.keywords]}}else if(P){let n=o.customCategories.findIndex(l=>l.id===P);n>=0?o.customCategories[n]={...o.customCategories[n],name:e,icon:t,platforms:r}:o.platformOrder[P]=r,o.categoryFilters[P]={mode:a.mode,keywords:[...a.keywords]}}return this.saveCategoryConfig(o),O=!0,this.hideEditPanel(),this.renderCategoryList(),L=!1,this.applyCategoryListCollapseState(),!0},deleteCategory(e){if(!confirm("\u786E\u5B9A\u8981\u5220\u9664\u8FD9\u4E2A\u81EA\u5B9A\u4E49\u680F\u76EE\u5417\uFF1F"))return;let t=this.getCategoryConfig()||this.getDefaultCategoryConfig();t.customCategories=t.customCategories.filter(r=>r.id!==e),t.categoryOrder=t.categoryOrder.filter(r=>r!==e),delete t.platformOrder[e],this.saveCategoryConfig(t),O=!0,this.renderCategoryList()},resetCategoryConfig(){confirm("\u786E\u5B9A\u8981\u6062\u590D\u9ED8\u8BA4\u680F\u76EE\u914D\u7F6E\u5417\uFF1F\u6240\u6709\u81EA\u5B9A\u4E49\u680F\u76EE\u5C06\u88AB\u5220\u9664\u3002")&&(d.remove(j),u=null,S=null,this.renderCategoryList(),this.applyCategoryConfig())},applyCategoryConfig(){s.data.refreshViewerData({preserveScroll:!1})},applyCategoryConfigToData(e){let t=this.getMergedCategoryConfig();u||(u={},S={},Object.entries(e).forEach(([i,g])=>{u[i]={id:i,name:g.name,icon:g.icon,isDefault:!0,platforms:Object.keys(g.platforms||{})},Object.entries(g.platforms||{}).forEach(([f,C])=>{S[f]={id:f,name:C.name,defaultCategory:i,data:C}})}));let r={};Object.values(e).forEach(i=>{Object.entries(i.platforms||{}).forEach(([g,f])=>{r[g]=f})});let o={},a=t.hiddenDefaultCategories||[],n=t.categoryOrder||Object.keys(e),l=t.customCategories||[],c=t.platformOrder||{};return n.forEach(i=>{if(a.includes(i))return;let g=l.find(f=>f.id===i);if(g){let f={};(g.platforms||[]).forEach(C=>{r[C]&&(f[C]=r[C])}),o[i]={name:g.name,icon:"\u{1F4F1}",platforms:f}}else if(e[i]){let f=e[i],C=c[i];if(C&&C.length>0){let m={};C.forEach(w=>{f.platforms&&f.platforms[w]&&(m[w]=f.platforms[w])}),Object.keys(f.platforms||{}).forEach(w=>{m[w]||(m[w]=f.platforms[w])}),o[i]={...f,platforms:m}}else o[i]=f}}),Object.keys(e).forEach(i=>{!o[i]&&!a.includes(i)&&(o[i]=e[i])}),o}};window.openCategorySettings=()=>h.openCategorySettings();window.closeCategorySettings=()=>h.closeCategorySettings();window.saveCategorySettings=()=>h.saveCategorySettings();window.cancelCategorySettings=()=>h.cancelCategorySettings();window.showAddCategoryPanel=()=>h.showAddCategoryPanel();window.editCategory=e=>h.editCategory(e);window.cancelEditCategory=()=>h.cancelEditCategory();window.saveCategory=()=>h.saveCategory();window.deleteCategory=e=>h.deleteCategory(e);window.resetCategoryConfig=()=>h.resetCategoryConfig();window.toggleCategoryVisibility=e=>h.toggleCategoryVisibility(e);window.toggleCategoryListCollapseInSettings=()=>h.toggleCategoryListCollapseInSettings();window.toggleAllCategoriesOffInSettings=e=>h.toggleAllCategoriesOffInSettings(e);window.togglePlatformSelect=e=>h.togglePlatformSelect(e);window.bulkSelectPlatforms=e=>h.bulkSelectPlatforms(e);window.setPlatformSearchQuery=e=>h.setPlatformSearchQuery(e);s.settings=h;p(function(){let e=h.getCategoryConfig();e&&h.syncConfigToCookie(e)});var Ce="trendradar_filter_keywords",Se="trendradar_filter_mode_v1",_=[],V="exclude";function H(e){return e==="include"?"include":"exclude"}var R={normalizeFilterMode:H,getCategoryFilterConfig(e){if(!e)return{mode:"exclude",keywords:[]};let t=s.settings.getMergedCategoryConfig(),r=t.categoryFilters&&t.categoryFilters[e],o=H(r&&r.mode),a=Array.isArray(r&&r.keywords)?r.keywords:[];return{mode:o,keywords:a.map(n=>String(n||"").trim().toLowerCase()).filter(Boolean)}},applyCategoryFilter(e){let t=document.getElementById(`tab-${e}`);if(!t)return;let r=this.getCategoryFilterConfig(e),o=r.mode,a=r.keywords;t.querySelectorAll(".news-item").forEach(n=>{let l=(n.textContent||"").toLowerCase(),c=a.length>0?a.some(g=>l.includes(g)):!1;(a.length===0?!1:o==="include"?!c:c)?n.classList.add("filtered"):n.classList.remove("filtered")}),t.querySelectorAll(".platform-card").forEach(n=>{n.classList.remove("platform-empty-hidden")}),o==="include"&&t.querySelectorAll(".platform-card").forEach(n=>{n.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length<=0&&n.classList.add("platform-empty-hidden")}),s.counts.updateAllCounts()},applyCategoryFilterForActiveTab(){let t=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;t&&this.applyCategoryFilter(t)},setCategoryFilterEditorState(e,t){V=H(e),_=(Array.isArray(t)?t:[]).map(a=>String(a||"").trim().toLowerCase()).filter(Boolean);let r=document.getElementById("categoryFilterModeToggle");r&&(r.checked=V==="include");let o=document.getElementById("categoryFilterInput");o&&(o.value=""),this.renderCategoryFilterTags()},handleCategoryFilterModeToggle(e){V=e&&e.checked?"include":"exclude"},handleCategoryFilterKeypress(e){e.key==="Enter"&&this.addCategoryFilterKeyword()},addCategoryFilterKeyword(){let e=document.getElementById("categoryFilterInput"),t=(e?.value||"").trim().toLowerCase();t&&(_.includes(t)||(_.push(t),this.renderCategoryFilterTags()),e&&(e.value=""))},removeCategoryFilterKeyword(e){_=_.filter(t=>t!==e),this.renderCategoryFilterTags()},renderCategoryFilterTags(){let e=document.getElementById("categoryFilterTags");e&&(e.innerHTML=_.map(t=>`<span class="filter-tag">${y(t)}<span class="filter-remove" onclick="removeCategoryFilterKeyword('${y(t)}')">\xD7</span></span>`).join(""))},getEditingFilterState(){return{mode:V,keywords:[..._]}},migrateLegacyGlobalFilter(){let e=d.getRaw(Ce),t=d.getRaw(Se);if(!e&&!t)return;let r=[];try{r=e?JSON.parse(e):[]}catch{r=[]}Array.isArray(r)||(r=[]),r=r.map(c=>String(c||"").trim().toLowerCase()).filter(Boolean);let o=H(t),a=s.settings.getCategoryConfig()||s.settings.getDefaultCategoryConfig();s.settings.ensureCategoryFilters(a),(s.settings.getMergedCategoryConfig().categoryOrder||[]).forEach(c=>{a.categoryFilters[c]||(a.categoryFilters[c]={mode:o,keywords:[...r]})}),s.settings.saveCategoryConfig(a),d.remove(Ce),d.remove(Se)}};window.handleCategoryFilterModeToggle=e=>R.handleCategoryFilterModeToggle(e);window.handleCategoryFilterKeypress=e=>R.handleCategoryFilterKeypress(e);window.addCategoryFilterKeyword=()=>R.addCategoryFilterKeyword();window.removeCategoryFilterKeyword=e=>R.removeCategoryFilterKeyword(e);s.filter=R;p(function(){R.migrateLegacyGlobalFilter(),R.applyCategoryFilterForActiveTab()});var G="trendradar_active_tab",B={TAB_STORAGE_KEY:G,switchTab(e){s.badges.dismissNewCategoryBadge(e);let t=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(e)):String(e),r=document.querySelector(`.category-tab[data-category="${t}"]`),o=document.getElementById(`tab-${e}`);if(!r||!o){let a=document.querySelector(".category-tab");a?.dataset?.category&&a.dataset.category!==String(e)?this.switchTab(a.dataset.category):d.remove(G);return}document.querySelectorAll(".category-tab").forEach(a=>a.classList.remove("active")),r.classList.add("active"),document.querySelectorAll(".tab-pane").forEach(a=>a.classList.remove("active")),o.classList.add("active"),d.setRaw(G,e),s.scroll.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:e}),e==="sports"&&(s.badges.markFeatureSeen("sports-nba-schedule"),s.badges.updateNewBadges()),s.filter.applyCategoryFilter(e)},restoreActiveTab(){let e=d.getRaw(G);e&&document.querySelector(`.category-tab[data-category="${e}"]`)&&this.switchTab(e)},getActiveTabId(){return d.getRaw(G)||document.querySelector(".category-tab.active")?.dataset?.category||null},restoreActiveTabPlatformGridScroll(e){s.scroll.restoreActiveTabPlatformGridScroll(e)},attachPlatformGridScrollPersistence(){s.scroll.attachPlatformGridScrollPersistence()}};window.switchTab=e=>B.switchTab(e);s.tabs=B;p(function(){B.restoreActiveTab(),B.attachPlatformGridScrollPersistence();let e=B.getActiveTabId();e&&B.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:e})});var z="trendradar_active_tab",je=20;function te(){let e=document.querySelector('.platform-card[data-platform="nba-schedule"]');if(!e)return;localStorage.removeItem("nba_schedule_mode");let t=parseInt(localStorage.getItem("nba_schedule_page")||"0",10),r=t*20,o=r+20,a=e.querySelector('button[onclick="toggleNbaPage()"]');if(a){let l=a.querySelector("span");l&&(l.textContent="\u6362\u65B0"),a.title=t===0?"\u663E\u793A\u7B2C21-40\u6761":"\u663E\u793A\u7B2C1-20\u6761"}Array.from(e.querySelectorAll("li.news-item")).forEach((l,c)=>{let i=c>=r&&c<o;l.classList.toggle("paged-hidden",!i),l.style.display=i?"":"none"})}var ee=!1,be=0,D=null,Y={formatUpdatedAt:q,snapshotViewerState(){let e=d.getRaw(z)||document.querySelector(".category-tab.active")?.dataset?.category||null,t={};document.querySelectorAll(".platform-card").forEach(l=>{let c=l.dataset.platform;c&&(t[c]=parseInt(l.dataset.pageOffset||"0",10)||0)});let r=e?document.querySelector(`#tab-${e} .platform-grid`):null,o=r&&r.scrollLeft||0,a=null,n=0;if(r){let l=r.scrollLeft||0,c=null,i=r.querySelectorAll(".platform-card");for(let g of i)if((g.offsetLeft||0)<=l+1)c=g;else break;c?.dataset?.platform&&(a=c.dataset.platform,n=Math.max(0,l-(c.offsetLeft||0)))}return e&&r&&s.scroll.recordPlatformGridScrollForTab(e,r),{activeTab:e,pagingOffsets:t,activeTabPlatformGridScrollLeft:o,activeTabPlatformAnchorPlatformId:a,activeTabPlatformAnchorOffsetX:n,showReadMode:document.body.classList.contains("show-read-mode"),scrollY:window.scrollY||0,searchText:document.getElementById("searchInput")?.value||""}},renderViewerFromData(e,t){let r=document.querySelector(".tab-content-area"),o=document.querySelector(".category-tabs");if(!o||!r)return;let a=s.settings.applyCategoryConfigToData(e?.categories||{}),n=Object.entries(a).map(([m,w])=>{let A=y(w?.icon||""),U=y(w?.name||m),X=`${w?.is_new?`<span class="new-badge new-badge-category" data-category="${y(m)}">NEW</span>`:""}${m==="sports"?'<span class="new-badge" id="newBadgeSportsTab" style="display:none;">NEW</span>':""}`;return`
            <div class="category-tab" data-category="${y(m)}" onclick="switchTab('${y(m)}')">
                <div class="category-tab-icon">${A}</div>
                <div class="category-tab-name">${U}${X}</div>
            </div>`}).join(""),l=Object.entries(a).map(([m,w])=>{let A=w?.platforms||{},U=Object.entries(A).map(([v,x])=>{let X=y(x?.name||v),ve=x?.is_new?`<span class="new-badge new-badge-platform" data-platform="${y(v)}">NEW</span>`:"",Ee=Array.isArray(x?.news)?x.news:[],re=v&&t?.pagingOffsets&&Number.isFinite(t.pagingOffsets[v])?t.pagingOffsets[v]:0,$=v==="nba-schedule",oe=$?parseInt(localStorage.getItem("nba_schedule_page")||"0",10):0,Ae=Ee.map((E,N)=>{let Te=y(E?.stable_id||""),ae=y(E?.display_title||E?.title||""),Pe=y(E?.url||""),se=y(E?.meta||""),ne=!!E?.is_cross_platform,Oe=Array.isArray(E?.cross_platforms)?E.cross_platforms:[],_e=y(Oe.join(", ")),Re=y(E?.cross_platform_count??""),Fe=ne?`<span class="cross-platform-badge" title="\u540C\u65F6\u51FA\u73B0\u5728: ${_e}">\u{1F525} ${Re}</span>`:"",ke=ne?"cross-platform":"",Be=`<span class="news-index">${String(N+1)}</span>`,ie=oe*20,De=ie+20,xe=$&&(N<ie||N>=De),$e=$?xe?" paged-hidden":"":N<re||N>=re+je?" paged-hidden":"",Ne=se?`<div class="news-subtitle">${se}</div>`:"";return`
                        <li class="news-item${$e}" data-news-id="${Te}" data-news-title="${ae}">
                            <div class="news-item-content">
                                <input type="checkbox" class="news-checkbox" onchange="markAsRead(this)" title="\u6807\u8BB0\u5DF2\u8BFB">
                                ${Be}
                                <div class="news-title ${$?"nba-title ":""}${ke}" onclick="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)" tabindex="0" role="button" data-url="${Pe}">
                                    ${ae}
                                    ${Fe}
                                </div>
                            </div>
                            ${Ne}
                        </li>`}).join(""),Le=$?`<button class="platform-refresh-btn" type="button" onclick="toggleNbaPage()" title="${oe===0?"\u663E\u793A\u7B2C21-40\u6761":"\u663E\u793A\u7B2C1-20\u6761"}"><span>\u6362\u65B0</span></button>`:'<button class="platform-refresh-btn" type="button" onclick="refreshPlatform(this)" title="\u4EC5\u5237\u65B0\u672C\u5E73\u53F0\uFF0C\u6362\u65B0\uFF0820\u6761)"><span>\u6362\u65B0</span></button>';return`
                <div class="platform-card" data-platform="${y(v)}">
                    <div class="platform-header">
                        <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; cursor: pointer;" onclick="dismissNewPlatformBadge('${y(v)}')">\u{1F4F1} ${X}${ve}</div>
                        ${Le}
                    </div>
                    <ul class="news-list">${Ae}
                    </ul>
                </div>`}).join("");return`
            <div class="tab-pane" id="tab-${y(m)}">
                <div class="platform-grid">${U}
                </div>
            </div>`}).join("");o.innerHTML=n,r.innerHTML=l;try{let m=o.querySelectorAll(".category-tab").length;o.classList.toggle("compact",m>8)}catch{}let c=document.getElementById("updatedAt");c&&e?.updated_at&&(c.textContent=q(e.updated_at));let i=t&&typeof t.activeTab=="string"?t.activeTab:null;if(i){let m=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(i):i;if(document.querySelector(`.category-tab[data-category="${m}"]`))s.tabs.switchTab(i);else{let A=document.querySelector(".category-tab");A?.dataset?.category?s.tabs.switchTab(A.dataset.category):d.remove(z)}}else{let m=document.querySelector(".category-tab");m?.dataset?.category?s.tabs.switchTab(m.dataset.category):d.remove(z)}let g=typeof t?.showReadMode=="boolean"?t.showReadMode:s.readState.getShowReadModePref();s.readState.applyShowReadMode(g);let f=document.getElementById("searchInput");f&&typeof t?.searchText=="string"&&(f.value=t.searchText),s.search.searchNews(),s.filter.applyCategoryFilterForActiveTab(),s.readState.restoreReadState(),document.querySelectorAll(".platform-card").forEach(m=>{let w=m.dataset.platform,A=w&&t?.pagingOffsets&&Number.isFinite(t.pagingOffsets[w])?t.pagingOffsets[w]:0;s.paging.applyPagingToCard(m,A)}),s.counts.updateAllCounts(),s.readState.updateReadCount(),s.scroll.restoreActiveTabPlatformGridScroll(t),s.scroll.attachPlatformGridScrollPersistence();let C=document.getElementById("early-hide");C&&C.remove(),document.body.classList.add("categories-ready"),te()},async refreshViewerData(e={}){let t=e.preserveScroll!==!1;if(ee){D?D.preserveScroll=D.preserveScroll&&t:D={preserveScroll:t};return}ee=!0;try{let r=this.snapshotViewerState();r.preserveScroll=t;let a=await(await fetch("/api/news")).json();this.renderViewerFromData(a,r),r.preserveScroll&&(window.scrollTo({top:r.scrollY,behavior:"auto"}),s.scroll.restoreActiveTabPlatformGridScroll(r)),be=Date.now()}catch(r){console.error("refreshViewerData error:",r)}finally{ee=!1;let r=D;D=null,r&&this.refreshViewerData({preserveScroll:r.preserveScroll})}},async fetchData(){let e=document.getElementById("fetchBtn"),t=document.getElementById("progressContainer"),r=document.getElementById("progressBar"),o=document.getElementById("fetchStatus");e.classList.add("loading"),e.disabled=!0,t.classList.add("show"),r.classList.add("indeterminate"),o.className="fetch-status",o.textContent="\u6B63\u5728\u83B7\u53D6\u6570\u636E...";try{let n=await(await fetch("/api/fetch",{method:"POST"})).json();r.classList.remove("indeterminate"),n.success?(r.style.width="100%",o.className="fetch-status success",o.textContent=`\u2705 ${n.platforms} \u4E2A\u5E73\u53F0\uFF0C${n.news_count} \u6761\u65B0\u95FB`,setTimeout(()=>this.refreshViewerData({preserveScroll:!0}),300)):(r.style.width="0%",o.className="fetch-status error",o.textContent=`\u274C ${n.error}`)}catch(a){r.classList.remove("indeterminate"),r.style.width="0%",o.className="fetch-status error",o.textContent=`\u274C ${a.message}`}finally{e.classList.remove("loading"),e.disabled=!1,setTimeout(()=>{t.classList.remove("show"),r.style.width="0%"},5e3)}},setupAjaxAutoRefresh(){setInterval(()=>{document.visibilityState!=="visible"||Date.now()-be<295e3||this.refreshViewerData({preserveScroll:!0})},5e3),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&this.refreshViewerData({preserveScroll:!0})})}};function Ke(){let t=parseInt(localStorage.getItem("nba_schedule_page")||"0",10)===0?1:0;localStorage.setItem("nba_schedule_page",String(t)),te()}window.fetchData=()=>Y.fetchData();window.refreshViewerData=e=>Y.refreshViewerData(e);window.toggleNbaPage=Ke;s.data=Y;p(function(){let e=document.getElementById("updatedAt");e&&e.textContent&&(e.textContent=q(e.textContent)),Y.setupAjaxAutoRefresh(),te()});p(function(){let e=s.settings.getCategoryConfig();e&&(e.customCategories&&e.customCategories.length>0||e.hiddenDefaultCategories&&e.hiddenDefaultCategories.length>0||e.categoryOrder&&e.categoryOrder.length>0)?s.data.refreshViewerData({preserveScroll:!1}):document.body.classList.add("categories-ready")});})();
