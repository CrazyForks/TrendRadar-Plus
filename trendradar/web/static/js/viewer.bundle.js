(()=>{var a=window.TrendRadar=window.TrendRadar||{},it=[],lt=!1;function v(e){lt?e():it.push(e)}document.addEventListener("DOMContentLoaded",function(){lt=!0,it.forEach(e=>{try{e()}catch(t){console.error("Ready handler error:",t)}})});function w(e){return String(e||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function ae(e){let t=e==null?"":String(e).trim();if(!t)return t;let r=t.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})(?::\d{2})?$/);return r?`${r[2]}-${r[3]} ${r[4]}:${r[5]}`:(t.match(/^(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/),t)}a.ready=v;a.escapeHtml=w;a.formatUpdatedAt=ae;var q={container:null,nextId:1,items:new Map};function ur(){if(q.container)return q.container;let e=document.createElement("div");e.id="tr-toast-container",e.style.position="fixed",e.style.right="16px",e.style.bottom="16px",e.style.display="flex",e.style.flexDirection="column",e.style.gap="10px",e.style.zIndex="99999";try{document.body.appendChild(e)}catch{}return q.container=e,e}function fr(e){let t=String(e||"info");return t==="loading"?{bg:"#111827",fg:"#fff",border:"#111827"}:t==="success"?{bg:"#16a34a",fg:"#fff",border:"#16a34a"}:t==="error"?{bg:"#dc2626",fg:"#fff",border:"#dc2626"}:{bg:"#111827",fg:"#fff",border:"#111827"}}function at(e,t,r){let s=fr(r);e.className="tr-toast",e.style.display="flex",e.style.alignItems="center",e.style.gap="10px",e.style.padding="10px 12px",e.style.borderRadius="10px",e.style.background=s.bg,e.style.color=s.fg,e.style.border=`1px solid ${s.border}`,e.style.boxShadow="0 10px 20px rgba(0,0,0,0.18)",e.style.fontSize="0.9rem",e.style.maxWidth="360px",e.style.wordBreak="break-word";let n=String(r||"info")==="loading"?'<span aria-hidden="true" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#60a5fa;box-shadow:0 0 0 2px rgba(96,165,250,0.3);"></span>':"";e.innerHTML=`${n}<div class="tr-toast-msg">${w(t||"")}</div>`}a.toast={show(e,t={}){let r=`toast-${q.nextId++}`,s=ur(),o=document.createElement("div");o.dataset.toastId=r,at(o,e,t.variant);try{s.appendChild(o)}catch{}let n={id:r,el:o,hideTimer:0};q.items.set(r,n);let i=Number(t.durationMs||0);return i>0&&(n.hideTimer=window.setTimeout(()=>{a.toast.hide(r)},i)),r},update(e,t,r={}){let s=q.items.get(String(e||""));if(!s)return;s.hideTimer&&(window.clearTimeout(s.hideTimer),s.hideTimer=0),at(s.el,t,r.variant);let o=Number(r.durationMs||0);o>0&&(s.hideTimer=window.setTimeout(()=>{a.toast.hide(e)},o))},hide(e){let t=q.items.get(String(e||""));if(t){t.hideTimer&&(window.clearTimeout(t.hideTimer),t.hideTimer=0);try{t.el.remove()}catch{}q.items.delete(String(e||""))}}};var S={get(e,t=null){try{let r=localStorage.getItem(e);return r===null?t:JSON.parse(r)}catch{return t}},set(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.error("Storage set error:",r)}},remove(e){try{localStorage.removeItem(e)}catch{}},getRaw(e){return localStorage.getItem(e)},setRaw(e,t){localStorage.setItem(e,t)}};a.storage=S;var gr={updatePlatformCount(e){if(!e)return;let t=e.querySelectorAll(".news-item:not(.read):not(.filtered):not(.search-hidden):not(.paged-hidden)"),r=e.querySelector(".platform-visible-count");r&&(r.textContent=t.length)},updateAllCounts(){document.querySelectorAll(".platform-card").forEach(r=>{this.updatePlatformCount(r)});let e=document.querySelectorAll(".news-item:not(.read):not(.filtered):not(.search-hidden):not(.paged-hidden)").length,t=document.getElementById("totalNews");t&&(t.textContent=e)}};a.counts=gr;var V={openLink(e){let t=e.dataset.url;t&&window.open(t,"_blank")},isHoverDevice(){return window.matchMedia&&window.matchMedia("(hover: hover)").matches},closeAllPreviews(e){document.querySelectorAll(".news-item.preview").forEach(t=>{e&&t===e||t.classList.remove("preview")})},handleTitleClickV2(e,t){t.stopPropagation();let r=e.closest(".news-item");if(!r)return;let s=r.querySelector(".news-checkbox");if(s&&!s.checked&&(s.checked=!0,typeof window.markAsRead=="function"?window.markAsRead(s):a.readState&&typeof a.readState.markAsRead=="function"&&a.readState.markAsRead(s)),this.isHoverDevice())return;if(r.classList.contains("preview")){r.classList.remove("preview");return}t.preventDefault(),this.closeAllPreviews(r),r.classList.add("preview")},handleTitleKeydownV2(e,t){t.key==="Enter"?this.handleTitleClickV2(e,t):t.key===" "?(t.preventDefault(),this.handleTitleClickV2(e,t)):t.key==="Escape"&&this.closeAllPreviews(null)}};window.handleTitleClickV2=(e,t)=>V.handleTitleClickV2(e,t);window.handleTitleKeydownV2=(e,t)=>V.handleTitleKeydownV2(e,t);window.openLink=e=>V.openLink(e);document.addEventListener("click",e=>{e.target.closest(".news-item")||V.closeAllPreviews(null)});document.addEventListener("touchstart",e=>{e.target.closest(".news-item")||V.closeAllPreviews(null)},{passive:!0});document.addEventListener("keydown",e=>{e.key==="Escape"&&V.closeAllPreviews(null)});a.link=V;var ct={searchNews(){let t=(document.getElementById("searchInput")?.value||"").toLowerCase();document.querySelectorAll(".news-item").forEach(r=>{let s=r.textContent.toLowerCase();!t||s.includes(t)?r.classList.remove("search-hidden"):r.classList.add("search-hidden")}),a.counts.updateAllCounts(),a.paging&&typeof a.paging.scheduleAutofillActiveTab=="function"&&a.paging.scheduleAutofillActiveTab()}};window.searchNews=()=>ct.searchNews();a.search=ct;var dt="trendradar_platform_grid_scroll_v1",mr={getPlatformGridScrollState(){return S.get(dt,{})},setPlatformGridScrollState(e){S.set(dt,e||{})},recordPlatformGridScrollForTab(e,t){if(!e||!t)return;let r=t.scrollLeft||0,s=null,o=0,n=null,i=t.querySelectorAll(".platform-card");for(let c of i)if((c.offsetLeft||0)<=r+1)n=c;else break;n?.dataset?.platform&&(s=n.dataset.platform,o=Math.max(0,r-(n.offsetLeft||0)));let l=this.getPlatformGridScrollState();l[e]={left:r,anchorPlatformId:s,anchorOffsetX:o,updatedAt:Date.now()},this.setPlatformGridScrollState(l)},attachPlatformGridScrollPersistence(){document.querySelectorAll(".tab-pane .platform-grid").forEach(e=>{if(e.dataset.scrollPersistBound==="1")return;e.dataset.scrollPersistBound="1";let t=!1;e.addEventListener("scroll",()=>{e.dataset.trRestoring!=="1"&&(e.dataset.trUserScrolled="1"),!t&&(t=!0,requestAnimationFrame(()=>{t=!1;let r=e.closest(".tab-pane"),s=r?.id?.startsWith("tab-")?r.id.slice(4):null;this.recordPlatformGridScrollForTab(s,e)}))},{passive:!0})})},restoreActiveTabPlatformGridScroll(e){let t=e?.activeTab;if(!e?.preserveScroll||!t)return;let r=this.getPlatformGridScrollState()?.[t],s=Number.isFinite(r?.left)?r.left:Number.isFinite(e.activeTabPlatformGridScrollLeft)?e.activeTabPlatformGridScrollLeft:0,o=typeof r?.anchorPlatformId=="string"&&r.anchorPlatformId?r.anchorPlatformId:e.activeTabPlatformAnchorPlatformId,n=Number.isFinite(r?.anchorOffsetX)?r.anchorOffsetX:Number.isFinite(e.activeTabPlatformAnchorOffsetX)?e.activeTabPlatformAnchorOffsetX:0,i=()=>{let l=document.querySelector(`#tab-${t} .platform-grid`);if(l&&l.dataset.trUserScrolled!=="1"){if(o){let c=null;if(l.querySelectorAll(".platform-card").forEach(d=>{!c&&d.dataset.platform===o&&(c=d)}),c&&c.offsetParent!==null){l.dataset.trRestoring="1",l.scrollLeft=(c.offsetLeft||0)+n,requestAnimationFrame(()=>{try{delete l.dataset.trRestoring}catch{}});return}}l.dataset.trRestoring="1",l.scrollLeft=s,requestAnimationFrame(()=>{try{delete l.dataset.trRestoring}catch{}})}};requestAnimationFrame(()=>{requestAnimationFrame(()=>{i(),setTimeout(i,50),setTimeout(i,200),setTimeout(i,600)})})}};a.scroll=mr;var ut="trendradar_feature_badge_v1:",ft="trendradar_new_badges_dismissed_v1",Be={getFeatureBadgeState(e){return S.get(ut+e,null)},setFeatureBadgeState(e,t){S.set(ut+e,t)},ensureFeatureFirstSeen(e){let t=this.getFeatureBadgeState(e);if(t&&typeof t.firstSeenAt=="number")return t;let r={firstSeenAt:Date.now(),seenAt:null};return this.setFeatureBadgeState(e,r),r},markFeatureSeen(e){let t=this.ensureFeatureFirstSeen(e);t.seenAt||(t.seenAt=Date.now(),this.setFeatureBadgeState(e,t))},shouldShowFeatureBadge(e,t){let r=this.ensureFeatureFirstSeen(e);if(r.seenAt)return!1;let s=(t||7)*24*60*60*1e3;return Date.now()-(r.firstSeenAt||0)<=s},updateNewBadges(){let e=document.getElementById("newBadgeSportsTab");e&&(e.style.display=this.shouldShowFeatureBadge("sports-nba-schedule",7)?"":"none")},getDismissedNewBadges(){let e=S.get(ft,{});return{categories:e?.categories||{},platforms:e?.platforms||{}}},setDismissedNewBadges(e){S.set(ft,e||{categories:{},platforms:{}})},applyDismissedNewBadges(){let e=this.getDismissedNewBadges();document.querySelectorAll(".new-badge-category").forEach(t=>{let r=t?.dataset?.category;r&&e.categories?.[r]&&(t.style.display="none")}),document.querySelectorAll(".new-badge-platform").forEach(t=>{let r=t?.dataset?.platform;r&&e.platforms?.[r]&&(t.style.display="none")})},dismissNewCategoryBadge(e){if(!e)return;let t=this.getDismissedNewBadges();t.categories?.[e]||(t.categories[e]=!0,this.setDismissedNewBadges(t)),document.querySelectorAll(`.new-badge-category[data-category="${CSS.escape(e)}"]`).forEach(r=>{r.style.display="none"})},dismissNewPlatformBadge(e){if(!e)return;let t=this.getDismissedNewBadges();t.platforms?.[e]||(t.platforms[e]=!0,this.setDismissedNewBadges(t)),document.querySelectorAll(`.new-badge-platform[data-platform="${CSS.escape(e)}"]`).forEach(r=>{r.style.display="none"})}};window.dismissNewPlatformBadge=e=>Be.dismissNewPlatformBadge(e);a.badges=Be;v(function(){Be.applyDismissedNewBadges()});var I=20,pr=20,gt=10,hr=8,yr=80,Sr=160,ie={PAGE_SIZE:I,getCardPageSize(e){let t=e?.dataset?.pageSize,r=parseInt(t||"",10);return Number.isFinite(r)&&r>0?r:I},setCardPageSize(e,t){if(!e)return;let r=Math.max(I,parseInt(String(t||""),10)||I);e.dataset.pageSize=String(r)},applyPagingToCard(e,t){let r=Array.from(e.querySelectorAll(".news-item")),s=r.length,o=this.getCardPageSize(e);if(s<=o){r.forEach(l=>l.classList.remove("paged-hidden")),e.dataset.pageOffset="0";return}let n=Math.max(0,Math.min(t,s-1)),i=Math.min(n+o,s);r.forEach((l,c)=>{c>=n&&c<i?l.classList.remove("paged-hidden"):l.classList.add("paged-hidden")}),e.dataset.pageOffset=String(n)},initPaging(){document.querySelectorAll(".platform-card").forEach(e=>{this.setCardPageSize(e,I),this.applyPagingToCard(e,0)}),a.counts.updateAllCounts()},refreshPlatform(e){let t=e.closest(".platform-card");if(!t)return;let s=t.querySelectorAll(".news-item").length;if(s<=I)return;let o=parseInt(t.dataset.pageOffset||"0",10),n=o+I>=s?0:o+I;this.applyPagingToCard(t,n),a.counts.updateAllCounts()},getVisibleNewsItems(e){return e?Array.from(e.querySelectorAll(".news-item")).filter(t=>!t.classList.contains("filtered")&&!t.classList.contains("search-hidden")&&!t.classList.contains("paged-hidden")&&!t.classList.contains("read")):[]},shouldAutofillCard(e,t){if(!e||e.classList.contains("platform-empty-hidden"))return!1;let r=this.getVisibleNewsItems(e),s=Number.isFinite(t)?t:gt;if(r.length<s)return!0;let o=r[r.length-1];if(!o)return!0;let n=e.getBoundingClientRect(),i=o.getBoundingClientRect();return!Number.isFinite(n.bottom)||!Number.isFinite(i.bottom)?!1:n.bottom-i.bottom>=yr},autofillCard(e,t={}){if(!e)return!1;let r=Number.isFinite(t.minVisible)?t.minVisible:gt,s=Number.isFinite(t.maxSteps)?t.maxSteps:hr,o=t.force===!0,n=e.querySelectorAll(".news-item").length;if(n<=0)return!1;let i=parseInt(e.dataset.pageOffset||"0",10)||0,l=this.getCardPageSize(e),c=!1;for(let d=0;d<s&&!(!o&&!this.shouldAutofillCard(e,r)||i+l>=n);d++)l=Math.min(n-i,l+pr),this.setCardPageSize(e,l),this.applyPagingToCard(e,i),c=!0;return c&&a.counts.updateAllCounts(),c},autofillForCategory(e,t={}){let r=document.getElementById(`tab-${e}`);if(!r)return!1;let s=!1;return r.querySelectorAll(".platform-card").forEach(o=>{this.autofillCard(o,t)&&(s=!0)}),s},autofillActiveTab(e={}){let r=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;return r?this.autofillForCategory(r,e):!1},scheduleAutofillActiveTab(e={}){clearTimeout(this._autofillTimer),this._autofillTimer=setTimeout(()=>{this._autofillTimer=null,this.autofillActiveTab(e)},120)},attachAutofillScrollListener(){this._autofillScrollBound||(this._autofillScrollBound=!0,window.addEventListener("scroll",()=>{(document.documentElement.scrollHeight||0)-(window.scrollY+window.innerHeight)<=Sr&&this.scheduleAutofillActiveTab({force:!0})},{passive:!0}))}};window.refreshPlatform=e=>ie.refreshPlatform(e);a.paging=ie;v(function(){ie.initPaging(),ie.attachAutofillScrollListener(),ie.scheduleAutofillActiveTab({force:!0,maxSteps:1})});var mt="trendradar_read_news_v2",pt="trendradar_read_news",ht="trendradar_show_read_mode",wr=24,O={getReadNews(){return S.get(mt,{})},saveReadNews(e){S.set(mt,e)},getShowReadModePref(){let e=S.getRaw(ht);return e===null?!0:e==="1"},applyShowReadMode(e){e?document.body.classList.add("show-read-mode"):document.body.classList.remove("show-read-mode");let t=document.getElementById("showReadBtn");t&&(e?t.classList.add("active"):t.classList.remove("active"))},migrateOldFormat(){S.getRaw(pt)&&(S.remove(pt),console.log("\u5DF2\u6E05\u9664\u65E7\u7248\u672C\u5DF2\u8BFB\u8BB0\u5F55"))},cleanupExpiredReads(){let e=Date.now(),t=this.getReadNews(),r=!1,s=0;for(let[o,n]of Object.entries(t))if((e-n.readAt)/36e5>=wr){let l=document.querySelector(`[data-news-id="${o}"]`);if(l){l.classList.remove("read");let c=l.querySelector(".news-checkbox");c&&(c.checked=!1)}delete t[o],r=!0,s++}return r&&this.saveReadNews(t),s},markAsRead(e){let t=e.closest(".news-item"),r=t.dataset.newsId,s=t.dataset.newsTitle||"",o=this.getReadNews();e.checked?(t.classList.add("read"),o[r]||(o[r]={title:s.substring(0,50),readAt:Date.now()},this.saveReadNews(o))):(t.classList.remove("read"),delete o[r],this.saveReadNews(o)),a.counts.updatePlatformCount(e.closest(".platform-card")),this.updateReadCount()},updateReadCount(){let e=this.getReadNews(),t=document.getElementById("readCount");t&&(t.textContent=Object.keys(e).length)},restoreReadState(){let e=this.getReadNews();Object.keys(e).forEach(t=>{let r=document.querySelector(`[data-news-id="${t}"]`);if(r){r.classList.add("read");let s=r.querySelector(".news-checkbox");s&&(s.checked=!0)}}),a.counts.updateAllCounts(),this.updateReadCount()},toggleShowRead(){let e=!document.body.classList.contains("show-read-mode");this.applyShowReadMode(e),S.setRaw(ht,e?"1":"0"),a.counts.updateAllCounts()},clearAllRead(){confirm("\u786E\u5B9A\u8981\u6E05\u9664\u6240\u6709\u5DF2\u8BFB\u8BB0\u5F55\u5417\uFF1F\u6240\u6709\u65B0\u95FB\u5C06\u6062\u590D\u663E\u793A\u3002")&&(document.querySelectorAll(".news-item.read").forEach(e=>{e.classList.remove("read");let t=e.querySelector(".news-checkbox");t&&(t.checked=!1)}),this.saveReadNews({}),a.counts.updateAllCounts(),this.updateReadCount())}};window.markAsRead=e=>O.markAsRead(e);window.toggleShowRead=()=>O.toggleShowRead();window.clearAllRead=()=>O.clearAllRead();a.readState=O;v(function(){O.applyShowReadMode(O.getShowReadModePref()),O.migrateOldFormat();let e=O.cleanupExpiredReads();e>0&&console.log(`\u5DF2\u6E05\u7406 ${e} \u6761\u8FC7\u671F\u5DF2\u8BFB\u8BB0\u5F55`),O.restoreReadState(),O.updateReadCount()});var be="trendradar_categories_config",De=1,C=null,L=null,U=null,Ce=!1,Z=!1,N=!0,br=null,le="",W=!1;function qe(e){(!e.categoryFilters||typeof e.categoryFilters!="object")&&(e.categoryFilters={})}function yt(e){let t=e&&typeof e=="object"?e:{};return Array.isArray(t.customCategories)||(t.customCategories=[]),Array.isArray(t.hiddenDefaultCategories)||(t.hiddenDefaultCategories=[]),Array.isArray(t.categoryOrder)||(t.categoryOrder=[]),(!t.platformOrder||typeof t.platformOrder!="object")&&(t.platformOrder={}),qe(t),t}var A={CATEGORY_CONFIG_KEY:be,ensureCategoryFilters:qe,normalizeCategoryConfig:yt,getCategoryConfig(){try{let e=S.getRaw(be);if(!e)return null;let t=JSON.parse(e);return t.version!==De?null:yt(t)}catch{return null}},saveCategoryConfig(e){e.version=De,S.setRaw(be,JSON.stringify(e)),this.syncConfigToCookie(e)},syncConfigToCookie(e){try{e.customCategories?.length>0||e.hiddenDefaultCategories?.length>0||e.categoryOrder?.length>0?document.cookie="trendradar_has_config=1; path=/; max-age=31536000; SameSite=Lax":document.cookie="trendradar_has_config=; path=/; max-age=0"}catch(t){console.error("Failed to sync config to cookie:",t)}},getDefaultCategoryConfig(){return C||(C={},L={},document.querySelectorAll(".category-tab").forEach(e=>{let t=e.dataset.category,r=e.querySelector(".category-tab-icon")?.textContent?.trim()||"\u{1F4C1}",s=e.querySelector(".category-tab-name")?.textContent?.replace(/NEW$/,"")?.trim()||t;C[t]={id:t,name:s,icon:r,isDefault:!0}}),document.querySelectorAll(".platform-card").forEach(e=>{let t=e.dataset.platform,r=e.querySelector(".platform-name")?.textContent?.trim()?.replace(/ðŸ“±\s*/,"")?.split(" ")[0]||t,o=e.closest(".tab-pane")?.id?.replace("tab-","")||"other";L[t]={id:t,name:r,defaultCategory:o},C[o]&&(C[o].platforms||(C[o].platforms=[]),C[o].platforms.push(t))})),{version:De,customCategories:[],hiddenDefaultCategories:[],categoryOrder:Object.keys(C),platformOrder:{},categoryFilters:{}}},getMergedCategoryConfig(){let e=this.getDefaultCategoryConfig(),t=this.getCategoryConfig();if(!t)return e;let r={...e,customCategories:t.customCategories||[],hiddenDefaultCategories:t.hiddenDefaultCategories||[],categoryOrder:t.categoryOrder||e.categoryOrder,platformOrder:t.platformOrder||{},categoryFilters:t.categoryFilters||{}};return Object.keys(C).forEach(s=>{r.categoryOrder.includes(s)||r.categoryOrder.push(s)}),r.customCategories.forEach(s=>{r.categoryOrder.includes(s.id)||r.categoryOrder.push(s.id)}),r},getDefaultCategories(){return C},getAllPlatforms(){return L},setDefaultCategories(e){C=e},setAllPlatforms(e){L=e},async openCategorySettings(){let e=document.getElementById("categorySettingsNewBadge");if(e&&(e.style.display="none",localStorage.setItem("category_settings_badge_dismissed","true")),!C||Object.keys(C).length===0)try{let s=await(await fetch("/api/news")).json();s?.categories&&(C={},L={},Object.entries(s.categories).forEach(([o,n])=>{C[o]={id:o,name:n.name,icon:n.icon,isDefault:!0,platforms:Object.keys(n.platforms||{})},Object.entries(n.platforms||{}).forEach(([i,l])=>{L[i]={id:i,name:l.name,defaultCategory:o,data:l}})}))}catch(r){console.error("Failed to fetch categories:",r)}document.getElementById("categorySettingsModal").classList.add("show"),N=!0,br=null,this.applyCategoryListCollapseState(),this.renderCategoryList(),this.hideEditPanel()},applyCategoryListCollapseState(){let e=document.getElementById("categoryListWrapper");e&&(N?e.classList.add("collapsed"):e.classList.remove("collapsed"));let t=document.getElementById("categoryListToggleBtn");t&&(t.textContent=N?"\u5C55\u5F00\u680F\u76EE\u5217\u8868":"\u6536\u8D77\u680F\u76EE\u5217\u8868")},toggleCategoryListCollapseInSettings(){N=!N,this.applyCategoryListCollapseState()},closeCategorySettings(){document.getElementById("categorySettingsModal").classList.remove("show"),W&&(W=!1,this.applyCategoryConfig())},saveCategorySettings(){let e=document.getElementById("categoryEditPanel");e&&e.classList.contains("show")&&!this.saveCategory()||this.closeCategorySettings()},cancelCategorySettings(){W=!1,document.getElementById("categorySettingsModal").classList.remove("show")},renderCategoryList(){let e=document.getElementById("categoryList"),t=this.getMergedCategoryConfig(),r="";t.categoryOrder.forEach(o=>{let n=t.customCategories.find(d=>d.id===o),i=t.hiddenDefaultCategories.includes(o),l;if(n)l=n;else if(C[o])l=C[o];else return;let c=n?l.platforms?.length||0:C[o]?.platforms?.length||0;r+=`
                <div class="category-item ${n?"custom":""}" data-category-id="${o}" draggable="true">
                    <span class="category-item-drag">\u2630</span>
                    <span class="category-item-name">${l.name}</span>
                    <span class="category-item-platforms">${c} \u4E2A\u5E73\u53F0</span>
                    <label class="category-item-toggle">
                        <input type="checkbox" ${i?"":"checked"} onchange="toggleCategoryVisibility('${o}')">
                        <span class="slider"></span>
                    </label>
                    <div class="category-item-actions">
                        <button class="category-item-btn" onclick="editCategory('${o}')">\u7F16\u8F91</button>
                        ${n?`<button class="category-item-btn delete" onclick="deleteCategory('${o}')">\u5220\u9664</button>`:""}
                    </div>
                </div>
            `}),e.innerHTML=r;let s=document.getElementById("allCategoriesOffToggle");if(s){let o=t.hiddenDefaultCategories||[],n=t.categoryOrder||[];s.checked=n.length>0&&n.every(i=>o.includes(i))}Z?e.classList.add("hide-default"):e.classList.remove("hide-default"),this.setupCategoryDragAndDrop()},toggleDefaultCategoryListInSettings(){Z=!Z,this.renderCategoryList()},toggleAllCategoriesOffInSettings(e){},setupCategoryDragAndDrop(){let e=document.getElementById("categoryList");e.querySelectorAll(".category-item").forEach(r=>{r.addEventListener("dragstart",s=>{r.classList.add("dragging"),s.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging"),this.saveCategoryOrder()}),r.addEventListener("dragover",s=>{s.preventDefault();let o=e.querySelector(".dragging");if(o&&o!==r){let n=r.getBoundingClientRect(),i=n.top+n.height/2;s.clientY<i?e.insertBefore(o,r):e.insertBefore(o,r.nextSibling)}})})},saveCategoryOrder(){let t=document.getElementById("categoryList").querySelectorAll(".category-item"),r=Array.from(t).map(o=>o.dataset.categoryId),s=this.getCategoryConfig()||this.getDefaultCategoryConfig();s.categoryOrder=r,this.saveCategoryConfig(s),W=!0},toggleCategoryVisibility(e){let t=this.getCategoryConfig()||this.getDefaultCategoryConfig(),r=t.hiddenDefaultCategories.indexOf(e);r>=0?t.hiddenDefaultCategories.splice(r,1):t.hiddenDefaultCategories.push(e),this.saveCategoryConfig(t),W=!0,this.renderCategoryList()},showAddCategoryPanel(){Ce=!0,U=null,N=!0,this.applyCategoryListCollapseState(),Z=!0,document.getElementById("editCategoryName").value="";let e=document.getElementById("platformSearchInput");e&&(e.value=""),le="",this.renderPlatformSelectList([]),a.filter.setCategoryFilterEditorState("exclude",[]),document.getElementById("categoryEditPanel").classList.add("show")},editCategory(e){Ce=!1,U=e;let t=this.getMergedCategoryConfig(),r=t.customCategories.find(l=>l.id===e),s,o;r?(s=r,o=s.platforms||[]):(s=C[e],o=t.platformOrder[e]||s.platforms||[]),document.getElementById("editCategoryName").value=s.name,this.renderPlatformSelectList(o,r);let n=a.filter.getCategoryFilterConfig(e);a.filter.setCategoryFilterEditorState(n.mode,n.keywords),Z=!0,N=!0,this.applyCategoryListCollapseState();let i=document.getElementById("platformSearchInput");i&&(i.value=""),le="",document.getElementById("categoryEditPanel").classList.add("show")},hideEditPanel(){document.getElementById("categoryEditPanel").classList.remove("show"),U=null,Ce=!1,Z=!1,this.renderCategoryList();let e=document.getElementById("platformSearchInput");e&&(e.value=""),le=""},cancelEditCategory(){this.hideEditPanel()},renderPlatformSelectList(e,t=!1){let r=document.getElementById("platformSelectList"),s=Object.keys(L),o=[];e.forEach(c=>{L[c]&&o.push(c)}),s.forEach(c=>{o.includes(c)||o.push(c)});let n=(le||"").trim().toLowerCase(),i=n?o.filter(c=>(L[c]?.name||"").toLowerCase().includes(n)):o,l=n.length>0;r.innerHTML=i.map(c=>{let d=L[c],f=e.includes(c);return`
                <label class="platform-select-item ${f?"selected":""} ${l?"no-drag":""}" data-platform-id="${c}" draggable="${l?"false":"true"}">
                    <span class="drag-handle">\u2630</span>
                    <input type="checkbox" ${f?"checked":""} onchange="togglePlatformSelect('${c}')">
                    <span>${d.name}</span>
                </label>
            `}).join(""),l||this.setupPlatformDragAndDrop()},setPlatformSearchQuery(e){le=String(e||"");let t=this.getSelectedPlatforms();this.renderPlatformSelectList(t)},bulkSelectPlatforms(e){let t=document.getElementById("platformSelectList");if(!t)return;t.querySelectorAll(".platform-select-item").forEach(s=>{let o=s.querySelector('input[type="checkbox"]');e==="all"?(s.classList.add("selected"),o&&(o.checked=!0)):(e==="none"||e==="clear")&&(s.classList.remove("selected"),o&&(o.checked=!1))})},setupPlatformDragAndDrop(){let e=document.getElementById("platformSelectList");e.querySelectorAll(".platform-select-item").forEach(r=>{r.addEventListener("dragstart",s=>{r.classList.add("dragging"),s.dataTransfer.effectAllowed="move"}),r.addEventListener("dragend",()=>{r.classList.remove("dragging")}),r.addEventListener("dragover",s=>{s.preventDefault();let o=e.querySelector(".dragging");if(o&&o!==r){let n=r.getBoundingClientRect(),i=n.top+n.height/2;s.clientY<i?e.insertBefore(o,r):e.insertBefore(o,r.nextSibling)}})})},togglePlatformSelect(e){let t=document.querySelector(`.platform-select-item[data-platform-id="${e}"]`);t&&t.classList.toggle("selected")},getSelectedPlatforms(){let e=document.querySelectorAll(".platform-select-item"),t=[];return e.forEach(r=>{r.classList.contains("selected")&&t.push(r.dataset.platformId)}),t},saveCategory(){let e=document.getElementById("editCategoryName").value.trim(),t="\u{1F4F1}",r=this.getSelectedPlatforms();if(!e)return alert("\u8BF7\u8F93\u5165\u680F\u76EE\u540D\u79F0"),!1;if(r.length===0)return alert("\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5E73\u53F0"),!1;let s=this.getCategoryConfig()||this.getDefaultCategoryConfig();qe(s);let o=a.filter.getEditingFilterState();if(Ce){let n="custom-"+Date.now();s.customCategories.push({id:n,name:e,icon:t,platforms:r,isCustom:!0}),s.categoryOrder.unshift(n),s.categoryFilters[n]={mode:o.mode,keywords:[...o.keywords]}}else if(U){let n=s.customCategories.findIndex(i=>i.id===U);n>=0?s.customCategories[n]={...s.customCategories[n],name:e,icon:t,platforms:r}:s.platformOrder[U]=r,s.categoryFilters[U]={mode:o.mode,keywords:[...o.keywords]}}return this.saveCategoryConfig(s),W=!0,this.hideEditPanel(),this.renderCategoryList(),N=!1,this.applyCategoryListCollapseState(),!0},deleteCategory(e){if(!confirm("\u786E\u5B9A\u8981\u5220\u9664\u8FD9\u4E2A\u81EA\u5B9A\u4E49\u680F\u76EE\u5417\uFF1F"))return;let t=this.getCategoryConfig()||this.getDefaultCategoryConfig();t.customCategories=t.customCategories.filter(r=>r.id!==e),t.categoryOrder=t.categoryOrder.filter(r=>r!==e),delete t.platformOrder[e],this.saveCategoryConfig(t),W=!0,this.renderCategoryList()},resetCategoryConfig(){confirm("\u786E\u5B9A\u8981\u6062\u590D\u9ED8\u8BA4\u680F\u76EE\u914D\u7F6E\u5417\uFF1F\u6240\u6709\u81EA\u5B9A\u4E49\u680F\u76EE\u5C06\u88AB\u5220\u9664\u3002")&&(S.remove(be),C=null,L=null,this.renderCategoryList(),this.applyCategoryConfig())},applyCategoryConfig(){a.data.refreshViewerData({preserveScroll:!1})},applyCategoryConfigToData(e){let t=this.getMergedCategoryConfig();C?Object.entries(e).forEach(([c,d])=>{if(!C[c])C[c]={id:c,name:d.name,icon:d.icon,isDefault:!0,platforms:Object.keys(d.platforms||{})};else{C[c].platforms||(C[c].platforms=[]);let f=new Set(C[c].platforms||[]);Object.keys(d.platforms||{}).forEach(u=>{f.has(u)||C[c].platforms.push(u)})}Object.entries(d.platforms||{}).forEach(([f,u])=>{L[f]||(L[f]={id:f,name:u.name,defaultCategory:c,data:u})})}):(C={},L={},Object.entries(e).forEach(([c,d])=>{C[c]={id:c,name:d.name,icon:d.icon,isDefault:!0,platforms:Object.keys(d.platforms||{})},Object.entries(d.platforms||{}).forEach(([f,u])=>{L[f]={id:f,name:u.name,defaultCategory:c,data:u}})}));let r={};Object.values(e).forEach(c=>{Object.entries(c.platforms||{}).forEach(([d,f])=>{r[d]=f})});let s={},o=t.hiddenDefaultCategories||[],n=t.categoryOrder||Object.keys(e),i=t.customCategories||[],l=t.platformOrder||{};return n.forEach(c=>{if(o.includes(c))return;let d=i.find(f=>f.id===c);if(d){let f={};(d.platforms||[]).forEach(u=>{r[u]&&(f[u]=r[u])}),s[c]={name:d.name,icon:"\u{1F4F1}",platforms:f}}else if(e[c]){let f=e[c],u=l[c];if(u&&u.length>0){let m=[],g=new Set;u.forEach(b=>{f.platforms&&f.platforms[b]&&(m.push(b),g.add(b))});let p=[],h=[];Object.keys(f.platforms||{}).forEach(b=>{g.has(b)||(String(b||"").startsWith("rss-")?p.push(b):h.push(b))});let y=p.concat(m,h),_={};y.forEach(b=>{f.platforms&&f.platforms[b]&&(_[b]=f.platforms[b])}),s[c]={...f,platforms:_}}else s[c]=f}}),Object.keys(e).forEach(c=>{!s[c]&&!o.includes(c)&&(s[c]=e[c])}),s}};window.openCategorySettings=()=>A.openCategorySettings();window.closeCategorySettings=()=>A.closeCategorySettings();window.saveCategorySettings=()=>A.saveCategorySettings();window.cancelCategorySettings=()=>A.cancelCategorySettings();window.showAddCategoryPanel=()=>A.showAddCategoryPanel();window.editCategory=e=>A.editCategory(e);window.cancelEditCategory=()=>A.cancelEditCategory();window.saveCategory=()=>A.saveCategory();window.deleteCategory=e=>A.deleteCategory(e);window.resetCategoryConfig=()=>A.resetCategoryConfig();window.toggleCategoryVisibility=e=>A.toggleCategoryVisibility(e);window.toggleCategoryListCollapseInSettings=()=>A.toggleCategoryListCollapseInSettings();window.toggleAllCategoriesOffInSettings=e=>A.toggleAllCategoriesOffInSettings(e);window.togglePlatformSelect=e=>A.togglePlatformSelect(e);window.bulkSelectPlatforms=e=>A.bulkSelectPlatforms(e);window.setPlatformSearchQuery=e=>A.setPlatformSearchQuery(e);a.settings=A;v(function(){let e=A.getCategoryConfig();e&&A.syncConfigToCookie(e)});var St="trendradar_filter_keywords",wt="trendradar_filter_mode_v1",K=[],ve="exclude";function _e(e){return e==="include"?"include":"exclude"}var X={normalizeFilterMode:_e,getCategoryFilterConfig(e){if(!e)return{mode:"exclude",keywords:[]};let t=a.settings.getMergedCategoryConfig(),r=t.categoryFilters&&t.categoryFilters[e],s=_e(r&&r.mode),o=Array.isArray(r&&r.keywords)?r.keywords:[];return{mode:s,keywords:o.map(n=>String(n||"").trim().toLowerCase()).filter(Boolean)}},applyCategoryFilter(e){let t=document.getElementById(`tab-${e}`);if(!t)return;let r=this.getCategoryFilterConfig(e),s=r.mode,o=r.keywords,n=`${s}|${o.join(",")}`,l=(t.dataset?t.dataset.filterSig:null)!==n;t.dataset&&(t.dataset.filterSig=n);let c=t.dataset&&t.dataset.bulkLoading==="1";if(t.querySelectorAll(".news-item").forEach(d=>{let f=(d.textContent||"").toLowerCase(),u=o.length>0?o.some(g=>f.includes(g)):!1;(o.length===0?!1:s==="include"?!u:u)?d.classList.add("filtered"):d.classList.remove("filtered")}),s!=="include"&&t.querySelectorAll(".platform-card").forEach(d=>{d.classList.remove("platform-empty-hidden")}),s==="include"){if(o.length>0)try{if(l&&!c){if(t.querySelectorAll(".platform-card").forEach(d=>{d?.dataset&&(d.dataset.loadedDone="0")}),a.infiniteScroll&&typeof a.infiniteScroll.scheduleBulkLoadCategory=="function")a.infiniteScroll.scheduleBulkLoadCategory(e,{pageSize:40});else if(a.infiniteScroll&&typeof a.infiniteScroll.scheduleEnsureCategoryLoaded=="function"){let d=t.querySelectorAll(".platform-card").length;a.infiniteScroll.scheduleEnsureCategoryLoaded(e,{cap:d,maxPagesPerCard:2})}}}catch{}t.querySelectorAll(".platform-card").forEach(d=>{let f=d?.dataset?.loadedDone==="1",u=!f||d?.dataset?.loading==="1";if(o.length>0&&u){d.classList.add("platform-empty-hidden");return}d.classList.remove("platform-empty-hidden"),d.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length<=0&&f&&d.classList.add("platform-empty-hidden")})}try{let d=t.querySelector(".category-empty-state");if(d)if(s==="include"&&o.length>0){let f=Array.from(t.querySelectorAll(".platform-card")),u=f.length>0&&f.every(g=>g?.dataset?.loadedDone==="1"&&g?.dataset?.loading!=="1"),m=t.querySelectorAll(".platform-card:not(.platform-empty-hidden)").length;d.style.display=u&&m===0?"block":"none"}else d.style.display="none"}catch{}a.counts.updateAllCounts(),a.paging&&typeof a.paging.scheduleAutofillActiveTab=="function"&&a.paging.scheduleAutofillActiveTab()},applyCategoryFilterForActiveTab(){let t=document.querySelector(".category-tabs .category-tab.active")?.dataset?.category;t&&this.applyCategoryFilter(t)},setCategoryFilterEditorState(e,t){ve=_e(e),K=(Array.isArray(t)?t:[]).map(o=>String(o||"").trim().toLowerCase()).filter(Boolean);let r=document.getElementById("categoryFilterModeToggle");r&&(r.checked=ve==="include");let s=document.getElementById("categoryFilterInput");s&&(s.value=""),this.renderCategoryFilterTags()},handleCategoryFilterModeToggle(e){ve=e&&e.checked?"include":"exclude"},handleCategoryFilterKeypress(e){e.key==="Enter"&&this.addCategoryFilterKeyword()},addCategoryFilterKeyword(){let e=document.getElementById("categoryFilterInput"),t=(e?.value||"").trim().toLowerCase();t&&(K.includes(t)||(K.push(t),this.renderCategoryFilterTags()),e&&(e.value=""))},removeCategoryFilterKeyword(e){K=K.filter(t=>t!==e),this.renderCategoryFilterTags()},renderCategoryFilterTags(){let e=document.getElementById("categoryFilterTags");e&&(e.innerHTML=K.map(t=>`<span class="filter-tag">${w(t)}<span class="filter-remove" onclick="removeCategoryFilterKeyword('${w(t)}')">\xD7</span></span>`).join(""))},getEditingFilterState(){return{mode:ve,keywords:[...K]}},migrateLegacyGlobalFilter(){let e=S.getRaw(St),t=S.getRaw(wt);if(!e&&!t)return;let r=[];try{r=e?JSON.parse(e):[]}catch{r=[]}Array.isArray(r)||(r=[]),r=r.map(l=>String(l||"").trim().toLowerCase()).filter(Boolean);let s=_e(t),o=a.settings.getCategoryConfig()||a.settings.getDefaultCategoryConfig();a.settings.ensureCategoryFilters(o),(a.settings.getMergedCategoryConfig().categoryOrder||[]).forEach(l=>{o.categoryFilters[l]||(o.categoryFilters[l]={mode:s,keywords:[...r]})}),a.settings.saveCategoryConfig(o),S.remove(St),S.remove(wt)}};window.handleCategoryFilterModeToggle=e=>X.handleCategoryFilterModeToggle(e);window.handleCategoryFilterKeypress=e=>X.handleCategoryFilterKeypress(e);window.addCategoryFilterKeyword=()=>X.addCategoryFilterKeyword();window.removeCategoryFilterKeyword=e=>X.removeCategoryFilterKeyword(e);a.filter=X;v(function(){X.migrateLegacyGlobalFilter(),X.applyCategoryFilterForActiveTab()});var ce="trendradar_active_tab",ee={TAB_STORAGE_KEY:ce,switchTab(e){a.badges.dismissNewCategoryBadge(e);let t=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(String(e)):String(e),r=document.querySelector(`.category-tab[data-category="${t}"]`),s=document.getElementById(`tab-${e}`);if(!r||!s){let o=document.querySelector(".category-tab");o?.dataset?.category&&o.dataset.category!==String(e)?this.switchTab(o.dataset.category):S.remove(ce);return}document.querySelectorAll(".category-tab").forEach(o=>o.classList.remove("active")),r.classList.add("active"),document.querySelectorAll(".tab-pane").forEach(o=>o.classList.remove("active")),s.classList.add("active"),S.setRaw(ce,e),a.scroll.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:e}),e==="sports"&&(a.badges.markFeatureSeen("sports-nba-schedule"),a.badges.updateNewBadges()),a.filter.applyCategoryFilter(e),a.paging&&typeof a.paging.scheduleAutofillActiveTab=="function"&&a.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1});try{let o=!!s.querySelector(".news-item"),n=!!s.querySelector(".news-placeholder");!o&&n&&(a.infiniteScroll&&typeof a.infiniteScroll.scheduleBulkLoadCategory=="function"?a.infiniteScroll.scheduleBulkLoadCategory(e):a.infiniteScroll&&typeof a.infiniteScroll.scheduleEnsureCategoryLoaded=="function"&&a.infiniteScroll.scheduleEnsureCategoryLoaded(e))}catch{}},restoreActiveTab(){let e=S.getRaw(ce);e&&document.querySelector(`.category-tab[data-category="${e}"]`)&&this.switchTab(e)},getActiveTabId(){return S.getRaw(ce)||document.querySelector(".category-tab.active")?.dataset?.category||null},restoreActiveTabPlatformGridScroll(e){a.scroll.restoreActiveTabPlatformGridScroll(e)},attachPlatformGridScrollPersistence(){a.scroll.attachPlatformGridScrollPersistence()}};window.switchTab=e=>ee.switchTab(e);a.tabs=ee;v(function(){ee.restoreActiveTab(),ee.attachPlatformGridScrollPersistence();let e=ee.getActiveTabId();e&&ee.restoreActiveTabPlatformGridScroll({preserveScroll:!0,activeTab:e})});var Ie="trendradar_active_tab",bt=20,Ne=!1,Ct=0,te=null,Ee={formatUpdatedAt:ae,snapshotViewerState(){let e=S.getRaw(Ie)||document.querySelector(".category-tab.active")?.dataset?.category||null,t={};document.querySelectorAll(".platform-card").forEach(i=>{let l=i.dataset.platform;l&&(t[l]=parseInt(i.dataset.pageOffset||"0",10)||0)});let r=e?document.querySelector(`#tab-${e} .platform-grid`):null,s=r&&r.scrollLeft||0,o=null,n=0;if(r){let i=r.scrollLeft||0,l=null,c=r.querySelectorAll(".platform-card");for(let d of c)if((d.offsetLeft||0)<=i+1)l=d;else break;l?.dataset?.platform&&(o=l.dataset.platform,n=Math.max(0,i-(l.offsetLeft||0)))}return e&&r&&a.scroll.recordPlatformGridScrollForTab(e,r),{activeTab:e,pagingOffsets:t,activeTabPlatformGridScrollLeft:s,activeTabPlatformAnchorPlatformId:o,activeTabPlatformAnchorOffsetX:n,showReadMode:document.body.classList.contains("show-read-mode"),scrollY:window.scrollY||0,searchText:document.getElementById("searchInput")?.value||""}},renderViewerFromData(e,t){let r=document.querySelector(".tab-content-area"),s=document.querySelector(".category-tabs");if(!s||!r)return;let o=a.settings.applyCategoryConfigToData(e?.categories||{}),n=t&&typeof t.activeTab=="string"?t.activeTab:null,i=Object.keys(o||{})[0]||null,l=n||i,c=Object.entries(o).map(([h,y])=>{let _=w(y?.icon||""),b=w(y?.name||h),M=`${y?.is_new?`<span class="new-badge new-badge-category" data-category="${w(h)}">NEW</span>`:""}${h==="sports"?'<span class="new-badge" id="newBadgeSportsTab" style="display:none;">NEW</span>':""}`;return`
            <div class="category-tab" data-category="${w(h)}" draggable="false" onclick="switchTab('${w(h)}')">
                <span class="category-drag-handle" title="\u62D6\u62FD\u8C03\u6574\u680F\u76EE\u987A\u5E8F" draggable="true">\u2630</span>
                <div class="category-tab-icon">${_}</div>
                <div class="category-tab-name">${b}${M}</div>
            </div>`}).join(""),d=Object.entries(o).map(([h,y])=>{let _=!!l&&String(h)===String(l),b=y?.platforms||{},T=Object.entries(b).map(([E,M])=>{let D=w(M?.name||E),Q=M?.is_new?`<span class="new-badge new-badge-platform" data-platform="${w(E)}">NEW</span>`:"",Ze=Array.isArray(M?.news)?M.news:[],et=Ze.length,tt=_?Math.min(et,bt):0,rt=E&&t?.pagingOffsets&&Number.isFinite(t.pagingOffsets[E])?t.pagingOffsets[E]:0,Zt=Ze.slice(0,tt).map((B,Me)=>{let er=w(B?.stable_id||""),st=w(B?.display_title||B?.title||""),tr=w(B?.url||""),ot=w(B?.meta||""),rr=String(E||"").startsWith("rss-"),nt=!!B?.is_cross_platform,sr=Array.isArray(B?.cross_platforms)?B.cross_platforms:[],or=w(sr.join(", ")),nr=w(B?.cross_platform_count??""),ar=nt?`<span class="cross-platform-badge" title="\u540C\u65F6\u51FA\u73B0\u5728: ${or}">\u{1F525} ${nr}</span>`:"",ir=nt?"cross-platform":"",lr=`<span class="news-index">${String(Me+1)}</span>`,cr=Me<rt||Me>=rt+bt?" paged-hidden":"",dr=ot&&!rr?`<div class="news-subtitle">${ot}</div>`:"";return`
                        <li class="news-item${cr}" data-news-id="${er}" data-news-title="${st}">
                            <div class="news-item-content">
                                <input type="checkbox" class="news-checkbox" onchange="markAsRead(this)" title="\u6807\u8BB0\u5DF2\u8BFB">
                                ${lr}
                                <a class="news-title ${ir}" href="${tr||"#"}" target="_blank" rel="noopener noreferrer" onclick="handleTitleClickV2(this, event)" onauxclick="handleTitleClickV2(this, event)" oncontextmenu="handleTitleClickV2(this, event)" onkeydown="handleTitleKeydownV2(this, event)">
                                    ${st}
                                    ${ar}
                                </a>
                            </div>
                            ${dr}
                        </li>`}).join("")||(_?"":'<li class="news-placeholder" aria-hidden="true">\u5F85\u52A0\u8F7D...</li>');return`
                <div class="platform-card" data-platform="${w(E)}" data-total-count="${String(et)}" data-loaded-count="${String(tt)}" draggable="false">
                    <div class="platform-header">
                        <span class="platform-drag-handle" title="\u62D6\u62FD\u8C03\u6574\u5E73\u53F0\u987A\u5E8F" draggable="true">\u2630</span>
                        <div class="platform-name" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; cursor: pointer;" onclick="dismissNewPlatformBadge('${w(E)}')">\u{1F4F1} ${D}${Q}</div>
                        <div class="platform-header-actions"></div>
                    </div>
                    <ul class="news-list">${Zt}
                    </ul>
                    <div class="news-load-sentinel" aria-hidden="true"></div>
                </div>`}).join("");return`
            <div class="tab-pane" id="tab-${w(h)}">
                <div class="platform-grid">${T}
                </div>
                <div class="category-empty-state" style="display:none;" aria-hidden="true">\u6CA1\u6709\u5339\u914D\u5185\u5BB9\uFF0C\u8BF7\u8C03\u6574\u5173\u952E\u8BCD\u6216\u5207\u6362\u6A21\u5F0F</div>
            </div>`}).join("");s.innerHTML=c,r.innerHTML=d;try{let h=s.querySelectorAll(".category-tab").length;s.classList.toggle("compact",h>8)}catch{}let f=document.getElementById("updatedAt");f&&e?.updated_at&&(f.textContent=ae(e.updated_at));let u=t&&typeof t.activeTab=="string"?t.activeTab:null;if(u){let h=window.CSS&&typeof window.CSS.escape=="function"?window.CSS.escape(u):u;if(document.querySelector(`.category-tab[data-category="${h}"]`))a.tabs.switchTab(u);else{let _=document.querySelector(".category-tab");_?.dataset?.category?a.tabs.switchTab(_.dataset.category):S.remove(Ie)}}else{let h=document.querySelector(".category-tab");h?.dataset?.category?a.tabs.switchTab(h.dataset.category):S.remove(Ie)}let m=typeof t?.showReadMode=="boolean"?t.showReadMode:a.readState.getShowReadModePref();a.readState.applyShowReadMode(m);let g=document.getElementById("searchInput");g&&typeof t?.searchText=="string"&&(g.value=t.searchText),a.search.searchNews(),a.filter.applyCategoryFilterForActiveTab(),a.readState.restoreReadState(),document.querySelectorAll(".platform-card").forEach(h=>{let y=h.dataset.platform,_=y&&t?.pagingOffsets&&Number.isFinite(t.pagingOffsets[y])?t.pagingOffsets[y]:0;a.paging.setCardPageSize(h,a.paging.PAGE_SIZE),a.paging.applyPagingToCard(h,_)}),a.counts.updateAllCounts(),a.readState.updateReadCount(),a.scroll.restoreActiveTabPlatformGridScroll(t),a.scroll.attachPlatformGridScrollPersistence();let p=document.getElementById("early-hide");p&&p.remove(),document.body.classList.add("categories-ready"),a.paging.scheduleAutofillActiveTab({force:!0,maxSteps:1});try{a.infiniteScroll&&typeof a.infiniteScroll.attach=="function"&&a.infiniteScroll.attach()}catch{}},async refreshViewerData(e={}){let t=e.preserveScroll!==!1;if(Ne){te?te.preserveScroll=te.preserveScroll&&t:te={preserveScroll:t};return}Ne=!0;try{let r=this.snapshotViewerState();r.preserveScroll=t;let n=await(await fetch("/api/news")).json();try{let i=a.subscription?.getSubscriptions?a.subscription.getSubscriptions():[];if(Array.isArray(i)&&i.length>0){let c=i.slice(0,25),d=c.map(h=>String(h?.source_id||h?.rss_source_id||"").trim()).filter(Boolean);if(d.length>0)try{fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:d,priority:"normal"})}).catch(()=>{})}catch{}let f=!!(a.subscription&&a.subscription._serverEnabled===!0),g=await fetch(f?"/api/subscriptions/rss-news?mode=server":"/api/subscriptions/rss-news?mode=auto",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f?{}:{subscriptions:c})}),p=await g.json();if(g.ok&&p&&typeof p=="object"){let h=n&&typeof n=="object"&&n.categories?n.categories:{},y=p&&typeof p=="object"&&p.categories?p.categories:{};n={...n,categories:{...h,...y}}}}}catch(i){console.error("rss merge error:",i)}this.renderViewerFromData(n,r),r.preserveScroll&&(window.scrollTo({top:r.scrollY,behavior:"auto"}),a.scroll.restoreActiveTabPlatformGridScroll(r)),Ct=Date.now()}catch(r){console.error("refreshViewerData error:",r)}finally{Ne=!1;let r=te;te=null,r&&this.refreshViewerData({preserveScroll:r.preserveScroll})}},async fetchData(){let e=document.getElementById("fetchBtn"),t=document.getElementById("progressContainer"),r=document.getElementById("progressBar"),s=document.getElementById("fetchStatus");e.classList.add("loading"),e.disabled=!0,t.classList.add("show"),r.classList.add("indeterminate"),s.className="fetch-status",s.textContent="\u6B63\u5728\u83B7\u53D6\u6570\u636E...";try{let n=await(await fetch("/api/fetch",{method:"POST"})).json();r.classList.remove("indeterminate"),n.success?(r.style.width="100%",s.className="fetch-status success",s.textContent=`\u2705 ${n.platforms} \u4E2A\u5E73\u53F0\uFF0C${n.news_count} \u6761\u65B0\u95FB`,setTimeout(()=>this.refreshViewerData({preserveScroll:!0}),300)):(r.style.width="0%",s.className="fetch-status error",s.textContent=`\u274C ${n.error}`)}catch(o){r.classList.remove("indeterminate"),r.style.width="0%",s.className="fetch-status error",s.textContent=`\u274C ${o.message}`}finally{e.classList.remove("loading"),e.disabled=!1,setTimeout(()=>{t.classList.remove("show"),r.style.width="0%"},5e3)}},setupAjaxAutoRefresh(){setInterval(()=>{document.visibilityState!=="visible"||Date.now()-Ct<295e3||this.refreshViewerData({preserveScroll:!0})},5e3),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&this.refreshViewerData({preserveScroll:!0})})}};window.fetchData=()=>Ee.fetchData();window.refreshViewerData=e=>Ee.refreshViewerData(e);a.data=Ee;v(function(){let e=document.getElementById("updatedAt");e&&e.textContent&&(e.textContent=ae(e.textContent)),Ee.setupAjaxAutoRefresh()});var Ae=20,Cr="240px 0px 240px 0px",P=40,de=null,$e=!1,ue=0,vr=1,vt=0,_r=600,Te=null,fe=null,Er=160,Le=null,ge=null,Ar=250;function Tr(){return document.querySelector(".category-tabs .category-tab.active")?.dataset?.category||null}function je(e,t){try{let r=e?.querySelector?.(".news-list");if(!r)return;let s=r.querySelector(".news-placeholder");s||(s=document.createElement("li"),s.className="news-placeholder",s.setAttribute("aria-hidden","true"),r.appendChild(s)),s.textContent=String(t||"")}catch{}}function _t(){if(clearTimeout(Te),Te=null,fe){try{fe.abort()}catch{}fe=null}try{document.querySelectorAll(".platform-card").forEach(e=>{let t=e?.querySelector?.(".news-list");if(!t)return;let r=t.querySelector(".news-placeholder");!r||t.querySelectorAll(".news-item").length>0||(r.textContent||"").includes("\u52A0\u8F7D\u4E2D")&&(r.textContent="\u5F85\u52A0\u8F7D...")})}catch{}}function Lr(e,t={}){_t(),fe=new AbortController;let r=fe.signal;Te=setTimeout(()=>{Te=null,Tt(e,{...t,signal:r}).catch(()=>{})},Er)}function Et(){if(clearTimeout(Le),Le=null,ge){try{ge.abort()}catch{}ge=null}}function xr(e,t,r){let s=document.createElement("li");s.className="news-item",s.dataset.newsId=String(e?.stable_id||""),s.dataset.newsTitle=String(e?.display_title||e?.title||"");let o=document.createElement("div");o.className="news-item-content";let n=document.createElement("input");n.type="checkbox",n.className="news-checkbox",n.title="\u6807\u8BB0\u5DF2\u8BFB",n.addEventListener("change",()=>{try{window.markAsRead(n)}catch{}});let i=document.createElement("span");i.className="news-index",i.textContent=String(t);let l=document.createElement("a");if(l.className="news-title",e?.is_cross_platform&&l.classList.add("cross-platform"),l.href=String(e?.url||"#"),l.target="_blank",l.rel="noopener noreferrer",l.setAttribute("onclick","handleTitleClickV2(this, event)"),l.setAttribute("onauxclick","handleTitleClickV2(this, event)"),l.setAttribute("oncontextmenu","handleTitleClickV2(this, event)"),l.setAttribute("onkeydown","handleTitleKeydownV2(this, event)"),l.textContent=String(e?.display_title||e?.title||""),e?.is_cross_platform){let f=Array.isArray(e?.cross_platforms)?e.cross_platforms:[],u=document.createElement("span");u.className="cross-platform-badge",u.title=`\u540C\u65F6\u51FA\u73B0\u5728: ${f.join(", ")}`,u.textContent=`\u{1F525} ${String(e?.cross_platform_count??"")}`,l.appendChild(document.createTextNode(" ")),l.appendChild(u)}o.appendChild(n),o.appendChild(i),o.appendChild(l),s.appendChild(o);let c=String(e?.meta||"").trim(),d=String(r||"").startsWith("rss-");if(c&&!d){let f=document.createElement("div");f.className="news-subtitle",f.textContent=c,s.appendChild(f)}return xt(s),Lt(s),s}async function At(e,t={}){let r=document.getElementById(`tab-${e}`);if(!r||!r.classList.contains("active"))return;try{r.dataset&&(r.dataset.bulkLoading="1")}catch{}let s=t.signal;if(s?.aborted){try{r.dataset&&delete r.dataset.bulkLoading}catch{}return}let o=null;try{a.filter&&typeof a.filter.getCategoryFilterConfig=="function"&&(o=a.filter.getCategoryFilterConfig(e))}catch{o=null}let n=o?.mode||"exclude",i=Array.isArray(o?.keywords)?o.keywords:[],l=Number.isFinite(t.pageSize)?t.pageSize:P,c=Math.min(Math.max(1,l),P),d=Array.from(r.querySelectorAll(".platform-card")),f=d.map(g=>(g?.dataset?.platform||"").trim()).filter(Boolean);if(f.length<=0){try{r.dataset&&delete r.dataset.bulkLoading}catch{}return}for(let g of d)g&&(g.dataset.loading="1",je(g,"\u52A0\u8F7D\u4E2D..."));let u;try{let g=await fetch(`/api/news/pages?page_size=${encodeURIComponent(String(c))}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({platform_ids:f}),signal:s});if(!g.ok)return;u=await g.json()}catch{return}finally{try{r.dataset&&delete r.dataset.bulkLoading}catch{}}let m=u&&u.platforms||{};for(let g of d){if(s?.aborted)return;let p=(g?.dataset?.platform||"").trim();if(!p)continue;let h=g.querySelector(".news-list");if(!h)continue;h.querySelectorAll(".news-placeholder").forEach(T=>T.remove()),h.querySelectorAll(".news-item").forEach(T=>T.remove());let y=m[p]||{},_=Array.isArray(y.items)?y.items:[];for(let T=0;T<_.length;T++)h.appendChild(xr(_[T],T+1,p));let b=h.querySelectorAll(".news-item").length;g.dataset.loadedCount=String(b),g.dataset.hasMore=y.has_more&&b<P?"1":"0",g.dataset.loading="0",g.dataset.loadedDone="1";try{if(a.paging){let T=Math.min(P,b);a.paging.setCardPageSize(g,T),a.paging.applyPagingToCard(g,0)}}catch{}a.counts?.updatePlatformCount&&a.counts.updatePlatformCount(g)}a.counts?.updateAllCounts&&a.counts.updateAllCounts();try{a.filter&&typeof a.filter.applyCategoryFilter=="function"&&a.filter.applyCategoryFilter(e)}catch{}}function kr(e,t={}){Et(),ge=new AbortController;let r=ge.signal;Le=setTimeout(()=>{Le=null,At(e,{...t,signal:r}).catch(()=>{})},Ar)}async function Tt(e,t={}){let r=document.getElementById(`tab-${e}`);if(!r||!r.classList.contains("active"))return;let s=t.signal;if(s?.aborted)return;let o=null;try{a.filter&&typeof a.filter.getCategoryFilterConfig=="function"&&(o=a.filter.getCategoryFilterConfig(e))}catch{o=null}let n=o?.mode||"exclude",i=Array.isArray(o?.keywords)?o.keywords:[],l=n==="include"&&i.length>0,c=Number.isFinite(t.maxPagesPerCard)?t.maxPagesPerCard:l?2:1,d=Number.isFinite(t.cap)?t.cap:l?10:4,f=Array.from(r.querySelectorAll(".platform-card")).slice(0,Math.max(0,d));for(let u of f){if(s?.aborted)return;if(!u)continue;let m=u.querySelector(".news-list");if(!m)continue;let g=m.querySelectorAll(".news-item").length;if(l&&g>0){u.dataset.loadedDone="1";continue}if(!l&&g>0){u.dataset.loadedDone="1";continue}let p=Ae;for(let h=0;h<c;h++){if(s?.aborted)return;je(u,"\u52A0\u8F7D\u4E2D..."),await kt(u,Math.min(p,P),{signal:s});try{a.paging&&(a.paging.setCardPageSize(u,Math.min(p,P)),a.paging.applyPagingToCard(u,0))}catch{}let y=u.querySelectorAll(".news-item:not(.filtered):not(.search-hidden):not(.paged-hidden)").length;if(!l||y>0||!(u.dataset.hasMore!=="0"))break;p+=Ae}u.dataset.loadedDone="1"}a.counts?.updateAllCounts&&a.counts.updateAllCounts();try{a.filter&&typeof a.filter.applyCategoryFilter=="function"&&a.filter.applyCategoryFilter(e)}catch{}}function Lt(e){try{let t=Tr();if(!t||!a.filter?.getCategoryFilterConfig)return;let r=a.filter.getCategoryFilterConfig(t),s=r?.mode||"exclude",o=Array.isArray(r?.keywords)?r.keywords:[],n=(e?.textContent||"").toLowerCase(),i=o.length>0?o.some(c=>n.includes(c)):!1;(o.length===0?!1:s==="include"?!i:i)?e.classList.add("filtered"):e.classList.remove("filtered")}catch{}}function xt(e){try{let t=e?.dataset?.newsId;if(!t||!a.readState?.getReadNews||!(a.readState.getReadNews()||{})[t])return;e.classList.add("read");let s=e.querySelector(".news-checkbox");s&&(s.checked=!0)}catch{}}async function kt(e,t,r={}){let s=(e?.dataset?.platform||"").trim();if(!s)return{ok:!1,hasMore:!1};let o=r.signal;if(o?.aborted)return{ok:!1,hasMore:!0};if(e.dataset.loading==="1")return{ok:!1,hasMore:!0};if(e.dataset.hasMore==="0")return{ok:!1,hasMore:!1};let n=e.querySelector(".news-list");if(!n)return{ok:!1,hasMore:!1};n.querySelectorAll(".news-placeholder").forEach(l=>l.remove()),t=Math.min(Math.max(0,t||0),P);let i=n.querySelectorAll(".news-item").length;if(i>=P)return e.dataset.hasMore="0",{ok:!1,hasMore:!1};if(i>=t)return{ok:!0,hasMore:!0};e.dataset.loading="1";try{if(ue>=vr)return{ok:!1,hasMore:!0};ue+=1;let l=Math.min(Ae,Math.max(0,P-i));if(l<=0)return e.dataset.hasMore="0",{ok:!1,hasMore:!1};let c=`/api/news/page?platform_id=${encodeURIComponent(s)}&offset=${encodeURIComponent(String(i))}&page_size=${encodeURIComponent(String(l))}`,d;try{d=await fetch(c,{signal:o})}catch(g){if(o?.aborted||g&&g.name==="AbortError")return e.querySelectorAll(".news-item").length<=0&&je(e,"\u5F85\u52A0\u8F7D..."),{ok:!1,hasMore:!0};throw g}if(!d.ok)return{ok:!1,hasMore:!0};let f=await d.json(),u=Array.isArray(f?.items)?f.items:[],m=!!f?.has_more;(!m||i+u.length>=P)&&(e.dataset.hasMore="0");for(let g=0;g<u.length;g++){let p=u[g]||{},h=i+g+1,y=document.createElement("li");y.className="news-item",y.dataset.newsId=String(p.stable_id||""),y.dataset.newsTitle=String(p.display_title||p.title||"");let _=document.createElement("div");_.className="news-item-content";let b=document.createElement("input");b.type="checkbox",b.className="news-checkbox",b.title="\u6807\u8BB0\u5DF2\u8BFB",b.addEventListener("change",()=>{try{window.markAsRead(b)}catch{}});let T=document.createElement("span");T.className="news-index",T.textContent=String(h);let E=document.createElement("a");if(E.className="news-title",p.is_cross_platform&&E.classList.add("cross-platform"),E.href=String(p.url||"#"),E.target="_blank",E.rel="noopener noreferrer",E.setAttribute("onclick","handleTitleClickV2(this, event)"),E.setAttribute("onauxclick","handleTitleClickV2(this, event)"),E.setAttribute("oncontextmenu","handleTitleClickV2(this, event)"),E.setAttribute("onkeydown","handleTitleKeydownV2(this, event)"),E.textContent=String(p.display_title||p.title||""),p.is_cross_platform){let D=Array.isArray(p.cross_platforms)?p.cross_platforms:[],Q=document.createElement("span");Q.className="cross-platform-badge",Q.title=`\u540C\u65F6\u51FA\u73B0\u5728: ${D.join(", ")}`,Q.textContent=`\u{1F525} ${String(p.cross_platform_count??"")}`,E.appendChild(document.createTextNode(" ")),E.appendChild(Q)}_.appendChild(b),_.appendChild(T),_.appendChild(E),y.appendChild(_);let M=String(p.meta||"").trim();if(M){let D=document.createElement("div");D.className="news-subtitle",D.textContent=M,y.appendChild(D)}n.appendChild(y),xt(y),Lt(y)}return e.dataset.loadedCount=String(n.querySelectorAll(".news-item").length),a.counts?.updatePlatformCount&&a.counts.updatePlatformCount(e),{ok:!0,hasMore:m}}finally{ue=Math.max(0,ue-1),e.dataset.loading="0"}}async function Rr(e){if(!e||!a.paging)return;let t=e.closest(".tab-pane");if(t&&!t.classList.contains("active"))return;let r=Date.now();if(r<vt)return;vt=r+_r;let s=parseInt(e.dataset.pageOffset||"0",10)||0,o=a.paging.getCardPageSize(e),n=Math.max(0,P-s);if(o>=n){e.dataset.hasMore="0";return}let i=Math.min(o+Ae,n),l=s+i;await kt(e,l);let c=e.querySelectorAll(".news-item").length,d=Math.min(Math.max(o,i),Math.max(c-s,o)),f=Math.min(d,n);a.paging.setCardPageSize(e,f),a.paging.applyPagingToCard(e,s),a.counts?.updateAllCounts&&a.counts.updateAllCounts()}function Rt(){if(de){try{de.disconnect()}catch{}de=null}de=new IntersectionObserver(e=>{for(let t of e){if(!t.isIntersecting||!$e||ue>0)continue;let s=t.target?.closest?.(".platform-card");s&&Rr(s).catch(()=>{})}},{root:null,rootMargin:Cr,threshold:.01}),document.querySelectorAll(".news-load-sentinel").forEach(e=>de.observe(e))}a.infiniteScroll={attach:Rt,ensureCategoryLoaded:Tt,scheduleEnsureCategoryLoaded:Lr,cancelEnsureCategoryLoaded:_t,bulkLoadCategory:At,scheduleBulkLoadCategory:kr,cancelBulkLoadCategory:Et};v(function(){try{window.addEventListener("scroll",()=>{$e=!0},{passive:!0,once:!0})}catch{}setTimeout(()=>{$e=!0},1200),Rt()});function Ge(e){let r=e?.closest?.(".tab-pane")?.id||"";return r.startsWith("tab-")?r.slice(4):null}function Pr(e,t){if(!e||!Array.isArray(t))return;let r=a.settings.getCategoryConfig()||a.settings.getDefaultCategoryConfig(),s=a.settings.normalizeCategoryConfig(r);if((a.settings.getMergedCategoryConfig().customCategories||[]).find(i=>i.id===e)){let i=(s.customCategories||[]).findIndex(l=>l.id===e);i>=0&&(s.customCategories[i]={...s.customCategories[i],platforms:t})}else(!s.platformOrder||typeof s.platformOrder!="object")&&(s.platformOrder={}),s.platformOrder[e]=t;a.settings.saveCategoryConfig(s)}var Pt={_draggingCard:null,_draggingPlatformId:null,_originGrid:null,_originCategoryId:null,_autoScrollRaf:null,_autoScrollGrid:null,_autoScrollDir:0,_autoScrollSpeed:0,attach(){if(this._attached)return;this._attached=!0;let e=40,t=18,r=()=>{this._autoScrollRaf&&cancelAnimationFrame(this._autoScrollRaf),this._autoScrollRaf=null,this._autoScrollGrid=null,this._autoScrollDir=0,this._autoScrollSpeed=0},s=()=>{if(this._autoScrollRaf)return;let n=()=>{if(!this._autoScrollGrid||!this._autoScrollDir||!this._autoScrollSpeed){r();return}let i=this._autoScrollGrid,l=Math.max(0,(i.scrollWidth||0)-(i.clientWidth||0));if(l<=0){r();return}let c=Math.max(0,Math.min(l,(i.scrollLeft||0)+this._autoScrollDir*this._autoScrollSpeed));i.scrollLeft=c,this._autoScrollRaf=requestAnimationFrame(n)};this._autoScrollRaf=requestAnimationFrame(n)},o=(n,i)=>{if(!this._draggingCard||!i){r();return}if(Math.max(0,(i.scrollWidth||0)-(i.clientWidth||0))<=0){r();return}let c=i.getBoundingClientRect(),d=n.clientX,f=d-c.left,u=c.right-d,m=0,g=0;if(f>=0&&f<=e)m=-1,g=f;else if(u>=0&&u<=e)m=1,g=u;else{r();return}let p=Math.max(0,Math.min(1,(e-g)/e)),h=Math.max(1,Math.round(p*p*t));this._autoScrollGrid=i,this._autoScrollDir=m,this._autoScrollSpeed=h,s()};document.addEventListener("dragstart",n=>{let i=n.target?.closest?.(".platform-drag-handle");if(!i)return;let l=i.closest(".platform-card"),c=i.closest(".platform-grid"),d=Ge(c),f=l?.dataset?.platform||null;if(!(!l||!c||!d||!f)){this._draggingCard=l,this._draggingPlatformId=f,this._originGrid=c,this._originCategoryId=d,l.classList.add("dragging"),n.dataTransfer.effectAllowed="move";try{n.dataTransfer.setData("text/plain",f)}catch{}}},!0),document.addEventListener("dragend",n=>{let i=n.target?.closest?.(".platform-drag-handle");if(!i)return;let l=i.closest(".platform-card"),c=i.closest(".platform-grid"),d=Ge(c);if(!l||!c||!d){this._draggingCard&&this._draggingCard.classList.remove("dragging"),this._draggingCard=null,this._draggingPlatformId=null,this._originGrid=null,this._originCategoryId=null,r();return}let f=Array.from(c.querySelectorAll(".platform-card")).map(u=>u.dataset.platform).filter(Boolean);Pr(d,f),l.classList.remove("dragging"),this._draggingCard=null,this._draggingPlatformId=null,this._originGrid=null,this._originCategoryId=null,r()},!0),document.addEventListener("dragover",n=>{let i=n.target?.closest?.(".platform-grid");if(!i||!this._draggingCard||this._originGrid&&i!==this._originGrid)return;let l=Ge(i);if(!l||this._originCategoryId&&l!==this._originCategoryId)return;n.preventDefault(),o(n,i);let c=n.target?.closest?.(".platform-card");if(!c||c===this._draggingCard)return;let d=Array.from(i.querySelectorAll(".platform-card")),f=d.indexOf(this._draggingCard),u=d.indexOf(c);f<0||u<0||f===u||(f<u?i.insertBefore(this._draggingCard,c.nextSibling):i.insertBefore(this._draggingCard,c))},!0),document.addEventListener("drop",n=>{let i=n.target?.closest?.(".platform-grid");!i||!this._draggingCard||this._originGrid&&i!==this._originGrid||(n.preventDefault(),r())},!0)}};a.platformReorder=Pt;v(()=>{Pt.attach()});function Or(e){return e?Array.from(e.querySelectorAll(".category-tab")).map(t=>String(t?.dataset?.category||"").trim()).filter(Boolean):[]}function Fr(e){if(!Array.isArray(e)||e.length===0)return;let t=a.settings.getCategoryConfig()||a.settings.getDefaultCategoryConfig(),r=a.settings.normalizeCategoryConfig(t),s=a.settings.getMergedCategoryConfig(),o=Array.isArray(s?.categoryOrder)&&s.categoryOrder.length>0?s.categoryOrder.slice():e.slice(),n=new Set(e),i=0,l=o.map(c=>{let d=String(c||"").trim();if(!d||!n.has(d))return d;let f=e[i];return i+=1,f});r.categoryOrder=l,a.settings.saveCategoryConfig(r)}function Mr(e){let t=document.querySelector(".tab-content-area");if(!t)return;let r=new Map;t.querySelectorAll(".tab-pane").forEach(o=>{let n=String(o?.id||"");n.startsWith("tab-")&&r.set(n.slice(4),o)});let s=document.createDocumentFragment();for(let o of e){let n=r.get(o);n&&s.appendChild(n)}for(let[o,n]of r.entries())e.includes(o)||s.appendChild(n);t.appendChild(s)}function Ot(){let e=document.querySelector(".category-tabs");e&&e.querySelectorAll(".category-tab").forEach(t=>{try{t.setAttribute("draggable","false");let r=t.querySelector(":scope > .category-drag-handle");r?r.setAttribute("draggable","true"):(r=document.createElement("span"),r.className="category-drag-handle",r.setAttribute("title","\u62D6\u62FD\u8C03\u6574\u680F\u76EE\u987A\u5E8F"),r.setAttribute("draggable","true"),r.textContent="\u2630",t.insertBefore(r,t.firstChild))}catch{}})}function Br(){let e=document.querySelector(".category-tabs");if(e)try{new MutationObserver(()=>{Ot()}).observe(e,{childList:!0,subtree:!0})}catch{}}function Dr(){let e=document.body;if(!e)return;let t=0,r=0,s=!1,o=()=>{t&&(window.clearTimeout(t),t=0),r&&(window.clearTimeout(r),r=0)},n=()=>{s=!1,e.classList.remove("category-tabs-drag-mode")};document.addEventListener("pointerdown",l=>{!l.target?.closest?.(".category-tabs")||!l.target?.closest?.(".category-tab")||l.target?.closest?.(".category-drag-handle")||(o(),t=window.setTimeout(()=>{s=!0,e.classList.add("category-tabs-drag-mode"),r=window.setTimeout(()=>{n()},2500)},380))},!0);let i=()=>{o(),s&&n()};document.addEventListener("pointerup",i,!0),document.addEventListener("pointercancel",i,!0),document.addEventListener("scroll",i,!0)}var Ft={_attached:!1,_draggingTab:null,_originTabsEl:null,attach(){this._attached||(this._attached=!0,Ot(),Br(),Dr(),document.addEventListener("click",e=>{e.target?.closest?.(".category-drag-handle")&&(e.preventDefault(),e.stopPropagation())},!0),document.addEventListener("dragstart",e=>{let t=e.target?.closest?.(".category-drag-handle");if(!t)return;let r=t.closest(".category-tab"),s=t.closest(".category-tabs"),o=r?.dataset?.category;if(!(!r||!s||!o)){this._draggingTab=r,this._originTabsEl=s,r.classList.add("dragging"),e.dataTransfer.effectAllowed="move";try{e.dataTransfer.setData("text/plain",String(o))}catch{}}},!0),document.addEventListener("dragover",e=>{let t=e.target?.closest?.(".category-tabs");if(!t||!this._draggingTab||this._originTabsEl&&t!==this._originTabsEl)return;let r=e.target?.closest?.(".category-tab");if(!r||r===this._draggingTab)return;e.preventDefault();let s=Array.from(t.querySelectorAll(".category-tab")),o=s.indexOf(this._draggingTab),n=s.indexOf(r);o<0||n<0||o===n||(o<n?t.insertBefore(this._draggingTab,r.nextSibling):t.insertBefore(this._draggingTab,r))},!0),document.addEventListener("drop",e=>{let t=e.target?.closest?.(".category-tabs");!t||!this._draggingTab||this._originTabsEl&&t!==this._originTabsEl||e.preventDefault()},!0),document.addEventListener("dragend",e=>{let t=e.target?.closest?.(".category-drag-handle");if(!t)return;let r=t.closest(".category-tabs");if(!r||!this._draggingTab){this._draggingTab&&this._draggingTab.classList.remove("dragging"),this._draggingTab=null,this._originTabsEl=null;return}let s=Or(r);Fr(s),Mr(s),this._draggingTab.classList.remove("dragging"),this._draggingTab=null,this._originTabsEl=null},!0))}};a.categoryTabReorder=Ft;v(()=>{Ft.attach()});var He="rss_subscriptions",R=null,G=null,J=!1,ye=!1,ze=!1,Fe=!1,Se=!1,H=new Map,j=new Set,$t=!1,xe="",ke="",qr=80,me=0,he=0,Ve=!1,F=[],Ue=0,pe=0,re=44,Mt=10,Y=0,Bt=0,Dt=new Map;function qt(e){return new Promise(t=>window.setTimeout(t,Math.max(0,e||0)))}function Ir(e){try{if(window.CSS&&typeof window.CSS.escape=="function")return window.CSS.escape(String(e||""))}catch{}return String(e||"").replace(/"/g,'\\"')}function Nr(e){let t=Array.isArray(e)?e:[];for(let r of t){let s=String(r||"").trim();if(!s)continue;let o=`rss-${s}`,n=`.platform-card[data-platform="${Ir(o)}"]`,i=document.querySelector(n);if(!i)continue;let l=i.querySelectorAll(".news-item");if(l&&l.length>0)return!0}return!1}function It(e,t){let r=Array.isArray(e)?e:[];for(let s of r){let o=String(s||"").trim();o&&(t?j.add(o):j.delete(o))}}function We(){return document.getElementById("rssSubscriptionModal")}function Xe(){return document.getElementById("rssSourcePickerModal")}function Ke(e){return(Array.isArray(e)?e:[]).filter(r=>r&&typeof r=="object").map(r=>({source_id:String(r.source_id||r.rss_source_id||"").trim(),url:String(r.url||"").trim(),feed_title:String(r.feed_title||r.display_name||"").trim(),column:String(r.column||"RSS").trim()||"RSS",platform_id:String(r.platform_id||"").trim()})).filter(r=>!!r.source_id)}async function jt({showHintOn403:e}={}){if(!ze){ze=!0;try{let t=await fetch("/api/me/rss-subscriptions");if(t.status===403){J=!1,ye=!0;try{we()}catch{}e&&x("\u672A\u5F00\u542F\u670D\u52A1\u7AEF\u540C\u6B65\uFF08Not allowlisted\uFF09\uFF0C\u5F53\u524D\u4F7F\u7528\u672C\u5730\u8BA2\u9605",{variant:"info"});return}let r=await t.json().catch(()=>({}));if(!t.ok){ye=!0,J=!1;return}let s=Ke(r?.subscriptions);ye=!0,J=!0;try{we()}catch{}try{k.setSubscriptions(s)}catch{}try{G=k.getSubscriptions()}catch{G=null}$(),z()}finally{ze=!1}}}function $r(){try{return document.querySelector("#rssSubscriptionModal .settings-btn-primary")}catch{return null}}function jr(){try{return document.querySelector('#rssSubscriptionModal button[onclick="previewRssSubscription()"]')}catch{return null}}function Re(e){let r=(Array.isArray(e)?e:[]).filter(s=>s&&typeof s=="object").map(s=>({source_id:String(s.source_id||s.rss_source_id||"").trim(),url:String(s.url||"").trim(),feed_title:String(s.feed_title||"").trim(),column:String(s.column||"RSS").trim()||"RSS"})).filter(s=>!!s.source_id||!!s.url).sort((s,o)=>(s.source_id||"").localeCompare(o.source_id||""));return JSON.stringify(r)}function Gt(e,t){let r=Array.isArray(e)?e:[],s=Array.isArray(t)?t:[],o=new Set(r.map(i=>String(i?.source_id||i?.rss_source_id||"").trim()).filter(Boolean)),n=[];for(let i of s){let l=String(i?.source_id||i?.rss_source_id||"").trim();l&&(o.has(l)||n.push(l))}return n}function Nt(e,t){if(e)try{t?e.removeAttribute("disabled"):e.setAttribute("disabled","true")}catch{}}function z(){let e=jr(),t=$r(),r=Ut();if(Nt(e,!!r),r){let d=H.get(String(r||"").trim());d&&d.ok===!0&&Number(d.entries_count||0)===0&&x("\u9884\u89C8\u6210\u529F\u4F46\u6682\u65E0\u6761\u76EE\uFF08entries=0\uFF09\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"info"})}let s=Array.isArray(G)?G:[],o=k.getSubscriptions(),n=Re(s)!==Re(o),l=Gt(s,o).every(d=>{let f=H.get(d);return!!f&&f.ok===!0&&Number(f.entries_count||0)>0});if(Nt(t,n&&l),!n){r&&(()=>{let d=H.get(String(r||"").trim());return d&&d.ok===!0&&Number(d.entries_count||0)===0})()||x("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58\u5E76\u5237\u65B0",{variant:"info"});return}if(!l){r&&(()=>{let d=H.get(String(r||"").trim());return d&&d.ok===!0&&Number(d.entries_count||0)===0})()||x("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"});return}x("",{variant:"info"})}async function Gr(e){let t=Pe();t&&(t.innerHTML='<div style="color:#6b7280;">\u9884\u89C8\u4E2D...</div>');let r=await fetch(`/api/rss-sources/preview?source_id=${encodeURIComponent(e)}`),s=await r.json();if(!r.ok)throw new Error(s?.detail||"Preview failed");let o=s?.data||{},n=o?.feed?.title||"",i=Array.isArray(o?.entries)?o.entries:[],l=i.length,c=i.slice(0,5).map(d=>{let f=w(d?.title||""),u=w(d?.link||"");return u?`<div style="font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><a href="${u}" target="_blank" rel="noopener noreferrer">${f||u}</a></div>`:`<div style="font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${f}</div>`}).join("");if(!Fe&&n&&(oe("rssFeedTitle",n),Se=!0),H.set(String(e||"").trim(),{ok:!0,entries_count:l,ts:Date.now()}),l>0)try{let f=(R?String(R.url||"").trim():"")||String(s?.final_url||s?.url||"").trim(),u=se("rssColumn")||"RSS",m=se("rssFeedTitle")||String(R?.name||R?.host||"").trim(),g=k.getSubscriptions(),p=g.findIndex(y=>y.source_id&&y.source_id===String(e||"").trim()),h={source_id:String(e||"").trim(),url:f,feed_title:m,column:u,platform_id:""};p>=0?g[p]=h:g.unshift(h),k.setSubscriptions(g),$()}catch{}else x("\u9884\u89C8\u6210\u529F\u4F46\u6682\u65E0\u6761\u76EE\uFF08entries=0\uFF09\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5",{variant:"info"});z(),t&&(t.innerHTML=`
            <div style="display:flex;flex-direction:column;gap:6px;">
                <div style="font-weight:800;">${w(n||"Feed")}</div>
                <div style="font-size:0.78rem;color:#6b7280;">\u6761\u76EE\u6570\uFF1A${i.length}</div>
                <div style="display:flex;flex-direction:column;gap:4px;">${c}</div>
            </div>`)}function Hr(){return document.getElementById("rssSubscriptionList")}function Pe(){return document.getElementById("rssSubscriptionPreview")}function zr(){return document.getElementById("rssSubscriptionSaveStatus")}function x(e,t={}){let r=zr();if(!r)return;let s=String(t.variant||"").toLowerCase(),o=s==="error"?"#dc2626":s==="success"?"#16a34a":"#6b7280";r.style.color=o,r.textContent=e==null?"":String(e)}function Ht(){return document.getElementById("rssSelectedSourceId")}function Vr(){return document.getElementById("rssSelectedSourceLabel")}function Ur(){return document.getElementById("rssRequestSection")}function Wr(){return document.getElementById("rssSourceCategoryList")}function zt(){return document.getElementById("rssSourceSearchInput")}function Vt(){return document.getElementById("rssSourceResults")}function Kr(){return document.getElementById("rssSourcePickerStatus")}function se(e){let t=document.getElementById(e);return t&&typeof t.value=="string"?t.value.trim():""}function oe(e,t){let r=document.getElementById(e);r&&(r.value=t==null?"":String(t))}function Ut(){let e=Ht();return e&&typeof e.value=="string"?e.value.trim():""}function Xr(e){R=e&&typeof e=="object"?e:null;let t=Ht(),r=Vr(),s=R?String(R.id||"").trim():"",o=R?String(R.name||R.host||s):"",n=R?String(R.url||"").trim():"";t&&(t.value=s),r&&(r.textContent=s?`${o}${n?` (${n})`:""}`:"\u672A\u9009\u62E9"),s&&!Fe&&(!se("rssFeedTitle")||Se)&&(oe("rssFeedTitle",o),Se=!0),s&&Wt(s),z()}function Wt(e){let t=String(e||"").trim();if(!t)return;let r=Date.now(),s=15e3,o=Dt.get(t)||0;r-o<s||(Dt.set(t,r),Y&&(window.clearTimeout(Y),Y=0),Y=window.setTimeout(async()=>{Y=0;let n=Date.now()-(Bt||0);if(n<400){Y=window.setTimeout(()=>{Y=0,Wt(t)},400-n);return}Bt=Date.now();try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:[t],priority:"high"})})}catch{}},300))}function Oe(e){let t=Kr();t&&(t.textContent=e==null?"":String(e))}async function Kt(){let e=await fetch("/api/rss-source-categories"),t=await e.json();if(!e.ok)throw new Error(t?.detail||"Failed to load categories");let r=Array.isArray(t?.categories)?t.categories:[],s=Wr();if(!s)return r;let o=r.map(n=>{let i=String(n?.id||""),l=String(n?.name||i||""),c=Number(n?.count||0),d=i===xe;return`
          <button type="button" class="platform-select-action-btn" data-cat="${w(i)}" style="justify-content:flex-start;${d?"background:#111827;color:#fff;border-color:#111827;":""}">
            ${w(l)} <span style="opacity:0.7;">(${c})</span>
          </button>`}).join("");return s.innerHTML=o,s.querySelectorAll("button[data-cat]").forEach(n=>{n.addEventListener("click",()=>{xe=String(n.getAttribute("data-cat")||""),Kt().catch(()=>{}),Ye({reset:!0})})}),r}async function Xt(e={}){let t=e.reset===!0;if(!Ve){Ve=!0;try{t&&(F=[],me=0,he=0),Oe("\u52A0\u8F7D\u4E2D...");let r=new URLSearchParams;ke&&r.set("q",ke),xe&&r.set("category",xe),r.set("limit",String(qr)),r.set("offset",String(me));let s=await fetch(`/api/rss-sources/search?${r.toString()}`),o=await s.json();if(!s.ok)throw new Error(o?.detail||"Search failed");let n=Array.isArray(o?.sources)?o.sources:[];he=Number(o?.total||0),t?F=n:F=F.concat(n),me=Number(o?.next_offset??me+n.length)||me+n.length,Yt();let l=F.length<he;Oe(`\u5DF2\u52A0\u8F7D ${F.length}/${he}${l?"\uFF08\u7EE7\u7EED\u6EDA\u52A8\u52A0\u8F7D\uFF09":""}`)}finally{Ve=!1}}}function Yt(){Ue||(Ue=window.requestAnimationFrame(()=>{Ue=0,Yr()}))}function Yr(){let e=Vt();if(!e)return;let t=e.scrollTop||0,r=e.clientHeight||360,s=F.length,o=s*re,n=Math.max(0,Math.floor(t/re)-Mt),i=Math.min(s,Math.ceil((t+r)/re)+Mt),l=e.querySelector(":scope > .rss-src-inner");l||(e.innerHTML='<div class="rss-src-inner" style="position:relative;width:100%;"></div>',l=e.querySelector(":scope > .rss-src-inner")),l.style.height=`${o}px`;let c=[];for(let f=n;f<i;f++){let u=F[f]||{},m=String(u.id||"").trim(),g=String(u.name||u.host||m),p=String(u.url||"");c.push(`<div class="rss-source-item" data-source-id="${w(m)}" style="position:absolute;left:0;right:0;top:${f*re}px;height:${re}px;padding:8px 10px;border-bottom:1px solid #f3f4f6;cursor:pointer;display:flex;align-items:center;gap:8px;">
              <div style="min-width:0;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                <span style="font-weight:700;font-size:0.9rem;color:#111827;">${w(g)}</span>
                <span style="font-weight:400;font-size:0.75rem;color:#9ca3af;"> â€” </span>
                <span style="font-weight:400;font-size:0.72rem;color:#6b7280;">${w(p)}</span>
              </div>
            </div>`)}l.innerHTML=c.join(""),l.querySelectorAll(".rss-source-item[data-source-id]").forEach(f=>{f.addEventListener("click",()=>{let u=String(f.getAttribute("data-source-id")||"").trim(),m=F.find(g=>g&&String(g.id||"").trim()===u)||null;Xr(m),Je()})}),t+r>=o-re*6&&F.length<he&&Xt({reset:!1}).catch(f=>{Oe(f?.message||String(f))})}function Ye(e={}){let t=e.reset!==!1;Xt({reset:t}).catch(r=>{Oe(r?.message||String(r))})}function Jr(){let e=Xe();if(!e)return;$t=!0,e.classList.add("show");let t=zt();t&&(t.value=ke,t.focus()),Kt().catch(()=>{}),Ye({reset:!0})}function Je(){let e=Xe();e&&($t=!1,e.classList.remove("show"))}function $(){let e=Hr();if(!e)return;let t=k.getSubscriptions();if(!t.length){e.innerHTML='<div style="color:#6b7280;font-size:0.85rem;">\u6682\u65E0\u8BA2\u9605</div>';return}let r=t.map((s,o)=>{let n=String(s?.source_id||s?.rss_source_id||"").trim(),i=w(s.url||""),l=w(s.feed_title||""),c=w(s.column||"RSS"),d=l?`${l}`:i,f=n&&j.has(n);return`
            <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb;">
                <div style="min-width:0;flex:1;">
                    <div style="display:flex;gap:8px;align-items:baseline;">
                        <div style="min-width:0;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                            <span style="font-weight:700;font-size:0.9rem;color:#111827;">${d}</span>
                            ${f?'<span style="margin-left:8px;font-weight:400;font-size:0.75rem;color:#9ca3af;">\u540C\u6B65\u4E2D...</span>':""}
                            <span style="font-weight:400;font-size:0.75rem;color:#9ca3af;"> \u2014 </span>
                            <span style="font-weight:400;font-size:0.72rem;color:#6b7280;">${i}</span>
                        </div>
                        <div style="flex:0 0 auto;font-size:0.72rem;color:#6b7280;white-space:nowrap;">\u680F\u76EE\uFF1A${c}</div>
                    </div>
                </div>
                <div style="display:flex;gap:6px;flex:0 0 auto;">
                    <button type="button" class="platform-select-action-btn" onclick="removeRssSubscription(${o})">\u5220\u9664</button>
                </div>
            </div>`}).join("");e.innerHTML=r,z()}var k={getSubscriptionsRaw(){let e=S.get(He,[]);return Array.isArray(e)?e:[]},setSubscriptionsRaw(e){if(!Array.isArray(e)){S.set(He,[]);return}S.set(He,e)},getSubscriptions(){return this.getSubscriptionsRaw().filter(t=>t&&typeof t=="object").map(t=>({source_id:String(t.source_id||t.rss_source_id||"").trim(),url:String(t.url||"").trim(),feed_title:String(t.feed_title||"").trim(),column:String(t.column||"RSS").trim()||"RSS",platform_id:String(t.platform_id||"").trim()})).filter(t=>!!t.source_id||!!t.url)},setSubscriptions(e){this.setSubscriptionsRaw(e)},open(){let e=We();if(!e)return;try{G=this.getSubscriptions()}catch{G=null}oe("rssFeedTitle",""),Se=!1,Fe=!1,H.clear(),j.clear(),$();let t=Pe();t&&(t.innerHTML=""),x(""),e.classList.add("show"),z(),jt({showHintOn403:!1}).catch(()=>{})},close(){let e=We();e&&e.classList.remove("show")},async previewCurrent(){let e=Ut();if(!e){alert("\u8BF7\u9009\u62E9 RSS \u6E90");return}try{await Gr(e)}catch(t){H.set(String(e||"").trim(),{ok:!1,entries_count:0,ts:Date.now(),error:String(t?.message||t)}),z();let r=Pe();r&&(r.innerHTML=`<div style="color:#dc2626;">${w(t?.message||String(t))}</div>`)}},removeAt(e){let t=this.getSubscriptions();if(!(e<0||e>=t.length)){try{let r=String(t[e]?.source_id||t[e]?.rss_source_id||"").trim();r&&j.delete(r)}catch{}t.splice(e,1),this.setSubscriptions(t),$()}},async saveAndRefresh(){try{let e=Array.isArray(G)?G:[],t=this.getSubscriptions(),r=Re(e)!==Re(t),o=Gt(e,t).every(m=>{let g=H.get(m);return!!g&&g.ok===!0&&Number(g.entries_count||0)>0});if(!r){x("\u8BF7\u5148\u901A\u8FC7\u9884\u89C8\u52A0\u5165\u81F3\u5C11\u4E00\u4E2A\u8BA2\u9605\uFF0C\u518D\u4FDD\u5B58\u5E76\u5237\u65B0",{variant:"info"}),z();return}if(!o){x("\u65B0\u589E\u8BA2\u9605\u9700\u8981\u5148\u9884\u89C8\u4E14\u5FC5\u987B\u6709\u6761\u76EE\uFF08entries>0\uFF09",{variant:"info"}),z();return}let n=t;try{let m=await fetch("/api/me/rss-subscriptions",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscriptions:Ke(t)})});if(m.status===403){ye=!0,J=!1;try{we()}catch{}x("\u672A\u5F00\u542F\u670D\u52A1\u7AEF\u540C\u6B65\uFF08Not allowlisted\uFF09\uFF0C\u5DF2\u4FDD\u5B58\u5230\u672C\u5730\u8BA2\u9605",{variant:"info"})}else{let g=await m.json().catch(()=>({}));if(!m.ok)throw new Error(g?.detail||"Save failed");n=Ke(g?.subscriptions),ye=!0,J=!0;try{we()}catch{}this.setSubscriptions(n)}}catch(m){x(`\u670D\u52A1\u7AEF\u4FDD\u5B58\u5931\u8D25\uFF0C\u5DF2\u4F7F\u7528\u672C\u5730\u8BA2\u9605\uFF1A${String(m?.message||m)}`,{variant:"info"})}let i=new Set(e.map(m=>String(m?.source_id||m?.rss_source_id||"").trim()).filter(Boolean)),l=n.map(m=>String(m?.source_id||m?.rss_source_id||"").trim()).filter(m=>!!m&&!i.has(m));if(l.length>0&&(It(l,!0),$()),l.length>0)try{await fetch("/api/rss-sources/warmup?wait_ms=0",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({source_ids:l,priority:"high"})})}catch{}x("\u6B63\u5728\u4ECE\u6E90\u83B7\u53D6\u6700\u65B0\u5185\u5BB9...",{variant:"info"});try{let m=document.querySelector("#rssSubscriptionModal .settings-btn-primary");m&&m.setAttribute("disabled","true")}catch{}let c=Date.now(),d=5e3,f=[0,300,700,1500,2500],u=!1;for(let m of f){let g=Date.now()-c,p=d-g;if(p<=0)break;if(m>0&&await qt(Math.min(m,p)),await a.data.refreshViewerData({preserveScroll:!0}),l.length>0){let h=[];for(let y of l)j.has(y)&&Nr([y])&&j.delete(y),j.has(y)&&h.push(y);if(h.length===0){u=!0,$();break}$()}if(l.length===0){u=!0;break}}u?x("\u5DF2\u83B7\u53D6\u5230\u5185\u5BB9\uFF0C\u5373\u5C06\u8FD4\u56DE\u2026",{variant:"success"}):(l.length>0&&(It(l,!1),$()),x("\u5DF2\u8BA2\u9605\uFF0C\u5185\u5BB9\u7A0D\u540E\u66F4\u65B0",{variant:"info"}));try{let m=document.querySelector("#rssSubscriptionModal .settings-btn-primary");m&&m.removeAttribute("disabled")}catch{}await qt(u?200:800),this.close()}catch(e){console.error("rss refresh error:",e);try{x(String(e?.message||e),{variant:"error"})}catch{}try{let t=document.querySelector("#rssSubscriptionModal .settings-btn-primary");t&&t.removeAttribute("disabled")}catch{}}}};async function Qr(){let e=se("rssRequestUrl"),t=se("rssRequestTitle"),r=se("rssRequestNote");if(!e){alert("\u8BF7\u8F93\u5165 URL");return}if(!t){alert("\u8BF7\u8F93\u5165 \u6807\u9898");return}if(!r){alert("\u8BF7\u8F93\u5165 \u5907\u6CE8");return}let s=Pe();s&&(s.innerHTML='<div style="color:#6b7280;">\u63D0\u4EA4\u7533\u8BF7\u4E2D...</div>');try{let o=await fetch("/api/rss-source-requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e,title:t,note:r})}),n=await o.json();if(!o.ok)throw new Error(n?.detail||"Submit failed");s&&(s.innerHTML=`<div style="color:#16a34a;">\u5DF2\u63D0\u4EA4\u7533\u8BF7\uFF0C\u72B6\u6001\uFF1A${w(n?.status||"pending")}</div>`),oe("rssRequestUrl",""),oe("rssRequestTitle",""),oe("rssRequestNote","")}catch(o){s&&(s.innerHTML=`<div style="color:#dc2626;">${w(o?.message||String(o))}</div>`)}}function Zr(){let e=Ur();if(!e)return;let t=e.style.display!=="none";e.style.display=t?"none":"block"}window.openRssSubscriptionModal=()=>{try{let e=document.getElementById("rssSubscriptionNewBadge");e&&(e.style.display="none",localStorage.setItem("rss_subscription_badge_dismissed","true"))}catch{}k.open()};window.closeRssSubscriptionModal=()=>k.close();window.previewRssSubscription=()=>k.previewCurrent();window.saveRssSubscriptions=()=>k.saveAndRefresh();window.removeRssSubscription=e=>k.removeAt(parseInt(e,10));window.submitRssSourceRequest=()=>Qr();window.toggleRssRequestSection=()=>Zr();window.openRssSourcePicker=()=>Jr();window.closeRssSourcePicker=()=>Je();a.subscription=k;a.subscription._serverEnabled=J;function we(){try{a.subscription._serverEnabled=!!J}catch{}}v(function(){let e=We();if(e){let o=document.getElementById("rssFeedTitle");o&&o.addEventListener("input",()=>{Fe=String(o.value||"").trim()!=="",Se=!1}),e.addEventListener("keydown",n=>{n.key==="Escape"&&k.close()})}let t=Xe();t&&t.addEventListener("keydown",o=>{o.key==="Escape"&&Je()});let r=Vt();r&&r.addEventListener("scroll",()=>{Yt()});let s=zt();s&&s.addEventListener("input",()=>{ke=String(s.value||"").trim(),pe&&(window.clearTimeout(pe),pe=0),pe=window.setTimeout(()=>{pe=0,Ye({reset:!0})},250)}),we(),jt({showHintOn403:!1}).catch(()=>{})});function ne(e){let t=e;return t?t.nodeType===3?t.parentElement||null:t:null}function Jt(e){if(!e)return!1;let t=e.scrollWidth||0,r=e.clientWidth||0;return t>r+1}function Qt(e){return ne(e)?.closest?.(".platform-card")?.closest?.(".platform-grid")||null}function Qe(e){let t=ne(e);return!t?.closest||t.closest(".platform-drag-handle")?!1:!!t.closest(".platform-header")||!!t.closest(".platform-name")}v(()=>{let t=null,r=!1,s=null,o=0,n=0,i=!1,l=0,c=()=>{t=null,r=!1,s=null,o=0,n=0,i=!1;try{document.body.classList.remove("tr-platform-title-dragging")}catch{}},d=(u,m)=>{if(!Qe(u)||document.querySelector(".platform-card.dragging"))return!1;let g=Qt(u);if(!g||!Jt(g))return!1;s=g,o=m,n=g.scrollLeft||0,i=!1;try{document.body.classList.add("tr-platform-title-dragging")}catch{}return!0};document.addEventListener("pointerdown",u=>{if(u.button!==0)return;let m=ne(u.target);d(m,u.clientX)&&(t=u.pointerId)},{passive:!0}),document.addEventListener("mousedown",u=>{if(u.button!==0||t!==null)return;let m=ne(u.target);d(m,u.clientX)&&(r=!0)},{passive:!0}),document.addEventListener("pointermove",u=>{if(t===null||u.pointerId!==t||!s)return;if(document.querySelector(".platform-card.dragging")){c();return}let m=u.clientX-o;if(!i&&Math.abs(m)<6)return;i=!0;try{u.preventDefault()}catch{}let g=Math.max(0,(s.scrollWidth||0)-(s.clientWidth||0)),p=Math.max(0,Math.min(g,n-m));s.scrollLeft=p},{passive:!1}),document.addEventListener("mousemove",u=>{if(!r||!s)return;if(document.querySelector(".platform-card.dragging")){c();return}let m=u.clientX-o;if(!i&&Math.abs(m)<6)return;i=!0;try{u.preventDefault()}catch{}let g=Math.max(0,(s.scrollWidth||0)-(s.clientWidth||0)),p=Math.max(0,Math.min(g,n-m));s.scrollLeft=p},{passive:!1});let f=()=>{t!==null&&(i&&(l=Date.now()+600),c())};document.addEventListener("pointerup",f,{passive:!0}),document.addEventListener("pointercancel",f,{passive:!0}),document.addEventListener("mouseup",()=>{r&&(i&&(l=Date.now()+600),c())},{passive:!0}),document.addEventListener("click",u=>{if(Date.now()>l)return;let g=ne(u.target);if(Qe(g)){try{u.preventDefault()}catch{}try{u.stopPropagation()}catch{}try{u.stopImmediatePropagation()}catch{}}},!0),document.addEventListener("wheel",u=>{let m=typeof document.elementFromPoint=="function"?document.elementFromPoint(u.clientX,u.clientY):null,g=ne(m||u.target);if(!u.shiftKey||!Qe(g)||document.querySelector(".platform-card.dragging"))return;let p=Qt(g);if(!p||!Jt(p))return;let h=typeof u.deltaX=="number"&&u.deltaX!==0?u.deltaX:u.deltaY;if(!h)return;try{u.preventDefault()}catch{}let y=Math.max(0,(p.scrollWidth||0)-(p.clientWidth||0)),_=Math.max(0,Math.min(y,(p.scrollLeft||0)+h));p.scrollLeft=_},{passive:!1})});v(function(){if(localStorage.getItem("category_settings_badge_dismissed")==="true"){let r=document.getElementById("categorySettingsNewBadge");r&&(r.style.display="none")}if(localStorage.getItem("rss_subscription_badge_dismissed")==="true"){let r=document.getElementById("rssSubscriptionNewBadge");r&&(r.style.display="none")}let e=a.settings.getCategoryConfig();e&&(e.customCategories&&e.customCategories.length>0||e.hiddenDefaultCategories&&e.hiddenDefaultCategories.length>0||e.categoryOrder&&e.categoryOrder.length>0||e.platformOrder&&typeof e.platformOrder=="object"&&Object.keys(e.platformOrder).length>0)?a.data.refreshViewerData({preserveScroll:!1}):document.body.classList.add("categories-ready")});})();
