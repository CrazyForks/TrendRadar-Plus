<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="admin-token" content="{{ token }}" />
  <title>RSS Source Admin</title>
  <link rel="stylesheet" href="/static/css/admin_rss_sources.css" />
</head>

<body>
  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <div class="wrap">
    <h1>RSS Source Admin</h1>
    <div class="muted">This page requires <code>?token=...</code> or <code>X-Admin-Token</code>.</div>

    <!-- Tab Navigation -->
    <div class="tabs" style="margin-top: 20px;">
      <button data-tab="unified">ğŸ“± å…¨éƒ¨å¹³å°</button>
      <button data-tab="catalog" class="active">ğŸ“‹ RSS æºåˆ—è¡¨</button>
      <button data-tab="custom">ğŸ› ï¸ è‡ªå®šä¹‰æº</button>
      <button data-tab="newsnow">ğŸ“Š çƒ­æ¦œæº</button>
      <button data-tab="import">ğŸ“¥ å¯¼å…¥ç®¡ç†</button>
      <button data-tab="requests">ğŸ“¨ è¯·æ±‚å®¡æ ¸</button>
      <button data-tab="rules">âš™ï¸ è§„åˆ™é…ç½®</button>
      <button data-tab="usage">ğŸ“Š ä½¿ç”¨ç»Ÿè®¡</button>
    </div>


    <!-- Tab Panel: Unified Platform Management -->
    <div class="tab-panel" data-panel="unified">
      <h2>ç»Ÿä¸€å¹³å°ç®¡ç† (Unified Platform)</h2>

      <!-- Category Management Section -->
      <div class="card" style="margin-bottom: 20px;">
        <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h3>é»˜è®¤æ ç›®ç®¡ç†</h3>
          <button class="btn btn-sm" onclick="openCategoryModal()">â• æ–°å»ºæ ç›®</button>
        </div>
        <div id="category-pills" style="display: flex; flex-wrap: wrap; gap: 8px;">
          <!-- Loaded via JS -->
          <div class="muted">Loading categories...</div>
        </div>
      </div>

      <!-- Platform List Section -->
      <div class="card">
        <div class="row" style="margin-bottom:10px; gap: 10px; flex-wrap: wrap; align-items: center;">
          <input type="text" id="unified-search" placeholder="æœç´¢å¹³å°åç§°..." style="flex: 1; min-width: 200px;"
            oninput="filterUnifiedPlatforms()" />

          <select id="unified-filter-category" onchange="filterUnifiedPlatforms()"
            style="border:1px solid #d1d5db; border-radius:6px; padding:6px;">
            <option value="">æ‰€æœ‰æ ç›®</option>
            <!-- Loaded via JS -->
          </select>

          <select id="unified-filter-type" onchange="filterUnifiedPlatforms()"
            style="border:1px solid #d1d5db; border-radius:6px; padding:6px;">
            <option value="">æ‰€æœ‰ç±»å‹</option>
            <option value="newsnow">çƒ­æ¦œæº (NewsNow)</option>
            <option value="rss">RSSæº</option>
            <option value="api">APIæº</option>
            <option value="html">HTMLæº</option>
          </select>

          <div style="flex-grow: 1;"></div>

          <div class="row-actions">
            <button class="btn btn-sm" onclick="openBatchCategoryModal()">ğŸ“‚ è®¾ç½®æ ç›®</button>
            <button class="btn btn-sm" onclick="batchToggleUnified(true)">âœ… æ‰¹é‡å¯ç”¨</button>
            <button class="btn btn-danger btn-sm" onclick="batchToggleUnified(false)">ğŸš« æ‰¹é‡ç¦ç”¨</button>
          </div>
        </div>

        <div class="table-scroll">
          <table id="unified-table">
            <thead>
              <tr>
                <th style="width:30px;"><input type="checkbox" id="unified-select-all"
                    onclick="toggleSelectAllUnified()"></th>
                <th style="width:80px;">ç±»å‹</th>
                <th style="width:200px;">åç§°</th>
                <th style="width:120px;">å½“å‰æ ç›®</th>
                <th style="width:60px;">çŠ¶æ€</th>
                <th style="width:140px;">æœ€åæ›´æ–°</th>
                <th style="width:100px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="unified-tbody">
              <!-- Loaded via JS -->
            </tbody>
          </table>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
          æ˜¾ç¤º <span id="unified-count">0</span> ä¸ªå¹³å°
        </div>
      </div>
    </div>

    <!-- Category Modal -->
    <div id="category-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeCategoryModal()">&times;</span>
        <h2 id="category-modal-title">ç¼–è¾‘æ ç›®</h2>
        <div class="form-group">
          <label>ID</label>
          <input type="text" id="cat-id" placeholder="id (e.g. 'tech')" />
          <small class="muted">åˆ›å»ºåIDä¸å¯ä¿®æ”¹</small>
        </div>
        <div class="form-group">
          <label>åç§° (Display Name)</label>
          <input type="text" id="cat-name" placeholder="æ˜¾ç¤ºåç§° (e.g. 'ç§‘æŠ€')" />
        </div>
        <div class="form-group">
          <label>å›¾æ ‡ (Emoji)</label>
          <input type="text" id="cat-icon" placeholder="ä¾‹å¦‚: ğŸ“°" style="width: 80px;" />
        </div>
        <div class="form-group">
          <label>æ’åºæƒé‡ (0-100, å°é å‰)</label>
          <input type="number" id="cat-order" placeholder="0" />
        </div>
        <button class="btn btn-primary" onclick="saveCategory()">ä¿å­˜</button>
      </div>
    </div>

    <!-- Batch Category Modal -->
    <div id="batch-cat-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeBatchCategoryModal()">&times;</span>
        <h2>æ‰¹é‡è®¾ç½®æ ç›®</h2>
        <div class="form-group">
          <label>é€‰æ‹©æ ç›®</label>
          <select id="batch-cat-select" style="width:100%; border:1px solid #ddd; padding:8px; border-radius:4px;">
            <!-- Populated by JS -->
          </select>
        </div>
        <button class="btn btn-primary" onclick="executeBatchCategory()">ç¡®å®šåº”ç”¨</button>
      </div>
    </div>

    <!-- Tab Panel: Rules Configuration -->
    <div class="tab-panel" data-panel="rules">
      <h2>Morning Brief Rules</h2>
      <div class="card">
        <div class="muted" style="margin-bottom:8px;">
          Edit <code>morning_brief_rules_v1</code> (JSON). Changes take effect immediately.
        </div>
        <textarea id="mb-rules-text"
          style="width:100%;min-height:160px;border:1px solid #d1d5db;border-radius:8px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;font-size:12px;"
          placeholder='{"enabled":true,"drop_published_at_zero":true,"topic_keywords":["ai"],"depth_keywords":[],"negative_hard":[],"negative_soft":[],"source_scores":{},"source_decay":{"second":0.6,"third_plus":0.3},"overrides":{"force_top":[],"force_blacklist":[]}}'></textarea>
        <div style="height:10px;"></div>
        <div class="row" style="align-items:center;">
          <button class="btn btn-primary" onclick="loadMorningBriefRules()">Load</button>
          <button class="btn btn-primary" onclick="validateMorningBriefRules()">Validate</button>
          <button class="btn btn-primary" onclick="saveMorningBriefRules()">Save</button>
          <span class="muted" id="mb-rules-status"></span>
        </div>
      </div>
    </div>

    <!-- Tab Panel: Import Management -->
    <div class="tab-panel" data-panel="import">
      <h2>CSV Paste Import</h2>
      <div class="card">
        <div class="muted" style="margin-bottom:8px;">
          Paste CSV rows and import into <code>rss_sources</code>.
        </div>
        <div class="muted" style="margin-bottom:8px;">
          Supported formats:
          <div style="margin-top:4px;">
            <div><b>URL-only</b>: one RSS URL per line (Preview will autofill fields)</div>
            <div><b>Headerless fixed-order (8/9 columns)</b>:
              name,url,seed_last_updated,category,feed_type,country,language,source[,added_at]</div>
            <div><b>Chinese headers</b>: æ ‡é¢˜,è®¢é˜…åœ°å€,æœ€åæ›´æ–°,åˆ†ç±»,ç±»å‹,å›½å®¶,è¯­è¨€,æ¥æº,æ·»åŠ æ—¶é—´</div>
          </div>
        </div>
        <textarea id="csv-import-text"
          style="width:100%;min-height:120px;border:1px solid #d1d5db;border-radius:8px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;font-size:12px;"
          placeholder="Example (URL-only):\nhttps://blog.samaltman.com/posts.atom\nhttps://blog.google/technology/ai/rss/\n\nExample (CSV):\nGoogle Blog AI,https://blog.google/technology/ai/rss/,,äººå·¥æ™ºèƒ½,åˆ†ç±»è®¢é˜…,ç¾å›½,è‹±æ–‡,æ‰‹åŠ¨æ·»åŠ ,2026-01-09 10:00"></textarea>
        <div style="height:10px;"></div>
        <div class="row" style="align-items:center;">
          <button class="btn btn-primary" onclick="previewCsvImport()">Preview</button>
          <button class="btn btn-primary" onclick="commitCsvImport()">Commit</button>
          <button class="btn btn-danger" onclick="bulkDisableByUrls()">Bulk Disable (From URLs)</button>
          <button class="btn btn-primary" onclick="bulkEnableCatalogAll()">Bulk Enable Catalog (All)</button>
          <button class="btn btn-danger" onclick="bulkDisableCatalogAll()">Bulk Disable Catalog (All)</button>
          <button class="btn btn-primary" onclick="exportCatalogAll()">Export Catalog (All)</button>
          <span class="muted" id="csv-import-status"></span>
        </div>
        <div style="height:10px;"></div>
        <div id="csv-import-result"></div>
      </div>
    </div>

    <!-- Tab Panel: Request Review -->
    <div class="tab-panel" data-panel="requests">
      <h2>Pending Requests</h2>
      <div class="card">
        {% if pending and pending|length > 0 %}
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>URL</th>
                <th>Note</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for r in pending %}
              <tr>
                <td>{{ r.id }}</td>
                <td style="max-width:240px; word-break:break-word;"><b>{{ r.title }}</b></td>
                <td style="max-width:520px; word-break:break-all;">
                  <div><b>{{ r.host }}</b></div>
                  <div class="muted">{{ r.url }}</div>
                </td>
                <td style="max-width:280px; word-break:break-word;">{{ r.note }}</td>
                <td>
                  <div class="row">
                    <input type="text" id="name-{{ r.id }}" placeholder="Source name (optional)" />
                    <button class="btn btn-primary" data-id="{{ r.id }}"
                      onclick="approveReq(this.dataset.id)">Approve</button>
                    <input type="text" id="reason-{{ r.id }}" placeholder="Reject reason" />
                    <button class="btn btn-danger" data-id="{{ r.id }}"
                      onclick="rejectReq(this.dataset.id)">Reject</button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="muted">No pending requests.</div>
        {% endif %}
      </div>

      <h2>Rejected Requests</h2>
      <div class="card">
        {% if rejected and rejected|length > 0 %}
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>URL</th>
                <th>Reason</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rejected %}
              <tr>
                <td>{{ r.id }}</td>
                <td style="max-width:240px; word-break:break-word;"><b>{{ r.title }}</b></td>
                <td style="max-width:520px; word-break:break-all;">
                  <div><b>{{ r.host }}</b></div>
                  <div class="muted">{{ r.url }}</div>
                </td>
                <td style="max-width:280px; word-break:break-word;">{{ r.reason }}</td>
                <td>
                  <div class="row">
                    <button class="btn" data-id="{{ r.id }}" onclick="reopenReq(this.dataset.id)">Reopen</button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="muted">No rejected requests.</div>
        {% endif %}
      </div>
    </div>

    <!-- Tab Panel: Custom Sources (Unified API + HTML) -->
    <div class="tab-panel" data-panel="custom">
      <h2>è‡ªå®šä¹‰æºåˆ—è¡¨ (API + HTML + Script)</h2>
      <div class="card">
        <div class="row" style="margin-bottom:10px;">
          <input type="text" id="custom-search" placeholder="æœç´¢åç§°æˆ– ID" style="flex: 1; max-width: 300px;"
            oninput="filterCustomSources('all')" />
          <button class="btn btn-sm" onclick="bulkEnableCustom('all')">æ‰¹é‡å¯ç”¨</button>
          <button class="btn btn-sm btn-danger" onclick="bulkDisableCustom('all')">æ‰¹é‡ç¦ç”¨</button>
          <button class="btn btn-primary" onclick="openEditCustomSourceModal('all')">â• æ·»åŠ è‡ªå®šä¹‰æº</button>
        </div>

        <div class="table-scroll">
          <table id="custom-table">
            <thead>
              <tr>
                <th style="width:30px;"><input type="checkbox" id="custom-select-all"
                    onclick="toggleSelectAllCustom('all')"></th>
                <th style="width:40px;"></th>
                <th style="width:60px;">çŠ¶æ€</th>
                <th style="width:70px;">ç±»å‹</th>
                <th style="width:260px;">åç§° / URL</th>
                <th style="width:100px;">åˆ†ç±»</th>
                <th style="width:140px;">æ—¶é—´</th>
                <th style="width:120px;">ç»Ÿè®¡</th>
                <th style="width:100px;">æœ€æ–°</th>
                <th style="width:140px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="custom-tbody">
              <!-- Loaded via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab Panel: NewsNow Platforms -->
    <div class="tab-panel" data-panel="newsnow">
      <h2>çƒ­æ¦œæºç®¡ç† (NewsNow API)</h2>
      <div class="card">
        <div class="row" style="margin-bottom:10px; gap:10px;">
          <input type="text" id="newsnow-search" placeholder="æœç´¢å¹³å°..." style="flex: 1; max-width: 300px;"
            oninput="filterNewsNow()" />
          <button class="btn" onclick="migrateNewsNowFromConfig()">ğŸ“¥ ä»é…ç½®æ–‡ä»¶å¯¼å…¥</button>
          <button class="btn btn-primary" onclick="showReloadInstructions()">ğŸ”„ é‡æ–°åŠ è½½é…ç½®</button>
          <button class="btn btn-primary" onclick="openNewsNowModal()">â• æ·»åŠ å¹³å°</button>
        </div>

        <div class="table-scroll">
          <table id="newsnow-table">
            <thead>
              <tr>
                <th style="width:120px;">ID</th>
                <th style="width:160px;">åç§°</th>
                <th style="width:100px;">åˆ†ç±»</th>
                <th style="width:80px;">çŠ¶æ€</th>
                <th style="width:140px;">æœ€åè·å–</th>
                <th style="width:180px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="newsnow-tbody">
              <!-- Loaded via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Edit NewsNow Platform Modal -->
    <div id="newsnow-modal"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
      <div class="card"
        style="width:400px; max-width:90%; padding:20px; display:flex; flex-direction:column; gap:12px;">
        <h3>ç¼–è¾‘çƒ­æ¦œå¹³å°</h3>
        <input type="hidden" id="newsnow-edit-original-id" />

        <div class="row">
          <label style="width:80px;">ID:</label>
          <input type="text" id="newsnow-edit-id" placeholder="weibo" style="flex:1;" />
        </div>
        <div class="row">
          <label style="width:80px;">åç§°:</label>
          <input type="text" id="newsnow-edit-name" placeholder="å¾®åš" style="flex:1;" />
        </div>
        <div class="row">
          <label style="width:80px;">åˆ†ç±»:</label>
          <select id="newsnow-edit-category" style="flex:1;">
            <option value="">æœªåˆ†ç±»</option>
            <option value="ç»¼åˆæ–°é—»">ç»¼åˆæ–°é—»</option>
            <option value="è´¢ç»æŠ•èµ„">è´¢ç»æŠ•èµ„</option>
            <option value="ç¤¾äº¤å¨±ä¹">ç¤¾äº¤å¨±ä¹</option>
            <option value="ç§‘æŠ€">ç§‘æŠ€</option>
          </select>
        </div>
        <div class="row">
          <label style="width:80px;">æ’åº:</label>
          <input type="number" id="newsnow-edit-order" value="0" style="width:80px;" />
        </div>
        <div class="row">
          <label style="width:80px;">å¯ç”¨:</label>
          <input type="checkbox" id="newsnow-edit-enabled" checked />
        </div>

        <div class="row" style="justify-content:flex-end; gap:8px; margin-top:10px;">
          <button class="btn" onclick="closeNewsNowModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="saveNewsNowPlatform()">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- Fully cleaned up duplicate modal -->

    <!-- Tab Panel: RSS Source Catalog (Active by default) -->
    <div class="tab-panel active" data-panel="catalog">
      <!-- Quick Add RSS -->
      <div class="quick-add">
        <input type="text" id="quick-add-url" placeholder="è¾“å…¥ RSS URL å¿«é€Ÿæ·»åŠ  (ä¸€é”® Preview â†’ Commit â†’ Warmup)" />
        <button class="btn btn-primary" onclick="quickAddRss()">â• å¿«é€Ÿæ·»åŠ </button>
      </div>

      <h2>Catalog (All)</h2>
      <div class="card" id="rss-catalog-all">
        <div class="row" style="align-items:center; margin-bottom:10px;">
          <input type="text" id="catalog-search" placeholder="Search" style="flex: 1; max-width: 300px;" />

          <!-- Quick Filter Buttons -->
          <button class="btn" data-filter="ALL" onclick="setCatalogFilter('ALL')" title="æ˜¾ç¤ºå…¨éƒ¨">
            å…¨éƒ¨ ({{ sources|length }})
          </button>
          <button class="btn btn-primary" data-filter="ABNORMAL" onclick="setCatalogFilter('ABNORMAL')" title="å¼‚å¸¸çŠ¶æ€">
            ğŸ”´ å¼‚å¸¸ ({{ health_abnormal_count or 0 }})
          </button>

          <!-- Filter Dropdown -->
          <div class="dropdown">
            <button class="btn dropdown-toggle" onclick="toggleDropdown('filter-dropdown')">æ›´å¤šç­›é€‰</button>
            <div class="dropdown-menu" id="filter-dropdown">
              <button class="dropdown-item" onclick="setCatalogFilter('OK'); closeDropdown('filter-dropdown')">
                âœ… æ­£å¸¸ (OK) <span class="muted" style="float:right;">{{ (health_kpi or {}).get('OK', 0) }}</span>
              </button>
              <button class="dropdown-item" onclick="setCatalogFilter('FAIL'); closeDropdown('filter-dropdown')">
                âŒ å¤±è´¥ (FAIL) <span class="muted" style="float:right;">{{ (health_kpi or {}).get('FAIL', 0) }}</span>
              </button>
              <button class="dropdown-item" onclick="setCatalogFilter('BACKOFF'); closeDropdown('filter-dropdown')">
                â¸ï¸ é€€é¿ (BACKOFF) <span class="muted" style="float:right;">{{ (health_kpi or {}).get('BACKOFF', 0)
                  }}</span>
              </button>
              <button class="dropdown-item" onclick="setCatalogFilter('NEVER_TRIED'); closeDropdown('filter-dropdown')">
                ğŸ†• æœªå°è¯• <span class="muted" style="float:right;">{{ (health_kpi or {}).get('NEVER_TRIED', 0) }}</span>
              </button>
              <button class="dropdown-item" onclick="setCatalogFilter('OK_EMPTY'); closeDropdown('filter-dropdown')">
                ğŸ“­ ç©º (OK_EMPTY) <span class="muted" style="float:right;">{{ (health_kpi or {}).get('OK_EMPTY', 0)
                  }}</span>
              </button>
              <button class="dropdown-item" onclick="setCatalogFilter('STALE'); closeDropdown('filter-dropdown')">
                ğŸ•’ é•¿æœŸä¸æ›´æ–° <span class="muted" style="float:right;">{{ (health_kpi or {}).get('STALE', 0) }}</span>
              </button>
              <button class="dropdown-item" onclick="setCatalogFilter('DISABLED'); closeDropdown('filter-dropdown')">
                â›” å·²ç¦ç”¨ <span class="muted" style="float:right;">{{ (health_kpi or {}).get('DISABLED', 0) }}</span>
              </button>
            </div>
          </div>

          <div style="flex:1"></div>

          <!-- Bulk Actions Dropdown -->
          <div class="row" style="align-items:center;" id="bulk-actions-toolbar">
            <span class="muted" id="bulk-selection-info" style="margin-right:8px;">Selected: 0</span>
            <div class="dropdown">
              <button class="btn dropdown-toggle" onclick="toggleDropdown('bulk-dropdown')">æ‰¹é‡æ“ä½œ</button>
              <div class="dropdown-menu" id="bulk-dropdown">
                <button class="dropdown-item" onclick="bulkWarmupSelected(); closeDropdown('bulk-dropdown')">âš¡ï¸ æ‰¹é‡æŠ“å–
                  (Warmup)</button>
                <button class="dropdown-item" onclick="bulkClearBackoffAndRetry(); closeDropdown('bulk-dropdown')">ğŸ”„
                  æ¸…é™¤é€€é¿å¹¶é‡è¯•</button>
                <button class="dropdown-item" onclick="bulkSetEnabledSelected(1); closeDropdown('bulk-dropdown')">âœ…
                  æ‰¹é‡å¯ç”¨</button>
                <button class="dropdown-item" onclick="bulkSetEnabledSelected(0); closeDropdown('bulk-dropdown')">â›”
                  æ‰¹é‡ç¦ç”¨</button>
                <div style="border-top:1px solid #e5e7eb; margin:4px 0;"></div>
                <button class="dropdown-item danger" onclick="bulkDeleteSelected(); closeDropdown('bulk-dropdown')">ğŸ—‘ï¸
                  æ‰¹é‡åˆ é™¤</button>
              </div>
            </div>
          </div>
        </div>



        {% if sources and sources|length > 0 %}
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th style="width:40px;"><input type="checkbox" id="select-all-visible"
                    onclick="toggleSelectAllVisible(this)" /></th>
                <th style="width:40px;"></th> <!-- Expand button column -->
                <th style="width:90px;">Status</th>
                <th style="width:240px;">Name / URL</th>
                <th style="width:110px;">Category</th>
                <th style="width:110px;">Time</th> <!-- Added / Updated -->
                <th style="width:90px;">Stats</th> <!-- Entries / Fail -->
                <th style="width:100px;">Latest</th>
                <th style="width:140px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for s in sources %}
              <!-- Main Row -->
              <tr data-health="{{ s.health_state or '' }}" data-abnormal="{{ 1 if s.is_abnormal else 0 }}"
                data-search="{{ (s.name ~ ' ' ~ s.url ~ ' ' ~ s.host ~ ' ' ~ (s.category or '') ~ ' ' ~ (s.source or '') )|lower }}">
                <td>
                  <input type="checkbox" class="rss-src-select" data-id="{{ s.id }}" onclick="handleRowSelect(this)" />
                </td>
                <td>
                  <button class="expand-btn" onclick="toggleDetail(this)" data-id="{{ s.id }}">â–¶</button>
                </td>
                <td>
                  <!-- Compact Status -->
                  {% set hs = s.health_state or '' %}
                  {% if hs == 'OK' %}
                  <span class="badge badge-ok">OK</span>
                  {% elif hs in ['FAIL'] %}
                  <span class="badge badge-bad">FAIL</span>
                  {% elif hs in ['BACKOFF','NEVER_TRIED','OK_EMPTY','STALE'] %}
                  <span class="badge badge-warn">{{ hs }}</span>
                  {% elif hs == 'DISABLED' %}
                  <span class="badge badge-off">DISABLED</span>
                  {% else %}
                  <span class="badge badge-off">{{ hs }}</span>
                  {% endif %}
                </td>
                <td style="max-width:240px;" class="col-title">
                  <div style="font-weight:600; color:#111827; font-size:13px;">{{ s.name or s.host }}</div>
                  <div class="muted"
                    style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:12px;"
                    title="{{ s.url }}">
                    <a href="{{ s.url }}" target="_blank" rel="noopener noreferrer"
                      style="text-decoration:none; color:inherit;">{{ s.url }}</a>
                  </div>
                  <div
                    style="margin-top:2px; font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#4b5563;">
                    <span
                      style="font-weight:500; font-family:monospace; background:#f3f4f6; padding:1px 3px; border-radius:3px;">{{
                      s.feed_type }}</span>
                    <span style="margin:0 2px;">Â·</span> {{ s.country }} / {{ s.language }}
                  </div>
                  <div
                    style="margin-top:1px; font-size:10px; color:#9ca3af; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
                    title="ID: {{ s.id }} | Source: {{ s.source }}">
                    #{{ s.id }} <span style="margin:0 2px;">Â·</span> {{ s.source }}
                  </div>
                </td>
                <td>{{ s.category }}</td>
                <td>
                  <div class="muted" style="font-size:11px;" title="Added: {{ s.added_time }}">Add: {{
                    s.added_time|truncate(10, True, '') }}</div>
                  <div class="muted" style="font-size:11px;" title="Last Updated: {{ s.last_updated_time }}">Upd: {{
                    s.last_updated_time|truncate(10, True, '') }}</div>
                </td>
                <td>
                  <div style="font-size:12px;">Entries: {{ s.entries_count }}</div>
                  {% if s.fail_count and s.fail_count > 0 %}
                  <div style="font-size:12px; color:#dc2626;">Fail: {{ s.fail_count }}</div>
                  {% else %}
                  <div style="font-size:12px;" class="muted">Fail: 0</div>
                  {% endif %}

                  {% if s.backoff_until_time %}
                  <div style="font-size:11px; color:#d97706; margin-top:2px; white-space:normal; word-break:break-all;"
                    title="Backoff Until: {{ s.backoff_until_time }}">
                    Wait: {{ s.backoff_until_time }}
                  </div>
                  {% endif %}

                  {% if s.last_error_reason %}
                  <div style="font-size:11px; color:#dc2626; margin-top:2px; white-space:normal; word-break:break-all;"
                    title="{{ s.last_error_reason }}">
                    Err: {{ s.last_error_reason }}
                  </div>
                  {% endif %}
                </td>
                <td>
                  <div title="{{ s.latest_entry }}">
                    {{ s.latest_entry_time|truncate(10, True, '') if s.latest_entry_time else '-' }}
                  </div>
                </td>
                <td>
                  <div class="row-actions">
                    <button class="btn btn-icon" title="Edit" onclick="openEditModal(this)" data-id="{{ s.id }}"
                      data-name="{{ s.name }}" data-url="{{ s.url }}" data-category="{{ s.category }}"
                      data-feed-type="{{ s.feed_type }}" data-country="{{ s.country }}" data-language="{{ s.language }}"
                      data-source="{{ s.source }}" data-scrape-rules="{{ s.scrape_rules }}"
                      data-enabled="{{ 1 if s.enabled else 0 }}">âœï¸</button>
                    <button class="btn btn-primary btn-icon" title="Warmup" onclick="warmupSource(this)"
                      data-id="{{ s.id }}">âš¡</button>
                    <button class="btn btn-icon" title="Clear Backoff" onclick="clearBackoffAndRetry(this)"
                      data-id="{{ s.id }}">ğŸ”„</button>
                    <button class="btn btn-icon {{ 'btn-danger' if s.enabled else '' }}"
                      title="{{ 'Disable' if s.enabled else 'Enable' }}" onclick="toggleSourceEnabled(this)"
                      data-id="{{ s.id }}" data-enabled="{{ 1 if s.enabled else 0 }}">
                      {{ 'â›”' if s.enabled else 'âœ…' }}
                    </button>
                    <button class="btn btn-danger btn-icon" title="Delete" onclick="deleteSource(this)"
                      data-id="{{ s.id }}" data-name="{{ s.name }}">ğŸ—‘ï¸</button>
                  </div>
                </td>
              </tr>

              <!-- Detail Row -->
              <tr class="detail-row" style="display:none;">
                <td colspan="9" style="padding:0;">
                  <div class="detail-content"
                    style="padding:10px 14px; background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                    <div id="detail-entries-{{ s.id }}" class="detail-entries-container">
                      <div class="muted">Loading entries...</div>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="muted">Catalog is empty.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Tab Panel: Usage Statistics -->
    <div class="tab-panel" data-panel="usage">
      <h2>RSS Usage</h2>
      <div class="card">
        <div class="row" style="align-items:center;">
          <input type="text" id="usage-days" value="7" />
          <button class="btn btn-primary" onclick="loadUsage()">Load</button>
          <span class="muted" id="usage-status"></span>
        </div>
        <div style="height:10px;"></div>
        <div class="kpi" id="usage-kpi" style="display:none;"></div>
        <div style="height:10px;"></div>
        <div id="usage-table"></div>
      </div>
    </div>

    

    <!-- RSS Source Edit Modal -->
    <div id="rss-edit-modal" class="modal-overlay"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
      <div class="modal-content"
        style="background:white; padding:20px; border-radius:8px; width:600px; max-width:90%; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
        <h3 style="margin-top:0; margin-bottom:16px; font-size:18px; font-weight:600;">Edit RSS Source</h3>
        <input type="hidden" id="edit-source-id">

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
          <div class="form-group">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">Name</label>
            <input type="text" id="edit-name" class="form-control"
              style="width:100%; padding:6px; border:1px solid #d1d5db; border-radius:4px;">
          </div>
          <div class="form-group">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">Category</label>
            <input type="text" id="edit-category" class="form-control"
              style="width:100%; padding:6px; border:1px solid #d1d5db; border-radius:4px;">
          </div>

          <div class="form-group" style="grid-column: span 2;">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">URL</label>
            <input type="text" id="edit-url" class="form-control"
              style="width:100%; padding:6px; border:1px solid #d1d5db; border-radius:4px;">
          </div>

          <div class="form-group">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">Feed Type</label>
            <input type="text" id="edit-feed-type" class="form-control"
              style="width:100%; padding:6px; border:1px solid #d1d5db; border-radius:4px;">
          </div>
          <div class="form-group">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">Source</label>
            <input type="text" id="edit-source" class="form-control"
              style="width:100%; padding:6px; border:1px solid #d1d5db; border-radius:4px;">
          </div>

          <div class="form-group">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">Country</label>
            <input type="text" id="edit-country" class="form-control"
              style="width:100%; padding:6px; border:1px solid #d1d5db; border-radius:4px;">
          </div>
          <div class="form-group">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">Language</label>
            <input type="text" id="edit-language" class="form-control"
              style="width:100%; padding:6px; border:1px solid #d1d5db; border-radius:4px;">
          </div>

          <div class="form-group" style="grid-column: span 2;">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">Scrape Rules
              (JSON)</label>
            <textarea id="edit-scrape-rules" class="form-control" rows="3"
              style="width:100%; padding:6px; border:1px solid #d1d5db; border-radius:4px; font-family:monospace; font-size:12px;"></textarea>
          </div>

          <div class="form-group">
            <label style="display:flex; align-items:center; gap:8px; font-size:12px; font-weight:500;">
              <input type="checkbox" id="edit-enabled">
              Enabled
            </label>
          </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
          <button class="btn btn-primary" onclick="saveEditSource()">Save</button>
          <button class="btn" onclick="closeEditModal()">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Edit Source Modal -->
    <div id="edit-source-modal" class="modal-overlay"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center; overflow:auto; padding:20px;">
      <div class="modal-content"
        style="background:white; padding:24px; border-radius:12px; width:95vw; max-width:1400px; max-height:95vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.2);">
        <h3 style="margin-top:0; margin-bottom:16px; font-size:18px; font-weight:600;">Edit RSS Source</h3>
        <input type="hidden" id="edit-source-id">
        <input type="hidden" id="edit-custom-id-original">

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">

          <!-- URL Input with AI Button -->
          <div class="form-group" style="grid-column: span 2;">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">URL</label>
            <div style="display:flex; gap:10px;">
              <input type="text" id="edit-custom-magic-url" class="form-control" placeholder="https://example.com/news"
                style="flex:1; padding:6px; border:1px solid #d1d5db; border-radius:4px;">
              <button type="button" class="btn btn-primary" onclick="detectCustomSourceAI()"
                style="white-space:nowrap;">
                AI ğŸª„ Analyze
              </button>
            </div>
            <div class="muted" style="margin-top:4px;">Enter URL and click AI Analyze to auto-detect configuration.
            </div>
          </div>

          <!-- Manual Fields (Unhidden for transparency/editing) -->
          <!-- Manual Fields (Hidden for simplicity) -->
          <div style="grid-column: span 2; display:grid; grid-template-columns: 1fr; gap:10px;">
            <div>
              <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">Provider Type</label>
              <select id="edit-custom-provider" class="form-control" style="width:100%;" onchange="onProviderChange()">
              </select>
            </div>

            <div style="display:none;">
              <input type="text" id="edit-custom-id">
              <input type="text" id="edit-custom-name">
              <input type="text" id="edit-custom-cron" value="*/30 * * * *">
              <input type="text" id="edit-custom-category">
              <input type="text" id="edit-custom-country">
              <input type="text" id="edit-custom-language">
              <input type="checkbox" id="edit-custom-enabled" checked>
            </div>
          </div>

          <!-- Detected Metadata Summary -->
          <div id="ai-detected-summary"
            style="grid-column: span 2; display:none; background:#f0f9ff; padding:10px; border-radius:6px; border:1px solid #bae6fd; margin-bottom:10px;">
            <div style="font-weight:600; font-size:13px; margin-bottom:4px;">ğŸ¤– AI Detected Configuration:</div>
            <div id="ai-summary-content" style="font-size:12px; color:#0369a1;"></div>
          </div>

          <!-- Config JSON Editor -->
          <div id="editor-config-json" class="form-group" style="grid-column: span 2;">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">Config JSON</label>
            <textarea id="edit-custom-config" class="form-control"
              style="width:100%; min-height:200px; font-family:monospace; padding:6px; border:1px solid #d1d5db; border-radius:4px; font-size:12px;"></textarea>
          </div>

          <!-- Script Editor (Hidden by default) -->
          <div id="editor-script-py" class="form-group" style="grid-column: span 2; display:none;">
            <label style="display:block; font-size:12px; font-weight:500; margin-bottom:4px;">Python Script (def
              fetch(config, ctx): ...)</label>
            <textarea id="edit-custom-script-content" class="form-control"
              placeholder="def fetch(config, ctx):&#10;    return [{'title': 'Hello', 'url': 'http://...'}]"
              style="width:100%; min-height:300px; font-family:monospace; padding:6px; border:1px solid #d1d5db; border-radius:4px; font-size:12px; background:#1e1e1e; color:#d4d4d4;"></textarea>
          </div>

          <div class="form-group" style="grid-column: span 2;">
            <label style="display:block; font-size:13px; font-weight:600; margin-bottom:8px;">ğŸ¤– AI è°ƒè¯•è¿‡ç¨‹</label>
            <div id="custom-test-result"
              style="display:block; margin-top:10px; padding:15px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; font-size:12px; white-space:pre-wrap; min-height:200px; max-height:500px; overflow-y:auto;">
            </div>
          </div>

        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
          <button class="btn" onclick="testCustomSource()">Test Run</button>
          <button class="btn btn-primary" onclick="saveCustomSource()">Save</button>
          <button class="btn"
            onclick="document.getElementById('edit-source-modal').style.display='none'">Cancel</button>
        </div>
      </div>
    </div>

    
    <!-- Loading Overlay -->
    <div id="ai-loading-overlay"
      style="display:none; position:fixed; top:20px; right:20px; background:linear-gradient(135deg, #3b82f6, #8b5cf6); color:white; padding:12px 20px; border-radius:12px; z-index:100000; box-shadow:0 4px 20px rgba(59,130,246,0.4); min-width:200px;">
      <div style="display:flex; align-items:center; gap:10px;">
        <div style="font-size:20px; animation: spin 1s linear infinite;">ğŸª„</div>
        <div>
          <div style="font-weight:600; font-size:13px;">AI åˆ†æä¸­...</div>
          <div id="ai-loading-status" style="font-size:11px; opacity:0.9;">æ­£åœ¨è¯†åˆ«é¡µé¢ç»“æ„</div>
        </div>
      </div>
    </div>
    
    <div id="visual-selector-modal" class="modal-overlay"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; padding:20px; z-index:99999;">
      <div class="modal-content"
        style="width:95%; height:95%; max-width:1400px; display:flex; flex-direction:column; padding:0; overflow:hidden;">
        <!-- Header -->
        <div
          style="padding:10px 15px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; background:#f9fafb;">
          <div style="display:flex; gap:10px; align-items:center;">
            <h3 style="margin:0; font-size:16px;">Visual Scrape Selector</h3>
            <span id="vs-url"
              style="font-size:12px; color:#6b7280; max-width:400px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;"></span>
          </div>
          <div style="display:flex; gap:8px;">
            <button onclick="closeVisualSelector()"
              style="padding:6px 12px; border:1px solid #d1d5db; background:white; border-radius:4px; cursor:pointer;">Cancel</button>
            <button onclick="applyVisualRules()" class="btn-primary"
              style="padding:6px 12px; border:none; border-radius:4px; cursor:pointer;">Apply Rules</button>
          </div>
        </div>

        <!-- Toolbar & Frame -->
        <div style="flex:1; display:flex; overflow:hidden; position:relative;">
          <!-- Sidebar / Floating Toolbar -->
          <div
            style="width:280px; background:white; border-right:1px solid #e5e7eb; padding:15px; display:flex; flex-direction:column; gap:15px; overflow-y:auto;">

            <div class="vs-step" data-step="item">
              <label style="font-size:12px; font-weight:700; display:block; margin-bottom:4px;">1. Select Container
                (Item)</label>
              <div style="font-size:11px; color:#6b7280; margin-bottom:6px;">Result count: <span
                  id="vs-item-count">-</span></div>
              <div style="display:flex; gap:4px;">
                <input type="text" id="vs-item-sel" placeholder="e.g. .post"
                  style="flex:1; padding:4px; border:1px solid #d1d5db; font-size:11px; font-family:monospace;">
                <button onclick="setVsMode('item')" id="btn-vs-item" class="btn-vs-mode">Target</button>
              </div>
            </div>

            <div class="vs-step" data-step="title">
              <label style="font-size:12px; font-weight:700; display:block; margin-bottom:4px;">2. Select Title</label>
              <div style="font-size:11px; color:#6b7280; margin-bottom:6px;">Must be inside Item</div>
              <div style="display:flex; gap:4px;">
                <input type="text" id="vs-title-sel" placeholder="e.g. h2 > a"
                  style="flex:1; padding:4px; border:1px solid #d1d5db; font-size:11px; font-family:monospace;">
                <button onclick="setVsMode('title')" id="btn-vs-title" class="btn-vs-mode">Target</button>
              </div>
            </div>

            <div class="vs-step" data-step="link">
              <label style="font-size:12px; font-weight:700; display:block; margin-bottom:4px;">3. Select Link</label>
              <div style="font-size:11px; color:#6b7280; margin-bottom:6px;">Usually same as Title</div>
              <div style="display:flex; gap:4px;">
                <input type="text" id="vs-link-sel" placeholder="e.g. h2 > a"
                  style="flex:1; padding:4px; border:1px solid #d1d5db; font-size:11px; font-family:monospace;">
                <button onclick="setVsMode('link')" id="btn-vs-link" class="btn-vs-mode">Target</button>
              </div>
            </div>

            <div class="vs-step" data-step="date">
              <label style="font-size:12px; font-weight:700; display:block; margin-bottom:4px;">4. Select Date
                (Optional)</label>
              <div style="display:flex; gap:4px;">
                <input type="text" id="vs-date-sel" placeholder="e.g. .time"
                  style="flex:1; padding:4px; border:1px solid #d1d5db; font-size:11px; font-family:monospace;">
                <button onclick="setVsMode('date')" id="btn-vs-date" class="btn-vs-mode">Target</button>
              </div>
            </div>

            <div style="margin-top:auto; padding-top:10px; border-top:1px solid #e5e7eb;">
              <button onclick="resetVs()"
                style="width:100%; padding:6px; border:1px solid #d1d5db; background:#f3f4f6; cursor:pointer; font-size:12px;">Reset
                All</button>
            </div>
            <div id="vs-status" style="font-size:11px; color:#ef4444; min-height:16px;"></div>
          </div>

          <!-- Iframe Container -->
          <div style="flex:1; position:relative; background:#e5e7eb;">
            <iframe id="vs-iframe" style="width:100%; height:100%; border:none; background:white;"></iframe>
            <div id="vs-loading"
              style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; align-items:center; justify-content:center; color:#6b7280;">
              Loading...</div>
          </div>
        </div>
      </div>
    </div>

    

    
  <script src="/static/js/admin_rss_core.js"></script>
  <script src="/static/js/admin_rss_unified.js"></script>
  <script src="/static/js/admin_rss_visual.js"></script>
  <script src="/static/js/admin_rss_newsnow.js"></script>
  <script src="/static/js/admin_rss_usage.js"></script>
  <script src="/static/js/admin_rss_custom.js"></script>
  <script src="/static/js/admin_rss_requests.js"></script>
  <script src="/static/js/admin_rss_import.js"></script>
  <script src="/static/js/admin_rss_rules.js"></script>
  <script src="/static/js/admin_rss_sources.js"></script>
  </body>
</html>